---
title:  分层（layered thinking）
author:
  name: superhsc
  link: https://github.com/happymaya
date: 2019-03-15 23:33:00 +0800
categories: [Architecture Design, Design Patterns]
tags:  [设计模式, 抽象工厂模式 , Design Patterns, Abstract Factory]
math: true
mermaid: true
---

# 引言
软件程序的需求通常有两个层面：

1. 功能性需求。比如，文件上传、查询数据等；
2. 非功能性需求。比如，性能、安全性、容错鱼恢复、本地化、国际化等。

事实上，非功能性需求所构建起来的就是常说的（熟知的）软件架构。
我所理解的软件架构，简单来说，就是软件的基本结构，包含三要素：代码、代码之间的关系和两者各自的属性。

众所周知，软件架构非常的重要。如果把软件比作一个高楼，那么软件架构就是那个钢筋混凝土的框架，代码就是那个 框架里的砖石，正是因为有了框架（软件架构），才能让每一行代码都能很好的运行起来。

其中，最经典的软件架构当属分层架构，也就是将软件系统进行分层，现在几乎已经成为每个程序员最熟悉的思考模式之一。不过，分层架构越是流行，我们的设计越容易僵化。

因此，本文根据自己的理解，总结下代码为什么要分层，主要解决什么问题，以及优缺点。


# 代码分层架构是个啥 

理解代码分层架构，首先谈起的是软件部署分层架构。
下面是常见的互联网软件部署分层架构，

从图中可以看到，软件部署分层架构主要包括以下四个核心部分：

1. 客户端层，Client : 调用方，比如浏览器或 App
2. 应用服务层
   1. 业务服务，Web Server : 实现程序的运行逻辑，并从下层获取数据，返回给上层的客户端层。
   2. 缓存，Cache ：加速访问存储的数据
3. 数据层，DB : 存储数据

综上，软件分层架构是通过层来隔离不通的关注点（变化相似的点），以此来解决不同需求变化的问题，并将这些变化可以被控制在一个层里。

然而，作为软件开发者，更关心的其实是应用程序里的分层架构。比如，较为流行的一种 MVC 分层架构：

明显看到，MVC 分层架构作用于系统本身的。程序作为一个整体被发布在服务器上运行使用。而类似的 DB 里也有自己的分层架构。本文我主要关注的是应用程序中的代码分层架构，其他就暂不管了。

**什么是代码分层架构呢 ？**

代码分层架构是将软件“元素”（代码）按照“层”（代码关系）的方式组织起来的一种结构。

分层架构的核心原则是：当请求或数据从外部传递过来后，必须是从上一层传递给下一层。

如下图，一个来自 View 层的数据，必须先通过 Controller 层、Model 层，才能最终到达数据库层。


为什么不让 View 层的请求直接到达数据库呢？这是因为会造成新的代码耦合，增加代码的复杂度。

比如说，View 层直接调用 Model 层的组件，当 Model 层上的组件有变化时（比如，SQL 或逻辑的修改），即会影响 Controller 层组件的使用，也会影响 View 层组件的使用（如下面的示意图）

由此可见，分层的本质就是为了让相似变化在各自的层内变化，而不造成层与层之间的相互影响。

# 代码分层架构解决的是什么问题
代码分层架构主要是为了解决两个问题：

1. 快速拆解功能问题
2. 提升代码的可扩展性

## 通过分层来拆解问题
## 通过分层来提升代码可扩展性


# 代码分层架构的优势和劣势
代码分层架构的优势大致总结为下：

1. 只用关注整个结构中的其中某一层的具体实现；
2. 降低层与层之间的依赖；
3. 新的实现来替换原有层次的实现非常容易
4. 有利于标准化的统一
5. 各层逻辑方便复用

总的来说，代码分层架构设计主要为了实现责任分离、解耦、组件复用和标准指定

事物都有两面性，虽然代码分层有很多好处，同样，也有一些劣势：

1. 开发成本高
2. 性能降低：请求数据因为经过多层代码处理，执行时长加长，性能会有所消耗
3. 代码复杂度增加：因为层与层之间存在强耦合，所以对于一些组合功能的调用，则需要增加很多层之间的调用。

# 总结

软件分层架构是通过层来隔离不同的关注点（变化相似的地方），以此来解决不同需求变化的问题，使得这种变化可以被控制在一个层里。

代码分层架构的核心作用有两个：

- **对于功能性需求，将复杂问题分解为多个容易解决的子层问题**
- **对于非功能性需求，可以提升代码可扩展性**

代码分层架构是一种软件架构设计方法。

-  从软件的功能性需求角度看，分层是为了把较大的复杂问题拆分为多个较小的问题，在分散问题风险的同时，让问题更容易被解决，也就是我们常说的解耦。
- 从架构（非功能性需求）角度看，分层能提升代码可扩展性，帮助开发人员在相似的变化中修改代码。

复杂的设计概念和简单的代码之间存在一种平衡，这就是分层架构。

- 代码分层架构设计的思维模型是简化思维，本质是抽象与拆解。
- 代码分层架构设计的目的是将复杂问题拆分为更容易解决的小问题，降低实现难度。
- 代码分层架构设计的原则和方法是通用方法，可以应用到其他需要分层设计的地方。

所以，**分层架构从来不是目的，只是让我们的软件变得更好的其中一种思维方法而已。**

**| 参考链接**
[优秀的代码都是如何架构和分层的？ ](https://www.sohu.com/a/329851031_468650)
[DDD实战篇：分层架构的代码结构](https://zhuanlan.zhihu.com/p/30877742)
[代码分层设计](https://zhuanlan.zhihu.com/p/58762886)







