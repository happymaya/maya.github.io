---
title: 衡量的指标和注意的点(01)
author:
  name: superhsc
  link: https://github.com/happymaya
date: 2019-03-02 23:33:00 +0800
categories: [Java, Performance Optimization]
tags: [性能优化, Performance Optimization]
math: true
mermaid: true
---

所谓性能，就是使用**有限的资源**在**有限的时间**内完成工作。
在做性能优化时，能够帮助决策的衡量指标有以下五点，分别是：

1. 性能指标
- 吞吐量，QPS、TPS、HPS
- 响应速度， Time

2. 响应时间
- 平均响应时间 AVG
- 百分位数 Top Percentile

3. 并发量
3. 秒开率
3. 正确性

# 性能指标

## 吞吐量和响应速度

分布式的高并发应用不能把单次请求作为判断依据，因为它往往是一个统计结果。

最常用的衡量指标就是**吞吐量**和**响应速度**，这两者是在考虑性能时非常重要的概念，理解这两个指标的意义，可以类比为现实交通环境的十字路口。

> 在交通非常繁忙的情况下，十字路口是典型的瓶颈点，当红绿灯放行时间非常长时，后面往往会排起长队。
我们开车开始排队，到车经过红绿灯，这个过程所花费的时间，就是**响应时间**。
当然，我们可以适当地调低红绿灯的间隔时间，这样对于某些车辆来说，通过时间可能会短一些。
但是，如果信号灯频繁切换，反而会导致单位时间内通过的车辆减少，
换一个角度，我们也可以认为这个十字路口的车辆吞吐量减少了。


在日常的开发中，经常提到 QPS、TPS 以及 HPS 等这些单词，这些都是常用、并与吞吐量相关的量化指标，其中：

- QPS 代表每秒查询数量
- TPS 代表每秒事务的数量
- HPS 代表每秒的 HTTP 请求数量。

在做性能优化时候，首先要搞清楚优化的目标，到底是吞吐量还是响应速度。

有时，虽然响应速度比较慢，但整个吞吐量却非常的高，比如一些数据库的批量操作、一些缓冲区的合并等。虽然信息的延迟增加了，但如果目标就是吞吐量，那么这显然也可以算是比较大的性能提升。
一般情况下认为：

- 响应速度是**串行**只有优化，通过优化执行步骤来解决问题
- 吞吐量是**并行**执行的优化，通过合理利用计算资源达到目标

而平常的优化主要侧重于响应速度，因为一旦响应速度提升了，那么整个吞吐量自然也会跟着提升。
但对于高并发的互联网应用，响应速度和吞吐量都很重要，也都需要（因为都会标榜为高吞吐、高并发的场景）
用户对系统的延迟忍耐度是非常差的，需要在有限的硬件资源中，找到一个平衡点。

## 响应时间的衡量
响应时间（速度）的衡量方法有**平均响应时间**和**百分位数**、

[平均响应时间和百分位数](https://www.yuque.com/happymaya/imaya/gszdxn?inner=ZRhos)

在高稳定性系统中，目标是干掉严重影响系统的**长尾请求**。这部分接口性能数据的收集，需要采用更加详细的日志记录方式，而不是仅仅依靠指标。比如：将某个接口，耗时超过 1s 的入参及执行步骤，详细地输出在日志系统中。
## 并发量
系统同时能处理的请求数量，反映了系统的负载能力。

在高并发应用中，仅仅高吞吐是不够的，它还必须同时能为多个用户提供服务。

并发高时，会导致很严重的共享资源竞争的问题，因此要做的就是减少资源冲突、以及长时间占用资源的行为。

针对响应时间进行设计，一般来说是万能的。因为响应时间减少，同一时间能够处理的请求必然会增加。

不过需要注意的是，即使是一个秒杀系统，经过层层过滤处理，最终到到达某个节点的并发数，大概是五六十左右。

在平常的设计中，除非并发量特别低，否则都不需要太过度关注这个指标。

## 秒开率

秒开是一种极佳的用户体验。如果能在 1s 内加载完成，用户可以获得流畅的体验，并且不会产生更多的焦虑感。
通常而言，可以根据业务情况设定不同页面的打开标准，比如低于 1s 内数据占比是秒开率。

## 正确性

有次进行测试的时候，发现接口响应非常流畅，把并发数增加到 20 以后，应用接口响应依旧非常迅速。
但等应用真正上线时，却发生了重大事故，这是因为接口返回的都是无法使用的数据。
其问题原因也比较好定位，就是项目中使用了熔断。在压测的时候，接口直接超出服务能力，触发熔断了，但是压测并没有对接口响应的正确性做判断，造成了非常低级的错误。
所以在进行性能评估的时候，不要忘记正确性这一关键要素。

# 方法论

性能优化有很多理论方法，比如：

- [木桶理论](https://baike.baidu.com/item/%E6%9C%A8%E6%A1%B6%E6%95%88%E5%BA%94/870962?fr=aladdin)
   - 最常用
   - 系统的整体性能，就取决于系统中最慢的组件
- 基础测试（Benchmark）、预热
   - 最常用
   - 不是简单的性能测试，而是用来测试某个程序的最佳性能
   - 应用接口在刚启动都有短暂的超时，在测试之前，需要对应该进行预热，消除 JIT编译器等因素的影响
   - Java 里的一个组件 —— JMH ，可以消除这些差异
- Amdahl 定律等


# 注意点

![性能优化的注意点](/assets/post-img/optimization/2020030203.jpg)


