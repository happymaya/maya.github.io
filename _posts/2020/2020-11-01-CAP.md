---
title: CAP
author:
  name: superhsc
  link: https://github.com/happymaya
date: 2020-11-02 22:33:00 +0800
categories: [Architecture Design, Distributed]
tags: [distributed,CAP]
---
分布式系统技术是用来**解决集中式架构的性能瓶颈问题**，来**适应快速发展的业务规模**。

一般来说，分布式系统是**建立在网络之上的硬件或者软件系统**，彼此之间**通过消息等方式**进行通信和协调。

分布式系统的特点：

1. 可扩展性，通过对服务、存储扩展，来提高系统的处理能力
2. 不出现单点故障，单点故障（Single Poin Failure）指的是系统中某个组件一旦失效，会让这个系统无法工作。而不出现单点故障，单点不影响整体，是分布式系统的设计目标之一
3. 服务或存储无状态。无状态的服务才能满足部分机器宕机不影响全部，可随时进行扩展的需求。

由于分布式系统的特点，在分布式环境中更容易出现问题，比如**节点之间通信失败**、**网络分区故障**、**多个副本的数据不一致**等，为更好地在分布式系统下进行开发，学者们提出了一系列的理论，其中具有代表性的就是 **CAP 理论**。



# CAP 

CAP 理论可以表述为，一个分布式系统最多只能同时满足**一致性（Consistency）**、**可用性（Availability）**和**分区容忍性（Partition Tolerance）**这三项中的两项。

- 一致性，指的是“所有节点同时看到相同的数据”，即更新操作成功，并返回客户端完成后，所有节点在同一时间的数据完全一致，等同于所有节点拥有的数据是最新版本
- 可用性，指的是“任何时候哦，读写都是成功的”，即服务一直可用，并且是正常响应时间。平时会看到一些 IT 公司的对外宣传，比如系统稳定性已经做到 3 个 9、4 个 9，即 99.9%、99.99%，这里的 N 个 9 就是对可用性的一个描述，叫做 **SLA**，即**服务水平协议**。比如我们说月度 99.95% 的 SLA，则意味着每个月服务出现故障的时间只能占总时间的 0.05%，如果这个月是 30 天，那么就是 21.6 分钟。
- 分区容忍性：指“当部分节点出现消息丢失或者分区故障的时候，分布式系统仍能够继续运行”，即系统容忍网络出现分区， 并且在遇到某节点或网络分区之间网络不可达的情况下，仍然能够对外提供满足一致性和可用性服务。

在分布式系统中，由于系统的各层拆分，P 是确定的，CAP 的应用某型就是 CP 架构 和 AP 架构。分布式系统所关注的，就是在 Partition Tolerance 的前提下，如何实现更好的 A 和更稳定的 C。



# CAP 理论的应用

CAP 理论提醒我们，在架构设计中，不要把精力浪费在如何设计能满足三者的完美分布式系统上，而是要合理进行取舍，CAP 理论类似数学上的不可能三角，只能三选二，不能全部获得。



不同业务对于一致性的要求是不同的。比如说：

- 在微博上发表评论和点赞，用户对不一致是不敏感的，可以容忍相对较长时间的不一致，只要做好本地的交互，并不会影响用户体验；
- 在电商购物场景，产品价格数据则是要求强一致性的，如果商家更改价格不能实时生效，则会对交易成功率有非常大的影响。

需要注意的是，在 CAP 理论中是忽略网络延迟的。也就是当事务提交时，节点间的数据复制一定是需要花费时间的。即便是同一个机房，从节点 A 复制到节点 B ，由于现实中的网络不是实时的，所有总会有一定的时间不一致。



## CP 和 AP 架构的取舍

在平常的分布式系统中，为保证数据高可用，通常会将数据保留多个**副本（Replica）**，网络分区是即成的现实，于是只能在可用性和一致性两者之间做出选择。

CAP 理论关注的是在绝对情况下，在工程上，可用性和一致性并不是完全对立的，我们关注的往往是如何在保持相对一致性的前提下，提高系统的可用性。



业务上对一致性的要求会直接反应系统设计之中，典型的就是 CP 和 AP 结构。

- CP 结构：对于 CP 来说，放弃可用性，追求一致性和分区容错性。

  例如 Zookeeper，就是采用了 CP 结构，ZooKeeper 是一个分布式的服务器框架，主要用来解决分布式集群中应用系统的协调和一致性问题。

  ZooKeeper 的核心算法是 Zab，所有的设计都是为了一致性。在 CAP 模型中，Zookeeper 是 CP，这意味着面对网络分区时，为了保持一致性，它是不可用的。

- AP 结构：对于 AP 来说，放弃强一致性，追求可用性和分区容错性，这是很多分布式系统设计时的选择，Base 也是根据 AP 来扩展的。

  与 Zookeeper 相对的是 Eureka，Eureka 是 Spring Cloud 微服务技术栈中的服务发现组件，Eureka 的各个节点都是平等的，几个节点挂掉不影响正常节点的工作，剩余的节点依然可以提供注册和查询服务，只要有一台 Eureka 还在，就能保证注册服务可用，只不过查到的信息可能不是最新的版本，不保证一致性。