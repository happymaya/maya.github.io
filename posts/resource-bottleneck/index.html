<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="容易成为瓶颈的资源(03)" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="CPU、内存以及 I/O 三个资源是最容易成为瓶颈的。" /><meta property="og:description" content="CPU、内存以及 I/O 三个资源是最容易成为瓶颈的。" /><link rel="canonical" href="/posts/resource-bottleneck/" /><meta property="og:url" content="/posts/resource-bottleneck/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-03-09T13:24:11+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="容易成为瓶颈的资源(03)" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2022-05-26T21:13:46+00:00","datePublished":"2019-03-09T13:24:11+00:00","description":"CPU、内存以及 I/O 三个资源是最容易成为瓶颈的。","headline":"容易成为瓶颈的资源(03)","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/resource-bottleneck/"},"url":"/posts/resource-bottleneck/"}</script><title>容易成为瓶颈的资源(03) | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>容易成为瓶颈的资源(03)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>容易成为瓶颈的资源(03)</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1552137851" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2019-03-09 </em> </span> <span> 更新于 <em class="timeago" data-ts="1653599626" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-27 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3606 字"> <em>20 分钟</em>阅读</span></div></div></div><div class="post-content"><p>CPU、内存以及 I/O 三个资源是最容易成为瓶颈的。</p><h2 id="cpu"><span class="mr-2">CPU</span><a href="#cpu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>通过 top 命令，观测 CPU 性能；<li>通过负载，评估 CPU 任务执行的排队情况；<li>通过 vmstat，看 CPU 的繁忙程度。</ul><h3 id="top-命令--cpu-性能"><span class="mr-2">top 命令 —— CPU 性能</span><a href="#top-命令--cpu-性能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>当进入 top 命令后，按 1 键即可看到每核 CPU 的运行指标和详细性能。 CPU 的使用有多个维度的指标，分别如下：</p><ul><li><code class="language-plaintext highlighter-rouge">us</code>： 用户态所占用的 CPU 百分比，即引用程序所耗费的 CPU；<li><code class="language-plaintext highlighter-rouge">sy</code>： 内核态所占用的 CPU 百分比，需要配合 vmstat 命令，查看上下文切换是否频繁；<li><code class="language-plaintext highlighter-rouge">ni</code>： 高优先级应用所占用的 CPU 百分比；<li><code class="language-plaintext highlighter-rouge">wa</code>： 等待 I/O 设备所占用的 CPU 百分比，经常使用它来判断 I/O 问题，过高输入输出设备可能存在非常明显的瓶颈；<li><code class="language-plaintext highlighter-rouge">hi</code>： 硬中断所占用的 CPU 百分比；<li><code class="language-plaintext highlighter-rouge">si</code>： 软中断所占用的 CPU 百分比；<li><code class="language-plaintext highlighter-rouge">st</code>： 在平常的服务器上这个值很少发生变动，因为它测量的是宿主机对虚拟机的影响，即虚拟机等待宿主机 CPU 的时间占比，这在一些超卖的云服务器上，经常发生；<li><code class="language-plaintext highlighter-rouge">id</code>： 空闲 CPU 百分比。 一般地，应该比较关注空闲 CPU 的百分比，它可以从整体上体现 CPU 的利用情况。</ul><blockquote class="prompt-warning"><div><p>正常业务 cpu 应在 90% 以下；load 超过了cpu数，则负载过高（需要迁移扩容），wa 过高（10%之上），可初步判断 io 问题。sy，si，hi，st，任何一个超过5%，都有问题。</p></div></blockquote><h3 id="负载--cpu-任务排队情况"><span class="mr-2">负载 —— CPU 任务排队情况</span><a href="#负载--cpu-任务排队情况" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>如果评估 CPU 任务执行的排队情况，那么需要通过<strong>负载（load）</strong>来完成。</p><p>除了 top 命令，使用 uptime 命令也能够查看负载情况，load 的效果是一样的，分别显示了最近 1min、5min、15min 的数值。</p><p>以单核操作系统为例，将 CPU 资源抽象成一条单向行驶的马路，则会发生以下三种情况：</p><ul><li>马路上的车只有 4 辆，车辆畅通无阻，load 大约是 0.5；<li>马路上的车有 8 辆，正好能首尾相接安全通过，此时 load 大约为 1；<li>马路上的车有 12 辆，除了在马路上的 8 辆车，还有 4 辆等在马路外面，需要排队，此时 load 大约为 1.5。</ul><p>那 load 为 1 代表的是啥？针对这个问题，误解还是比较多的。</p><blockquote class="prompt-warning"><div><p>这里需要注意的是，当 load 为 1 时，对于单核的硬件上就认为系统负载已经到了极限。这没有问题，但在多核硬件上，这种描述就不完全正确，它还与 CPU 的个数有关。例如：</p><ul><li>单核的负载达到 1，总 load 的值约为 1；<li>双核的每核负载都达到 1，总 load 约为 2；<li>四核的每核负载都达到 1，总 load 约为 4。 所以，对于一个 load 到了 10，却是 16 核的机器，系统还远没有达到负载极限。</ul></div></blockquote><h3 id="vmstat--cpu-繁忙程度"><span class="mr-2">vmstat —— CPU 繁忙程度</span><a href="#vmstat--cpu-繁忙程度" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>要看 CPU 的繁忙程度，可以通过 vmstat 命令。</p><p>比较关注的有下面几列：</p><ul><li><code class="language-plaintext highlighter-rouge">b</code>: 如果系统有负载问题，就可以看一下 b 列（<strong>Uninterruptible Sleep</strong>），它的意思是等待 I/O，可能是读盘或者写盘动作比较多；<li><code class="language-plaintext highlighter-rouge">si/so</code>： 显示了交换分区的一些使用情况，交换分区对性能的影响比较大，需要格外关注；<li><code class="language-plaintext highlighter-rouge">cs</code>: 每秒钟上下文切换（<strong>Context Switch</strong>）的数量，如果上下文切换过于频繁，就需要考虑是否是进程或者线程数开的过多。</ul><p>每个进程上下文切换的具体数量，可以通过查看内存映射文件获取，如下代码所示：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="o">[</span>root@localhost ~]# <span class="nb">cat</span> /proc/2788/status
...
voluntary_ctxt_switches: 93950
nonvoluntary_ctxt_switches: 171204
</pre></table></code></div></div><h2 id="内存"><span class="mr-2">内存</span><a href="#内存" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>要想了解内存对性能的影响，则需要从操作系统层面来看一下内存的分布。如下图： ![]{http://assets.processon.com/chart_image/626edef9e401fd1b2465852f.png}</p><p>在平常写完代码后，比如写了一个 C++ 程序，去查看它的汇编，如果看到其中的内存地址，并不是实际的物理内存地址，那么应用程序所使用的，就是逻辑内存。学过计算机组成结构的同学应该都有了解。</p><p>逻辑地址可以映射到两个内存段上：<strong>物理内存</strong>和<strong>虚拟内存</strong>，那么整个系统可用的内存就是两者之和。比如你的物理内存是 4GB，分配了 8GB 的 SWAP 分区，那么应用可用的总内存就是 12GB。</p><blockquote class="prompt-warning"><div><ul><li>共享内存：可以被多个进程共享的内存。比如加载到内存的 libjvm.so，可以被多个虚拟机使用，不用每个加载一份；<li>虚拟内存（SWAP 分区）：划一块磁盘充当内存，格式就是 <code class="language-plaintext highlighter-rouge">SWAP</code>。它能当内存用但并不是内存；<li>物理内存：机器的配置，比如 4 GB；<li>机器的<strong>可用内存=物理内存+虚拟内存</strong> ；<li>逻辑内存：和程序运行有关，和内存占用无关。就是使用硬件，将二进制中的逻辑内存（一份exe的逻辑地址都是固定的），翻译成实际的可用内存。</ul></div></blockquote><h3 id="top-命令"><span class="mr-2">top 命令</span><a href="#top-命令" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>从 top 命令可以内存的几个参数，可以注意方块框起来的三个区域，解释如下：</p><ul><li><code class="language-plaintext highlighter-rouge">VIRT</code>： 这里是指虚拟内存，一般比较大，不用做过多关注；<li><code class="language-plaintext highlighter-rouge">RES</code>： 我们平常关注的是这一列的数值，它代表了进程实际占用的内存，平常在做监控时，主要监控的也是这个数值；<li><code class="language-plaintext highlighter-rouge">SHR</code>： 指的是共享内存，比如可以复用的一些 so 文件等。</ul><h3 id="cpu-缓存"><span class="mr-2">CPU 缓存</span><a href="#cpu-缓存" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>由于 CPU 和内存之间的速度差异非常大，解决方式就是<strong>加入高速缓存</strong>。实际上，这些高速缓存往往会有多层，如下图所示： <img data-src="http://assets.processon.com/chart_image/626ee075e0b34d07454666ff.png" alt="" data-proofer-ignore></p><blockquote class="prompt-warning"><div><p>高速缓存指的是 CPU 的 L1，L2，L3 甚至 Ln 层缓存。CPU 缓存离 CPU 最近，但由于材质（SRAM）比较贵，所以容量很小，比如一级缓存可能只有32KB。在 Linux 下，可以通过查看 /sys/devices/system/cpu/cpu0/cache 下面的文件，查看高速缓存的配置规格。</p></div></blockquote><p>Java 有大部分知识点是围绕多线程的，那是因为，如果一个线程的时间片跨越了多个 CPU，那么就会存在同步问题。</p><p>在 Java 中，和 CPU 缓存相关的最典型的知识点，就是在并发编程中，针对 Cache line 的伪共享（False Sharing）问题。</p><p>伪共享指的是在这些高速缓存中，以缓存行为单位进行存储，哪怕你修改了缓存行中一个很小很小的数据，它都会整个刷新。所以，当多线程修改一些变量的值时，如果这些变量都在同一个缓存行里，就会造成频繁刷新，无意中影响彼此的性能。</p><p>CPU 的每个核，基本是相同的，拿 CPU0 来说，可以通过以下的命令查看它的缓存行大小，这个值一般是 64。</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">cat</span> /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size
<span class="nb">cat</span> /sys/devices/system/cpu/cpu0/cache/index1/coherency_line_size
<span class="nb">cat</span> /sys/devices/system/cpu/cpu0/cache/index2/coherency_line_size
<span class="nb">cat</span> /sys/devices/system/cpu/cpu0/cache/index3/coherency_line_size
</pre></table></code></div></div><p>当然，通过 cpuinfo 也能得到一样的结果：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c"># cat /proc/cpuinfo | grep cache</span>
cache size	: 20480 KB
cache_alignment	: 64
cache size	: 20480 KB
cache_alignment	: 64
cache size	: 20480 KB
cache_alignment	: 64
cache size	: 20480 KB
cache_alignment	: 64
</pre></table></code></div></div><p>在 JDK 8 以上的版本，通过开启参数 <code class="language-plaintext highlighter-rouge">-XX:-RestrictContended</code>，就可以使用注解 <code class="language-plaintext highlighter-rouge">@sun.misc.Contended</code> 进行补齐，来避免伪共享的问题。</p><h3 id="hugepage"><span class="mr-2">HugePage</span><a href="#hugepage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>![]{http://assets.processon.com/chart_image/626edef9e401fd1b2465852f.png} 再回顾一下上文提到的这张图，上面有一个 TLB 组件，它的速度很快，但容量有限，在普通的 PC 机上没有什么瓶颈。但如果机器配置比较高，物理内存比较大，那就会产生非常多的映射表，CPU 的检索效率也会随之降低。</p><p>传统的页大小是 4 KB，在大内存时代这个值偏小了，解决的办法就是增加页的尺寸，比如将其增加到 2 MB，这样，就可以使用较少的映射表来管理大内存。而这种将页增大的技术，就是 <strong>Huge Page</strong>。 <img data-src="http://assets.processon.com/chart_image/626ee3041e08535fe5426e4f.png" alt="" data-proofer-ignore></p><p>同时，HugePage 也伴随着一些副作用，比如<strong>竞争加剧</strong>，但在一些大内存的机器上，开启后在一定程度上会增加性能。</p><h3 id="预先加载"><span class="mr-2">预先加载</span><a href="#预先加载" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>另外，一些程序的默认行为也会对性能有所影响，比如 JVM 的 <code class="language-plaintext highlighter-rouge">-XX:+AlwaysPreTouch</code> 参数。</p><p>默认情况下，JVM 虽然配置了 <code class="language-plaintext highlighter-rouge">Xmx</code>、<code class="language-plaintext highlighter-rouge">Xms</code> 等参数，指定堆的初始化大小和最大大小，但它的内存在真正用到时，才会分配；但如果加上 AlwaysPreTouch 这个参数，JVM 会在启动的时候，就把所有的内存预先分配。</p><p>这样，启动时虽然慢了些，但运行时的性能会增加。</p><h2 id="io"><span class="mr-2">I/O</span><a href="#io" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I/O 设备是计算机里速度最慢的组件，它指的不仅仅是硬盘，还包括外围的所有设备。</p><p>在无视不同设备的实现细节的情况下，直接看它的写入速度：</p><p><strong>缓冲区是解决速度差异的唯一工具。</strong>单在一些极端的情况下，比如断电时，就产生了太多的不确定性，这时的缓存区，都容易丢！！！</p><h3 id="isotat"><span class="mr-2">isotat</span><a href="#isotat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>最能体现 I/O 繁忙程度的，就是 <code class="language-plaintext highlighter-rouge">top 命令</code>和 <code class="language-plaintext highlighter-rouge">vmstat 命令</code>的 <code class="language-plaintext highlighter-rouge">wa%</code>.</p><p>当应用写入大量的日志，I/O wait 就可能非常高。</p><p>最便捷好用查看磁盘 I/O 的工具，就是 <code class="language-plaintext highlighter-rouge">iostat 命令</code> 。而 iostat 命令通过 sysstat 包进行安装。</p><p>主要的指标如下：</p><ul><li><code class="language-plaintext highlighter-rouge">%util</code>：需要非常关注这个数值，通常情况下，这个数字超过 80%，就证明 I/O 的负荷已经非常严重了；<li><code class="language-plaintext highlighter-rouge">Device</code>：表示是哪块硬盘，如果有多块磁盘，则会显示多行；<li><code class="language-plaintext highlighter-rouge">avgqu-sz</code>：<strong>平均请求队列的长度</strong>，这和十字路口排队的汽车也非常类似。显然，这个值越小越好；<li><code class="language-plaintext highlighter-rouge">awai</code>：<strong>响应时间</strong>包含了<strong>队列时间</strong>和<strong>服务时间</strong>。它有一个经验值，通常情况下应该是小于 5ms 的，如果这个值超过了 10ms，则证明等待的时间过长了；<li><code class="language-plaintext highlighter-rouge">svctm</code>：表示操作 I/O 的平均服务时间。在这里就是 AVG 的意思。svctm 和 await 是强相关的，如果它们比较接近，则表示 I/O 几乎没有等待，设备的性能很好；但如果 await 比 svctm 的值高出很多，则证明 I/O 的队列等待时间太长，进而系统上运行的应用程序将变慢。</ul><h3 id="零拷贝"><span class="mr-2">零拷贝</span><a href="#零拷贝" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>硬盘上的数据，在发往网络之前，需要经过多次<strong>缓冲区的拷贝</strong>，以及<strong>用户空间</strong>和<strong>内核空间</strong>的多次切换。如果能减少一些拷贝的过程，效率就能提升，所以零拷贝应运而生。</p><p>零拷贝是一种非常重要的性能优化手段，比如常见的 **Kafka、Nginx **等，就使用了这种技术。</p><p>有无零拷贝之间的区别，如下：</p><p>(1) 没有采取零拷贝手段</p><p>传统方式中要想将一个文件的内容通过 Socket 发送出去，则需要经过以下步骤：</p><ol><li>将文件内容拷贝到内核空间；<li>将内核空间内存的内容，拷贝到用户空间内存，比如 Java 应用读取 zip 文件；<li>用户空间将内容写入到内核空间的缓存中；<li>Socket 读取内核缓存中的内容，发送出去。</ol><p>(2) 采取了零拷贝手段 零拷贝有多种模式，比如 sendfile 。如下图所示，在内核的支持下，零拷贝少了一个步骤，那就是内核缓存向用户空间的拷贝，这样既节省了内存，也节省了 CPU 的调度时间，让效率更高。</p><p><img data-src="http://assets.processon.com/chart_image/62654eeb7d9c084c42df0fa3.png" alt="" data-proofer-ignore></p><p>在内核的支持下，零拷贝少了一个步骤，那就是内核缓存向用户空间的拷贝。底层实现，可以参考 sendfile 函数。典型的应用如 netty 的 zero copy，kafka 的文件传输，nginx 的大文件传输等。只要数据不需要经过二次加工发送出去，都可以使用零拷贝，非常适合下载这种场景。</p><blockquote class="prompt-warning"><div><p>kafka 对磁盘操作是顺序读写，顺序读写操作要比随机读写速度快很多，再加上使用零拷贝技术所以其吞吐量非常高，主要有 5 点：</p><ol><li>Cache/Filesystem Cache PageCache缓存<li>顺序读写 由于现代的操作系统提供了预读和写技术，磁盘的顺序写大多数情况下比随机写内存还要快。<li>Zero-copy 零拷⻉，少了一次内存交换。<li>Batching of Messages 批量量处理。合并小的请求，然后以流的方式进行交互，直顶网络上限。<li>Pull 拉模式 使用拉模式进行消息的获取消费，与消费端处理能力相符。</ol></div></blockquote><h2 id="总结"><span class="mr-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>通过使用一些性能命令观测 CPU、内存以及 I/O，可以帮助我们大体猜测性能问题发生的地方。但是它们对于性能问题，只能起到辅助作用，不能精准地定位到真正的性能瓶颈，还需要做更多深入的排查工作，收集更多信息。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/performance-optimization/'>Performance Optimization</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-tag no-text-decoration" >性能优化</a> <a href="/tags/performance-optimization/" class="post-tag no-text-decoration" >Performance Optimization</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=容易成为瓶颈的资源(03) - ThinkerWalker&amp;url=/posts/resource-bottleneck/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=容易成为瓶颈的资源(03) - ThinkerWalker&amp;u=/posts/resource-bottleneck/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/resource-bottleneck/&amp;text=容易成为瓶颈的资源(03) - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Performance-Optimization-Metrics-and-Points-to-Watch/"><div class="card-body"> <em class="timeago small" data-ts="1551540780" > 2019-03-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>衡量的指标和注意的点(01)</h3><div class="text-muted small"><p> 所谓性能，就是使用有限的资源在有限的时间内完成工作。 在做性能优化时，能够帮助决策的衡量指标有以下五点，分别是： 性能指标 吞吐量，QPS、TPS、HPS 响应速度， Time 响应时间 平均响应时间 AVG 百分位数 Top Percentile 并发量 秒开率 正确...</p></div></div></a></div><div class="card"> <a href="/posts/Entry-point-for-performance-optimization/"><div class="card-body"> <em class="timeago small" data-ts="1552059180" > 2019-03-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>性能优化类别(02)</h3><div class="text-muted small"><p> 性能优化根据优化的类别，分为业务优化和技术优化。业务优化产生的效果也是非常大的，但它属于产品和管理的范畴。同作为程序员，在平常工作中，我们面对的优化方式，主要是通过一系列的技术手段，来完成对既定的优化目标。这一系列的技术手段，大体归纳为如图以下 7 类： 1 复用优化 在写代码的时候，经常会发现有很多重复的代码可以提取出来，做成公共方法。这样，在下次用时，就不用在费劲写一遍。这种思想就...</p></div></div></a></div><div class="card"> <a href="/posts/tools-to-get-code-performance/"><div class="card-body"> <em class="timeago small" data-ts="1552231980" > 2019-03-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>获取代码性能数据的工具总结（04）</h3><div class="text-muted small"><p> 为什么 Kafka 操作磁盘，吞吐量还能那么高？这是因为，磁盘之所以慢，主要就是慢在寻道的操作上面。Kafka 官方测试表明，这个寻道时间长达 10ms。磁盘的顺序写和随机写的速度比，可以达到 6 千倍，Kafka 就是采用的顺序写的方式。 如果深入排查，需要收集较详细的性能数据，包括操作系统性能数据、JVM 的性能数据、应用的性能数据等。 在平常工作中，我经常使用以下五款性能测试性能工...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Entry-point-for-performance-optimization/" class="btn btn-outline-primary" prompt="上一篇"><p>性能优化类别(02)</p></a> <a href="/posts/tools-to-get-code-performance/" class="btn btn-outline-primary" prompt="下一篇"><p>获取代码性能数据的工具总结（04）</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
