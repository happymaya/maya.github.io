<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="利用 Repository 中的方法返回值解决实际问题" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="Repository 的返回结果有哪些" /><meta property="og:description" content="Repository 的返回结果有哪些" /><link rel="canonical" href="/posts/repository-method-return-value/" /><meta property="og:url" content="/posts/repository-method-return-value/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-06T14:33:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="利用 Repository 中的方法返回值解决实际问题" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2020-09-06T14:33:00+00:00","datePublished":"2020-09-06T14:33:00+00:00","description":"Repository 的返回结果有哪些","headline":"利用 Repository 中的方法返回值解决实际问题","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/repository-method-return-value/"},"url":"/posts/repository-method-return-value/"}</script><title>利用 Repository 中的方法返回值解决实际问题 | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>利用 Repository 中的方法返回值解决实际问题</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>利用 Repository 中的方法返回值解决实际问题</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1599402780" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-09-06 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4228 字"> <em>23 分钟</em>阅读</span></div></div></div><div class="post-content"><h2 id="repository-的返回结果有哪些"><span class="mr-2">Repository 的返回结果有哪些</span><a href="#repository-的返回结果有哪些" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Repository 接口支持的返回结果有哪些，如下图所示： <img data-src="https://images.happymaya.cn/assert/spring-data-jpa/springboot-jpa-reposotory.png" alt="Repository 接口的返回" data-proofer-ignore></p><p>打开 <code class="language-plaintext highlighter-rouge">SimpleJpaRepository</code> 直接看它的 Structure 就可以知道，它实现的方法，以及父类接口的方法和返回类型包括：<code class="language-plaintext highlighter-rouge">Optional</code>、<code class="language-plaintext highlighter-rouge">Iterable</code>、<code class="language-plaintext highlighter-rouge">List</code>、<code class="language-plaintext highlighter-rouge">Page</code>、<code class="language-plaintext highlighter-rouge">Long</code>、<code class="language-plaintext highlighter-rouge">Boolean</code>、<code class="language-plaintext highlighter-rouge">Entity</code> 对象等，而实际上支持的返回类型还要多一些。</p><p>由于 <code class="language-plaintext highlighter-rouge">Repository</code> 里面支持 <code class="language-plaintext highlighter-rouge">Iterable</code>，所以其实 <strong>java 标准的 List、Set 都可以作为返回结果</strong>，并且也会支持其子类。</p><p>Spring Data 里面定义了一个特殊的子类 <code class="language-plaintext highlighter-rouge">Steamable</code>，<code class="language-plaintext highlighter-rouge">Streamable</code> 可以替代 <code class="language-plaintext highlighter-rouge">Iterable</code> 或任何集合类型。它还提供了方便的方法来访问 Stream，可以直接在元素上进行 <code class="language-plaintext highlighter-rouge">….filter(…)</code> 和<code class="language-plaintext highlighter-rouge"> ….map(…)</code> 操作，并将 <code class="language-plaintext highlighter-rouge">Streamable</code> 连接到其他元素。</p><p>再看个关于 <code class="language-plaintext highlighter-rouge">UserRepository</code> 直接继承 <code class="language-plaintext highlighter-rouge">JpaRepository</code> 的例子。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{}</span>
</pre></table></code></div></div><p>还用之前的 UserRepository 类，在测试类里面做如下调用：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"jackxx"</span><span class="o">).</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">).</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">).</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
<span class="nc">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
<span class="nc">Streamable</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">userStreamable</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">10</span><span class="o">)).</span><span class="na">and</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"jack222"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
<span class="n">userStreamable</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></table></code></div></div><p>然后就会得到如下输出：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="n">jackxx</span><span class="o">,</span> <span class="n">email</span><span class="o">=</span><span class="mi">123456</span><span class="err">@</span><span class="mi">126</span><span class="o">.</span><span class="na">com</span><span class="o">,</span> <span class="n">sex</span><span class="o">=</span><span class="n">man</span><span class="o">,</span> <span class="n">address</span><span class="o">=</span><span class="n">shanghai</span><span class="o">)</span>
<span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">=</span><span class="kc">null</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="n">jack222</span><span class="o">,</span> <span class="n">email</span><span class="o">=</span><span class="kc">null</span><span class="o">,</span> <span class="n">sex</span><span class="o">=</span><span class="kc">null</span><span class="o">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">null</span><span class="o">)</span>
</pre></table></code></div></div><p>这个例子 <code class="language-plaintext highlighter-rouge">Streamable&lt;User&gt; userStreamable</code>，实现了 <code class="language-plaintext highlighter-rouge">Streamable</code> 的返回结果，如果想自定义方法，可以进行如下操作。</p><h2 id="自定义-streamable"><span class="mr-2">自定义 Streamable</span><a href="#自定义-streamable" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>官方提供了自定义 Streamable 的方法，不过在实际工作中很少出现要自定义保证结果类的情况，看如下例子：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="c1">// (1)</span>
    <span class="nc">MonetaryAmount</span> <span class="nf">getPrice</span><span class="o">()</span> <span class="o">{</span> <span class="err">…</span> <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@RequiredArgConstructor</span><span class="o">(</span><span class="n">staticName</span> <span class="o">=</span> <span class="s">"of"</span><span class="o">)</span>

<span class="kd">class</span> <span class="nc">Products</span> <span class="kd">implements</span> <span class="nc">Streamable</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="o">{</span>
    
    <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="nc">Streamable</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">streamable</span><span class="o">;</span>
    
    <span class="c1">// (3)</span>
    <span class="kd">public</span> <span class="nc">MonetaryAmount</span> <span class="nf">getTotal</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">streamable</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Priced:</span><span class="o">:</span><span class="n">getPrice</span><span class="o">)</span>
            <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="nc">Money</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="nl">MonetaryAmount:</span><span class="o">:</span><span class="n">add</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">ProductRepository</span> <span class="kd">implements</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// (4)</span>
    <span class="nc">Products</span> <span class="nf">findAllByDescriptionContaining</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><p>以上四个步骤介绍了自定义 Streamable 的方法，分别为：</p><ol><li>Product 实体，公开 API 以访问产品价格；<li>Streamable<Product> 的包装类型可以通过 Products.of(…) 构造（通过 Lombok 注解创建的工厂方法）；</Product><li>包装器类型在 Streamable<Product> 上公开了计算新值的其他 API；</Product><li>可以将包装器类型直接用作查询方法返回类型。无须返回 Stremable<Product> 并将其手动包装在存储库 Client 端中。</Product></ol><p>通过以上例子就可以做到自定义 <code class="language-plaintext highlighter-rouge">Streamable</code>。</p><p>其原理很简单，就是实现 <code class="language-plaintext highlighter-rouge">Streamable</code> 接口，自己定义自己的实现类即可。</p><p>也可以看下源码 <code class="language-plaintext highlighter-rouge">QueryExecutionResultHandler</code> 里面是否有 <code class="language-plaintext highlighter-rouge">Streamable</code> 子类的判断，来支持自定义 <code class="language-plaintext highlighter-rouge">Streamable</code>，关键源码如下： <img data-src="https://images.happymaya.cn/assert/spring-data-jpa/springboot-jpa-streamable.png" alt="QueryExecutionResultHandler " data-proofer-ignore></p><h2 id="返回结果类型-liststreampageslice"><span class="mr-2">返回结果类型 List/Stream/Page/Slice</span><a href="#返回结果类型-liststreampageslice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>在实际开发中，如何返回 List/Stream/Page/Slice 呢？</p><h3 id="首先新建-userrepository"><span class="mr-2">首先，新建 UserRepository：</span><a href="#首先新建-userrepository" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jpaguide</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// 自定义一个查询方法，返回Stream对象，并且有分页属性</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u from User u"</span><span class="o">)</span>
    <span class="nc">Stream</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findAllByCustomQueryAndStream</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

    <span class="c1">//测试Slice的返回结果</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u from User u"</span><span class="o">)</span>
    <span class="nc">Slice</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findAllByCustomQueryAndSlice</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

<span class="o">}</span>

</pre></table></code></div></div><p><strong>然后，修改一下测试用例类，如下，验证一下结果：</strong></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jpaguide</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.core.JsonProcessingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.assertj.core.util.Lists</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Assert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.PageRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Slice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.util.Streamable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="o">;</span>

<span class="nd">@DataJpaTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSaveUser</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">JsonProcessingException</span> <span class="o">{</span>

        <span class="c1">// 新增 7 条数据方便测试分页结果</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
            <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
            <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack2"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
            <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack3"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
            <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack4"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
            <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack5"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
            <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack6"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
            <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack7"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="c1">// 利用 ObjectMapper 将返回结果 Json to String</span>
        <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>

        <span class="c1">// 返回 Stream 类型结果（1）</span>
        <span class="nc">Stream</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">userStream</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllByCustomQueryAndStream</span><span class="o">(</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">userStream</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>

        <span class="c1">// 返回分页数据（2）</span>
        <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">userPage</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">userPage</span><span class="o">));</span>

        <span class="c1">// 返回 Slice 结果（3）</span>
        <span class="nc">Slice</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">userSlice</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllByCustomQueryAndSlice</span><span class="o">(</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">userSlice</span><span class="o">));</span>

        <span class="c1">// 返回 List 结果（4）</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">userList</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllById</span><span class="o">(</span><span class="nc">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span><span class="mi">2L</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">userList</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>

</pre></table></code></div></div><p>这个时候分别看下四种测试结果： <strong>第一种：通过 <code class="language-plaintext highlighter-rouge">Stream&lt;User&gt;</code> 取第二页的数据，得到结果如下：</strong></p><ul><li>User(id=4, name=jack4, email=123456@126.com, sex=man, address=shanghai)<li>User(id=5, name=jack5, email=123456@126.com, sex=man, address=shanghai)<li>User(id=6, name=jack6, email=123456@126.com, sex=man, address=shanghai)</ul><p>Spring Data 的支持可以通过使用 Java 8 Stream 作为返回类型来逐步处理查询方法的结果。<strong>需要注意的是：流的关闭问题</strong>，try catch 是一种常用的关闭方法，如下所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nc">Stream</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">stream</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
   <span class="n">stream</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAllByCustomQueryAndStream</span><span class="o">()</span>
   <span class="n">stream</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="err">…</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">stream</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
      <span class="n">stream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><strong>第二种：返回 <code class="language-plaintext highlighter-rouge">Page&lt;User&gt;</code> 的分页数据结果，如下所示：</strong></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jack1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"email"</span><span class="p">:</span><span class="s2">"123456@126.com"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"sex"</span><span class="p">:</span><span class="s2">"man"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"address"</span><span class="p">:</span><span class="s2">"shanghai"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jack1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"email"</span><span class="p">:</span><span class="s2">"123456@126.com"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"sex"</span><span class="p">:</span><span class="s2">"man"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"address"</span><span class="p">:</span><span class="s2">"shanghai"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jack1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"email"</span><span class="p">:</span><span class="s2">"123456@126.com"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"sex"</span><span class="p">:</span><span class="s2">"man"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"address"</span><span class="p">:</span><span class="s2">"shanghai"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">

</span><span class="err"> </span><span class="w">   </span><span class="nl">"pageable"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"sort"</span><span class="p">:{</span><span class="w">
            </span><span class="nl">"sorted"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="nl">"unsorted"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"empty"</span><span class="p">:</span><span class="kc">true</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="err">//</span><span class="w"> </span><span class="err">当前页码</span><span class="w">
        </span><span class="nl">"pageNumber"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="err">//</span><span class="w"> </span><span class="err">页码大小</span><span class="w">
        </span><span class="nl">"pageSize"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="err">//</span><span class="w"> </span><span class="err">偏移量</span><span class="w">
        </span><span class="nl">"offset"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="err">//</span><span class="w"> </span><span class="err">是否分页了</span><span class="w">
        </span><span class="nl">"paged"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"unpaged"</span><span class="p">:</span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">一共有多少页</span><span class="w">
    </span><span class="nl">"totalPages"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">是否是到最后</span><span class="w">
    </span><span class="nl">"last"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">一共多少调数</span><span class="w">
    </span><span class="nl">"totalElements"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">当前数据下标</span><span class="w">
    </span><span class="nl">"numberOfElements"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="nl">"sort"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"sorted"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"unsorted"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"empty"</span><span class="p">:</span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">当前content大小</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">当前页面码的索引</span><span class="w">
    </span><span class="nl">"number"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">是否是第一页</span><span class="w">
    </span><span class="nl">"first"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="kc">false</span><span class="err">是否有数据</span><span class="w">
    </span><span class="nl">"empty"</span><span class="p">:</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>这里可以看到 Page<User> 返回了第一个页的数据，并且告诉我们一共有三个部分的数据：</User></p><ul><li>content：数据的内容，现在指 User 的 List 3 条；<li>pageable：分页数据，包括排序字段是什么及其方向、当前是第几页、一共多少页、是否是最后一条等；<li>当前数据的描述：“size”：3，当前 content 大小；“number”：0，当前页面码的索引； “first”：true，是否是第一页；“empty”：false，是否没有数据。</ul><p>通过这三部分数据可以知道要查数的分页信息。接着看第三种测试结果。</p><p>**第三种：返回 Slice<User> 结果，如下所示：**</User></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"content"</span><span class="p">:[</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jack4"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"email"</span><span class="p">:</span><span class="s2">"123456@126.com"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"sex"</span><span class="p">:</span><span class="s2">"man"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"address"</span><span class="p">:</span><span class="s2">"shanghai"</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">},</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jack5"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"email"</span><span class="p">:</span><span class="s2">"123456@126.com"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"sex"</span><span class="p">:</span><span class="s2">"man"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"address"</span><span class="p">:</span><span class="s2">"shanghai"</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">},</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jack6"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"email"</span><span class="p">:</span><span class="s2">"123456@126.com"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"sex"</span><span class="p">:</span><span class="s2">"man"</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"address"</span><span class="p">:</span><span class="s2">"shanghai"</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">}</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">],</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"pageable"</span><span class="p">:{</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"sort"</span><span class="p">:{</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"sorted"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"unsorted"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"empty"</span><span class="p">:</span><span class="kc">true</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">},</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"pageNumber"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"pageSize"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"offset"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"paged"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"unpaged"</span><span class="p">:</span><span class="kc">false</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">},</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"numberOfElements"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"sort"</span><span class="p">:{</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"sorted"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"unsorted"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nl">"empty"</span><span class="p">:</span><span class="kc">true</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">},</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"size"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"number"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"first"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"last"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nl">"empty"</span><span class="p">:</span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>这时发现上面的 Page 返回结果少了，那么一共有多少条结果、多少页的数据呢？再比较一下第二种和第三种测试结果的执行 SQL：</p><p><strong>第二种执行的是普通的分页查询 SQL：</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>查询分页数据
Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_ limit ?

计算分页数据
Hibernate: select count(user0_.id) as col_0_0_ from user user0_
</pre></table></code></div></div><p>第三种执行的 SQL 如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nl">Hibernate:</span> <span class="n">select</span> <span class="n">user0_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_0_</span><span class="o">,</span> <span class="n">user0_</span><span class="o">.</span><span class="na">address</span> <span class="n">as</span> <span class="n">address2_0_</span><span class="o">,</span> <span class="n">user0_</span><span class="o">.</span><span class="na">email</span> <span class="n">as</span> <span class="n">email3_0_</span><span class="o">,</span> <span class="n">user0_</span><span class="o">.</span><span class="na">name</span> <span class="n">as</span> <span class="n">name4_0_</span><span class="o">,</span> <span class="n">user0_</span><span class="o">.</span><span class="na">sex</span> <span class="n">as</span> <span class="n">sex5_0_</span> <span class="n">from</span> <span class="n">user</span> <span class="n">user0_</span> <span class="n">limit</span> <span class="o">?</span> <span class="n">offset</span> <span class="o">?</span>
</pre></table></code></div></div><p>通过对比可以看出，只查询偏移量，不计算分页数据，这就是 Page 和 Slice 的主要区别。接着看第四种测试结果。</p><p>**第四种：返回 List<User> 结果如下：**</User></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jack1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="s2">"123456@126.com"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"sex"</span><span class="p">:</span><span class="s2">"man"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"address"</span><span class="p">:</span><span class="s2">"shanghai"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jack2"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="s2">"123456@126.com"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"sex"</span><span class="p">:</span><span class="s2">"man"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"address"</span><span class="p">:</span><span class="s2">"shanghai"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">

</span></pre></table></code></div></div><p>到这里，可以很简单地查询出来 ID=1 和 ID=2 的数据，没有分页信息。</p><p>上面四种方法介绍了常见的多条数据返回结果的形式，单条的我就不多介绍了，相信你一看就懂，无非就是对 JDK8 的 Optional 的支持。比如支持了 Null 的优雅判断，再一个就是支持直接返回 Entity，或者一些存在 / 不存在的 Boolean 的结果和一些 count 条数的返回结果而已。</p><h2 id="repository-对-featurecompletablefuture-异步返回结果的支持"><span class="mr-2">Repository 对 Feature/CompletableFuture 异步返回结果的支持</span><a href="#repository-对-featurecompletablefuture-异步返回结果的支持" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>可以使用 Spring 的异步方法执行Repository查询，这意味着方法将在调用时立即返回，并且实际的查询执行将发生在已提交给 Spring TaskExecutor 的任务中，比较适合定时任务的实际场景。异步使用起来比较简单，直接加@Async 注解即可，如下所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">@Async</span>
<span class="nc">Future</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByFirstname</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstname</span><span class="o">);</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span>

<span class="nd">@Async</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findOneByFirstname</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstname</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="nd">@Async</span>
<span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findOneByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">);(</span><span class="mi">3</span><span class="o">)</span>

</pre></table></code></div></div><p>上述三个异步方法的返回结果，分别做如下解释：</p><ul><li>第一处：使用 java.util.concurrent.Future 的返回类型；<li>第二处：使用 java.util.concurrent.CompletableFuture 作为返回类型；<li>第三处：使用 org.springframework.util.concurrent.ListenableFuture 作为返回类型。</ul><p>以上是对 @Async 的支持，关于实际使用需要注意以下三点内容：</p><ul><li>在实际工作中，直接在 Repository 这一层使用异步方法的场景不多，一般都是把异步注解放在 Service 的方法上面，这样的话，可以有一些额外逻辑，如发短信、发邮件、发消息等配合使用；<li>使用异步的时候一定要配置线程池，这点切记，否则“死”得会很难看；<li>万一失败会怎么处理？关于事务是怎么处理的呢？这种需要重点考虑的</ul><h2 id="对-reactive-支持-flux-与-mono"><span class="mr-2">对 Reactive 支持 flux 与 Mono</span><a href="#对-reactive-支持-flux-与-mono" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>到Spring Data Common里面对React还是有支持的，那为什么在JpaRespository里面没看到有响应的返回结果支持呢？其实Common里面提供的只是接口，而JPA里面没有做相关的Reactive 的实现，但是本身Spring Data Common里面对 Reactive 是支持的。</p><p>引用一个Spring Data Common的子模块implementation ‘org.springframework.boot:spring-boot-starter-data-mongodb’ 来加载依赖，这时候我们打开 Repository 看 Hierarchy 就可以看到，这里多了一个 Mongo 的 Repsitory 的实现，天然地支持着 Reactive 这条线。</p><h2 id="返回结果支持总结"><span class="mr-2">返回结果支持总结</span><a href="#返回结果支持总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>processResult 的时候分别对 PageQuery、Stream、Reactiv 有了各自的判断。</p><p>QueryExecutorConverters 里面对 JDK8、Guava、vavr 也做了各种支持。</p><p>下表列出了 Spring Data JPA Query Method 机制支持的方法的返回值类型：</p><h2 id="最常见的-dto-返回结果的支持方法"><span class="mr-2">最常见的 DTO 返回结果的支持方法</span><a href="#最常见的-dto-返回结果的支持方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="projections-的概念"><span class="mr-2">Projections 的概念</span><a href="#projections-的概念" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Spring JPA 对 Projections 扩展的支持，个人觉得这是个非常好的东西，从字面意思上理解就是映射，指的是和 DB 的查询结果的字段映射关系。</p><p>一般情况下，返回的字段和 DB 的查询结果的字段是一一对应的；但有的时候，需要返回一些指定的字段，或者返回一些复合型的字段，而不需要全部返回。</p><p>原来的做法是自己写各种 entity 到 view 的各种 convert 的转化逻辑，而 Spring Data 正是考虑到了这一点，允许对专用返回类型进行建模，有选择地返回同一个实体的不同视图对象。</p><p>下面以 User 查询对象为例，看看怎么自定义返回 DTO：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">sex</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>
<span class="o">}</span>

</pre></table></code></div></div><p>看上面的原始 User 实体代码，如果只想返回 User 对象里面的 name 和 email，有三种方法。</p><p><strong>第一种方法：新建一张表的不同 Entity</strong></p><p>首先，新增一个 Entity 类：通过 @Table 指向同一张表，这张表和 User 实例里面的表一样都是 user，完整内容如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"user"</span><span class="o">)</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserOnlyNameEmailEntity</span> <span class="o">{</span>
   <span class="nd">@Id</span>
   <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>然后，新增一个 UserOnlyNameEmailEntityRepository，做单独的查询：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jpaguide</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserOnlyNameEmailEntityRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">UserOnlyNameEmailEntity</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

<span class="o">}</span>
</pre></table></code></div></div><p>最后，测试用例里面的写法如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testProjections</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
        <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="mi">1L</span><span class="o">)</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack12"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">()</span>
    <span class="o">);</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">users</span><span class="o">);</span>
    <span class="nc">UserOnlyNameEmailEntity</span> <span class="n">uName</span> <span class="o">=</span> <span class="n">userOnlyNameEmailEntityRepository</span><span class="o">.</span><span class="na">getOne</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">uName</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>输出结果：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Hibernate: insert into user <span class="o">(</span>address, email, name, sex, <span class="nb">id</span><span class="o">)</span> values <span class="o">(</span>?, ?, ?, ?, ?<span class="o">)</span>
Hibernate: <span class="k">select </span>user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_
<span class="o">[</span>User<span class="o">(</span><span class="nb">id</span><span class="o">=</span>1, <span class="nv">name</span><span class="o">=</span>jack12, <span class="nv">email</span><span class="o">=</span>123456@126.com, <span class="nv">sex</span><span class="o">=</span>man, <span class="nv">address</span><span class="o">=</span>shanghai<span class="o">)]</span>
Hibernate: <span class="k">select </span>useronlyna0_.id as id1_0_0_, useronlyna0_.email as email3_0_0_, useronlyna0_.name as name4_0_0_ from user useronlyna0_ where useronlyna0_.id<span class="o">=</span>?
UserOnlyNameEmailEntity<span class="o">(</span><span class="nb">id</span><span class="o">=</span>1, <span class="nv">name</span><span class="o">=</span>jack12, <span class="nv">email</span><span class="o">=</span>123456@126.com<span class="o">)</span>
</pre></table></code></div></div><p>上述结果可以看到，当在 user 表里面插入了一条数据，而 <code class="language-plaintext highlighter-rouge">userRepository</code> 和 <code class="language-plaintext highlighter-rouge">userOnlyNameEmailEntityRepository</code> 查询的都是同一张表 user。</p><ul><li>优点：简单、方便，很容易可以想到；<li>缺点：通过两个实体都可以进行 update 操作。</ul><p>如果同一个项目里面这种实体比较多，到时候就容易不知道是谁更新的，从而导致出 bug 不好查询，实体职责划分不明确。</p><p><strong>第二种方法：直接定义一个 UserOnlyNameEmailDto</strong></p><p>首先，新建一个 DTO 类来返回我们想要的字段，它是 UserOnlyNameEmailDto，用来接收 name、email 两个字段的值，具体如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserOnlyNameEmailDto</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span><span class="n">email</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>其次，在 UserRepository 里面做如下用法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">//测试只返回name和email的DTO</span>
    <span class="nc">UserOnlyNameEmailDto</span> <span class="nf">findByEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>然后，测试用例里面写法如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testProjections</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
        <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="mi">1L</span><span class="o">)</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack12"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">()</span>
    <span class="o">);</span>
    <span class="nc">UserOnlyNameEmailDto</span> <span class="n">userOnlyNameEmailDto</span> <span class="o">=</span>  <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">);</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userOnlyNameEmailDto</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><p>最后，输出结果如下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Hibernate: <span class="k">select </span>user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where user0_.email<span class="o">=</span>?
UserOnlyNameEmailDto<span class="o">(</span><span class="nv">name</span><span class="o">=</span>jack12, <span class="nv">email</span><span class="o">=</span>123456@126.com<span class="o">)</span>
</pre></table></code></div></div><p>这里需要注意的是，如果看源码的话，关键的 PreferredConstructorDiscoverer 类时会发现，<strong>UserDTO 里面只能有一个全参数构造方法</strong>。</p><ul><li>优点：返回的结果不需要是个实体对象，对 DB 不能进行除了查询之外的任何操作；<li>缺点：有 set 方法还可以改变里面的值，构造方法不能更改，必须全参数。</ul><p><strong>第三种方法：返回结果是一个 POJO 的接口</strong></p><p>返回不同字段的方式，这种方式与上面两种的区别是只需要定义接口，它的好处是只读，不需要添加构造方法，使用起来非常灵活，一般很难产生 Bug，实现方式如下。</p><p>首先，定义一个 UserOnlyName 的接口：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jpaguide</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserOnlyName</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">getName</span><span class="o">();</span>
    <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>其次，UserRepository 写法如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jpaguide</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="cm">/**
     * 接口的方式返回DTO
     * @param address
     * @return
     */</span>
    <span class="nc">UserOnlyName</span> <span class="nf">findByAddress</span><span class="o">(</span><span class="nc">String</span> <span class="n">address</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>然后，测试用例的写法如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testProjections</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
        <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jack12"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">()</span>
    <span class="o">);</span>
    
    <span class="nc">UserOnlyName</span> <span class="n">userOnlyName</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByAddress</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userOnlyName</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><p>最后，运行结果如下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Hibernate: <span class="k">select </span>user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where user0_.address<span class="o">=</span>?

org.springframework.data.jpa.repository.query.AbstractJpaQuery<span class="nv">$TupleConverter$TupleBackedMap</span>@1d369521
</pre></table></code></div></div><p>这个时候会 userOnlyName 接口成了一个代理对象，里面通过 Map 的格式包含了我们的要返回字段的值（如：name、email），用的时候直接调用接口里面的方法即可，如 userOnlyName.getName() 即可；</p><p>这种方式的优点是<strong>接口为只读，并且语义更清晰</strong>。</p><p>其中源码是如何实现的，我来说一个类，你可以通过 debug，看一下最终 DTO 和接口转化执行的 query 有什么不同.</p><h3 id="小技巧"><span class="mr-2">小技巧</span><a href="#小技巧" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>当写 userRepositor 的定义方法的时候，IDA 会为提供满足 JPA 语法的提示，这也是用 Spring Data JPA 的好处之一，因为这些一旦约定死了（这里是指遵守 JPA 协议），周边的工具会越来越成熟，其中 MyBatis 太灵活了，就会导致周边的工具没办法跟上。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring-security/" class="post-tag no-text-decoration" >Spring Security</a> <a href="/tags/react/" class="post-tag no-text-decoration" >React</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=利用 Repository 中的方法返回值解决实际问题 - ThinkerWalker&amp;url=/posts/repository-method-return-value/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=利用 Repository 中的方法返回值解决实际问题 - ThinkerWalker&amp;u=/posts/repository-method-return-value/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/repository-method-return-value/&amp;text=利用 Repository 中的方法返回值解决实际问题 - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring-data-jpa-first/"><div class="card-body"> <em class="timeago small" data-ts="1598974380" > 2020-09-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA</h3><div class="text-muted small"><p> Spring Boot 和 Spring Data JPA 第一步：利用 IDEA 和 SpringBoot 2.3.3 快速创建一个演示项目 选择 Spring Boot 的依赖： Lombok：帮我们创建一个简单的 Entity 的 POJO，主要用来省去创建 GET 和 SET 方法； Spring Web：MVC 必备组件； Spring Data JPA：重头戏...</p></div></div></a></div><div class="card"> <a href="/posts/spring-data-jpa-test/"><div class="card-body"> <em class="timeago small" data-ts="1599060780" > 2020-09-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>利用单元测试和集成测试</h3><div class="text-muted small"><p> 如果测试用例非常完备，是可以提升团队体效率的 Spring Data JPA 单元测试 实际工作中我们免不了要和 Repository 打交道，那么这层的测试用例应该怎么写呢？怎么才能提高开发效率呢？关于 JPA 的 Repository，下面我们分成两个部分来介绍：了解基本语法；分析最佳实践。 Spring Data JPA Repository 的测试用例 测试用例写法步骤如下。 ...</p></div></div></a></div><div class="card"> <a href="/posts/query-annotation/"><div class="card-body"> <em class="timeago small" data-ts="1599147180" > 2020-09-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA - @Query</h3><div class="text-muted small"><p> 新增一个 @Query 的方法，快速体验一下 @Query 的使用方法，如下所示： package com.example.jpa.example1; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.jpa.repository.Query; impor...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring-data-common-repository/" class="btn btn-outline-primary" prompt="上一篇"><p>Spring Data Common 之 Repository</p></a> <a href="/posts/spring-data-elastic-search/" class="btn btn-outline-primary" prompt="下一篇"><p>Spring Data ElasticSearch 在 Spring Data 中的用法</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
