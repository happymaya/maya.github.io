<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="模拟 JVM 内存溢出场景" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="模拟 JVM 内存溢出之前，先思考下面几个问题：" /><meta property="og:description" content="模拟 JVM 内存溢出之前，先思考下面几个问题：" /><link rel="canonical" href="/posts/memory-overfolw/" /><meta property="og:url" content="/posts/memory-overfolw/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-10T04:13:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="模拟 JVM 内存溢出场景" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2021-08-10T04:13:00+00:00","datePublished":"2021-08-10T04:13:00+00:00","description":"模拟 JVM 内存溢出之前，先思考下面几个问题：","headline":"模拟 JVM 内存溢出场景","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/memory-overfolw/"},"url":"/posts/memory-overfolw/"}</script><title>模拟 JVM 内存溢出场景 | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>模拟 JVM 内存溢出场景</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>模拟 JVM 内存溢出场景</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1628568780" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-08-10 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4156 字"> <em>23 分钟</em>阅读</span></div></div></div><div class="post-content"><p>模拟 JVM 内存溢出之前，先思考下面几个问题：</p><ol><li>老年代溢出为什么那么可怕？<li>元空间也有溢出？怎么优化？<li>如何配置栈大小？并且避免栈溢出？<li>进程突然死掉，没有留下任何信息！如何进行排查？</ol><p>年轻代由于有老年代的担保，一般在内存占满的时候，没什么问题。但老年代满了就比较严重了，它没有其他的空间用来做担保，只能 OOM 了，也就是发生 Out Of Memery Error。JVM 会在这种情况下直接停止工作，是非常严重的后果！！！</p><p>OOM 一般是<strong>内存泄漏</strong>引起的，表现在 GC 日志里，一般情况下就是 GC 的时间变长了，而且每次回收的效果都非常一般。GC 后，堆内存的实际占用呈上升趋势。</p><p>本次，我模拟了三种溢出场景，同时使用 <a href="https://visualvm.github.io/">VisualVM 工具</a> 进行观测。</p><p>虽然 VisualVM 工具非常好用，但一般生产环境都没有这样的条件，所以大概率使用不了。新版本 JDK 把这个工具单独抽离了出去，需要自行下载。</p><p>需要注意，下载安装完成之后，需要在插件选项中勾选 Visual GC 下载，它将可视化内存布局。</p><h2 id="堆溢出模拟"><span class="mr-2">堆溢出模拟</span><a href="#堆溢出模拟" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>测试代码：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jvmpractise.oom</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpExchange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpServer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.management.ManagementFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.management.MemoryPoolMXBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OOMTest</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">_1MB</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>

	<span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">byteList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">oom</span><span class="o">(</span><span class="nc">HttpExchange</span> <span class="n">exchange</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">response</span> <span class="o">=</span> <span class="s">"oom begin!"</span><span class="o">;</span>
			<span class="n">exchange</span><span class="o">.</span><span class="na">sendResponseHeaders</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">().</span><span class="na">length</span><span class="o">);</span>
			<span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponseBody</span><span class="o">();</span>
			<span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
			<span class="n">os</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">_1MB</span><span class="o">];</span>
			<span class="n">byteList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">"MB"</span><span class="o">);</span>
			<span class="n">memPrint</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">static</span> <span class="kt">void</span> <span class="nf">memPrint</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">MemoryPoolMXBean</span> <span class="n">memoryPoolMXBean</span> <span class="o">:</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="na">getMemoryPoolMXBeans</span><span class="o">())</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">memoryPoolMXBean</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
					<span class="s">"  committed:"</span> <span class="o">+</span> <span class="n">memoryPoolMXBean</span><span class="o">.</span><span class="na">getUsage</span><span class="o">().</span><span class="na">getCommitted</span><span class="o">()</span> <span class="o">+</span>
					<span class="s">"  used:"</span> <span class="o">+</span> <span class="n">memoryPoolMXBean</span><span class="o">.</span><span class="na">getUsage</span><span class="o">().</span><span class="na">getUsed</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">srv</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="nc">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="nc">HttpServer</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8888</span><span class="o">),</span> <span class="mi">0</span><span class="o">);</span>
		<span class="nc">HttpContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">createContext</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">setHandler</span><span class="o">(</span><span class="nl">OOMTest:</span><span class="o">:</span><span class="n">oom</span><span class="o">);</span>
		<span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
		<span class="n">srv</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>这份代码开放了一个 HTTP 接口，当你触发它之后，将每秒钟生成 10 MB 的数据。由于它和 GC Roots 的强关联性，每次都不能被回收。</p><p>程序通过 <a href="https://openjdk.org/groups/jmx/">JMX</a>，将在每一秒创建数据之后，输出一些内存区域的占用情况。然后通过访问 http://localhost:8888 触发后，它将一直运行，直到堆溢出。</p><p>使用 CMS 收集器进行垃圾回收，可以看到如下的信息：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>java
    <span class="nt">-Xmx20m</span>
    <span class="nt">-Xmn4m</span>
    <span class="nt">-XX</span>:+UseConcMarkSweepGC
    <span class="nt">-verbose</span>:gc
    <span class="nt">-Xlog</span>:gc,gc+ref<span class="o">=</span>debug,gc+heap<span class="o">=</span>debug,gc+age<span class="o">=</span>trace:file<span class="o">=</span>/tmp/logs/gc_%p.log:tags,uptime,time,level
    <span class="nt">-Xlog</span>:safepoint:file<span class="o">=</span>/tmp/logs/safepoint_%p.log:tags,uptime,time,level
    <span class="nt">-XX</span>:+HeapDumpOnOutOfMemoryError
    <span class="nt">-XX</span>:HeapDumpPath<span class="o">=</span>/tmp/logs
    <span class="nt">-XX</span>:ErrorFile<span class="o">=</span>/tmp/logs/hs_error_pid%p.log
    <span class="nt">-XX</span>:-OmitStackTraceInFastThrow OOMTest
</pre></table></code></div></div><p>输出结果如下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre><td class="rouge-code"><pre>0MB
Code Cache  committed:3932160  used:3900288
Metaspace  committed:11010048  used:10336696
Compressed Class Space  committed:1310720  used:1206608
PS Eden Space  committed:65536000  used:34114968
PS Survivor Space  committed:10485760  used:0
PS Old Gen  committed:173539328  used:0
1MB
Code Cache  committed:3932160  used:3920128
Metaspace  committed:11010048  used:10341432
Compressed Class Space  committed:1310720  used:1206608
PS Eden Space  committed:65536000  used:40668616
PS Survivor Space  committed:10485760  used:0
PS Old Gen  committed:173539328  used:0
2MB
Code Cache  committed:3997696  used:3929408
Metaspace  committed:11010048  used:10347888
Compressed Class Space  committed:1310720  used:1206608
PS Eden Space  committed:65536000  used:45911512
PS Survivor Space  committed:10485760  used:0
PS Old Gen  committed:173539328  used:0
3MB
Code Cache  committed:3997696  used:3944960
Metaspace  committed:11010048  used:10351712
Compressed Class Space  committed:1310720  used:1206608
PS Eden Space  committed:65536000  used:51154408
PS Survivor Space  committed:10485760  used:0
PS Old Gen  committed:173539328  used:0
·············
538MB
Code Cache  committed:6750208  used:4756352
Metaspace  committed:12189696  used:11501024
Compressed Class Space  committed:1441792  used:1274968
PS Eden Space  committed:74448896  used:70764656
PS Survivor Space  committed:524288  used:0
PS Old Gen  committed:2767192064  used:2762065824
539MB
Code Cache  committed:6750208  used:4756352
Metaspace  committed:12189696  used:11501024
Compressed Class Space  committed:1441792  used:1274968
PS Eden Space  committed:74448896  used:74448896
PS Survivor Space  committed:524288  used:0
PS Old Gen  committed:2767192064  used:2762048248
540MB
Code Cache  committed:6750208  used:4758400
Metaspace  committed:12189696  used:11496328
Compressed Class Space  committed:1441792  used:1272248
PS Eden Space  committed:74448896  used:74315072
PS Survivor Space  committed:524288  used:0
PS Old Gen  committed:2767192064  used:2766792176
Exception <span class="k">in </span>thread <span class="s2">"Thread-2"</span> java.lang.OutOfMemoryError: Java heap space
	at cn.happymaya.jvmpractise.oom.OOMTest.oom<span class="o">(</span>OOMTest.java:29<span class="o">)</span>
	at cn.happymaya.jvmpractise.oom.OOMTest<span class="nv">$$</span>Lambda<span class="nv">$1</span>/777874839.handle<span class="o">(</span>Unknown Source<span class="o">)</span>
	at com.sun.net.httpserver.Filter<span class="nv">$Chain</span>.doFilter<span class="o">(</span>Filter.java:79<span class="o">)</span>
	at sun.net.httpserver.AuthFilter.doFilter<span class="o">(</span>AuthFilter.java:83<span class="o">)</span>
	at com.sun.net.httpserver.Filter<span class="nv">$Chain</span>.doFilter<span class="o">(</span>Filter.java:82<span class="o">)</span>
	at sun.net.httpserver.ServerImpl<span class="nv">$Exchange$LinkHandler</span>.handle<span class="o">(</span>ServerImpl.java:700<span class="o">)</span>
	at com.sun.net.httpserver.Filter<span class="nv">$Chain</span>.doFilter<span class="o">(</span>Filter.java:79<span class="o">)</span>
	at sun.net.httpserver.ServerImpl<span class="nv">$Exchange</span>.run<span class="o">(</span>ServerImpl.java:672<span class="o">)</span>
	at sun.net.httpserver.ServerImpl<span class="nv">$DefaultExecutor</span>.execute<span class="o">(</span>ServerImpl.java:158<span class="o">)</span>
	at sun.net.httpserver.ServerImpl<span class="nv">$Dispatcher</span>.handle<span class="o">(</span>ServerImpl.java:431<span class="o">)</span>
	at sun.net.httpserver.ServerImpl<span class="nv">$Dispatcher</span>.run<span class="o">(</span>ServerImpl.java:396<span class="o">)</span>
	at java.lang.Thread.run<span class="o">(</span>Thread.java:748<span class="o">)</span>
Profiler Agent: Connection with agent closed
Profiler Agent: JNI OnLoad Initializing...
Profiler Agent: JNI OnLoad Initialized successfully

Process finished with <span class="nb">exit </span>code 0

</pre></table></code></div></div><p>最后 JVM 在一阵疯狂的 GC 日志输出后，进程停止了。</p><p>在现实情况中，JVM 在停止工作之前，很多会垂死挣扎一段时间，这个时候，GC 线程会造成 CPU 飙升，但其实它已经不能工作了。</p><p>VisualVM 的截图展示了这个溢出结果。可以看到 Eden 区刚开始还是运行平稳的，内存泄漏之后就开始疯狂回收（其实是提升），老年代内存一直增长，直到 OOM。</p><p><img data-src="https://images.happymaya.cn/assert/java/jvm/jvm-10-01.png" alt="" data-proofer-ignore></p><p>很多参数会影响对象的分配行为，但不是非常必要，一般不去主动调整它们。为了观察这些参数的默认值，通常使用 <code class="language-plaintext highlighter-rouge">-XX:+PrintFlagsFinal 参数</code>，输出一些设置信息：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>java <span class="nt">-XX</span>:+PrintFlagsFinal 2 <span class="o">&gt;</span> &amp;1 | <span class="nb">grep </span>SurvivorRatio
</pre></table></code></div></div><p>输入如下信息：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">uintx</span> <span class="nc">SurvivorRatio</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">{</span><span class="n">product</span><span class="o">}</span> <span class="o">{</span><span class="k">default</span><span class="o">}</span>
</pre></table></code></div></div><p>Java13 输出了几百个参数和默认值，通过修改一些参数来观测一些不同的行为：</p><ul><li><p>NewRatio 默认值为 2，表示年轻代是老年代的 1/2。追加参数 “-XX:NewRatio=1”，可以把年轻代和老年代的空间大小调成一样大。在实践中，使用 -Xmn 来设置一个固定值。注意，这两个参数不要用在 G1 垃圾回收器中。</p><li><p>SurvivorRatio 默认值为 8。表示伊甸区和幸存区的比例。在上面的例子中，Eden 的内存大小为：0.8*4MB。S 分区不到 1MB，根本存不下 1MB 数据。</p><li><p>MaxTenuringThreshold 这个值在 CMS 下默认为 6，G1 下默认为 15。这是因为 G1 存在动态阈值计算。这个值和我们前面提到的对象提升有关，如果你想要对象尽量长的时间存在于年轻代，则在 CMS 中，可以把它调整到 15。</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>java <span class="nt">-XX</span>:+PrintFlagsFinal <span class="nt">-XX</span>:+UseConcMarkSweepGC 2&gt;&amp;1 | <span class="nb">grep </span>MaxTenuringThreshold
  
java <span class="nt">-XX</span>:+PrintFlagsFinal <span class="nt">-XX</span>:+UseG1GC 2&gt;&amp;1 | <span class="nb">grep </span>MaxTenuringThreshold
</pre></table></code></div></div><li><p>PretenureSizeThreshold 这个参数默认值是 0，意味着所有的对象年轻代优先分配。我们把这个值调小一点，再观测 JVM 的行为。追加参数 -XX:PretenureSizeThreshold=1024，可以看到 VisualVm 中老年代的区域增长。</p><li><p>TargetSurvivorRatio 默认值为 50。在动态计算对象提升阈值的时候使用。计算时，会从年龄最小的对象开始累加，如果累加的对象大小大于幸存区的一半，则将当前的对象 age 作为新的阈值，年龄大于此阈值的对象直接进入老年代。<strong>工作中不建议调整这个值，如果要调，则调成比 50 大的值。</strong></p><li><p>UseAdaptiveSizePolicy ，因为它和 CMS 不兼容，所以 CMS 下默认为 false，但 G1 下默认为 true。这是一个非常智能的参数，它是<strong>用来自适应调整空间大小的参数。它会在每次 GC 之后，重新计算 Eden、From、To 的大小</strong>。在 Java 8 的一些配置中会见到这个参数，但其实在 CMS 和 G1 中是不需要显式设置的。</p><p>值的注意的是，Java 8 默认垃圾回收器是 Parallel Scavenge，它的这个参数是默认开启的，有可能会发生把幸存区自动调小的可能，造成一些问题，显式的设置 SurvivorRatio 可以解决这个问题。</p></ul><p>使用下面的命令，切换成 G1 的效果：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>java 
    <span class="nt">-Xmx20m</span>
    <span class="nt">-XX</span>:+UseG1GC 
    <span class="nt">-verbose</span>:gc
    <span class="nt">-Xlog</span>:gc,gc+ref<span class="o">=</span>debug,gc+heap<span class="o">=</span>debug,gc+age<span class="o">=</span>trace:file<span class="o">=</span>/tmp/logs/gc_%p.log:tags,uptime,time,level 
    <span class="nt">-Xlog</span>:safepoint:file<span class="o">=</span>/tmp/logs/safepoint_%p.log:tags,uptime,time,level
    <span class="nt">-XX</span>:+HeapDumpOnOutOfMemoryError
    <span class="nt">-XX</span>:HeapDumpPath<span class="o">=</span>/tmp/logs
    <span class="nt">-XX</span>:ErrorFile<span class="o">=</span>/tmp/logs/hs_error_pid%p.log
    <span class="nt">-XX</span>:-OmitStackTraceInFastThrow OOMTest
</pre></table></code></div></div><p><img data-src="https://images.happymaya.cn/assert/java/jvm/jvm-10-02.png" alt="" data-proofer-ignore></p><p>可以通过<code class="language-plaintext highlighter-rouge">-XX:G1HeapRegionSize=&lt;N&gt;M</code>命令调整小堆区的大小。</p><h2 id="元空间溢出"><span class="mr-2">元空间溢出</span><a href="#元空间溢出" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>堆一般都是指定大小的，但元空间不是。</p><p>因此元空间发生内存溢出会更加严重，会造成操作系统的内存溢出。</p><p>在使用的时候，它设置一个上限 for safe。</p><p>元空间溢出主要是由于<strong>加载的类太多</strong>或者<strong>动态生成的类太多</strong>。下面是一段模拟代码。通过访问 http://localhost:8888 触发后，它将会发生元空间溢出。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jvmpractise.oom</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpExchange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpServer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URLClassLoader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MetaspaceOOMTest</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Facade</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">m</span><span class="o">(</span><span class="nc">String</span> <span class="n">input</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FacadeImpl</span> <span class="kd">implements</span> <span class="nc">Facade</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">m</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MetaspaceFacadeInvocationHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
		<span class="kd">private</span> <span class="nc">Object</span> <span class="n">impl</span><span class="o">;</span>
		<span class="kd">public</span> <span class="nf">MetaspaceFacadeInvocationHandler</span><span class="o">(</span><span class="nc">Object</span> <span class="n">impl</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">impl</span> <span class="o">=</span> <span class="n">impl</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">impl</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Facade</span><span class="o">&gt;</span> <span class="n">classLeakingMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Facade</span><span class="o">&gt;();</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">oom</span><span class="o">(</span><span class="nc">HttpExchange</span> <span class="n">exchange</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">response</span> <span class="o">=</span> <span class="s">"oom begin!"</span><span class="o">;</span>
			<span class="n">exchange</span><span class="o">.</span><span class="na">sendResponseHeaders</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">().</span><span class="na">length</span><span class="o">);</span>
			<span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponseBody</span><span class="o">();</span>
			<span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
			<span class="n">os</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">}</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
				<span class="nc">String</span> <span class="n">jar</span> <span class="o">=</span> <span class="s">"file:"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".jar"</span><span class="o">;</span>
				<span class="no">URL</span><span class="o">[]</span> <span class="n">urls</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">[]{</span><span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="n">jar</span><span class="o">)};</span>
				<span class="nc">URLClassLoader</span> <span class="n">newClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLClassLoader</span><span class="o">(</span><span class="n">urls</span><span class="o">);</span>
				<span class="nc">Facade</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Facade</span><span class="o">)</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">newClassLoader</span><span class="o">,</span>
						<span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]{</span><span class="nc">Facade</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
						<span class="k">new</span> <span class="nf">MetaspaceFacadeInvocationHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">FacadeImpl</span><span class="o">()));</span>
				<span class="n">classLeakingMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">jar</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">srv</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="nc">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="nc">HttpServer</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8888</span><span class="o">),</span> <span class="mi">0</span><span class="o">);</span>
		<span class="nc">HttpContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">createContext</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">setHandler</span><span class="o">(</span><span class="nl">MetaspaceOOMTest:</span><span class="o">:</span><span class="n">oom</span><span class="o">);</span>
		<span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">srv</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>上面的代码，通过 Java 代理，不断生成新的 Class。</p><p>使用命令启动这个类：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>java
    <span class="nt">-Xmx20m</span>
    <span class="nt">-Xmn4m</span>
    <span class="nt">-XX</span>:+UseG1GC
    <span class="nt">-verbose</span>:gc
    <span class="nt">-Xlog</span>:gc,gc+ref<span class="o">=</span>debug,gc+heap<span class="o">=</span>debug,gc+age<span class="o">=</span>trace:file<span class="o">=</span>/tmp/logs/gc_%p.log:tags,uptime,time,level
    <span class="nt">-Xlog</span>:safepoint:file<span class="o">=</span>/tmp/logs/safepoint_%p.log:tags,uptime,time,level
    <span class="nt">-XX</span>:+HeapDumpOnOutOfMemoryError
    <span class="nt">-XX</span>:HeapDumpPath<span class="o">=</span>/tmp/logs
    <span class="nt">-XX</span>:ErrorFile<span class="o">=</span>/tmp/logs/hs_error_pid%p.log
    <span class="nt">-XX</span>:-OmitStackTraceInFastThrow
    <span class="nt">-XX</span>:MetaspaceSize<span class="o">=</span>16M
    <span class="nt">-XX</span>:MaxMetaspaceSize<span class="o">=</span>16M  MetaspaceOOMTest
</pre></table></code></div></div><p>在启动的时候，限制 Metaspace 空间大小为 16MB。可以看到运行一小会之后，Metaspace 会发生内存溢出。</p><p><img data-src="https://images.happymaya.cn/assert/java/jvm/jvm-10-03.png" alt="" data-proofer-ignore></p><p>假如把堆 Metaspace 的限制给去掉，会更可怕。它占用的内存会一直增长。</p><h2 id="堆外内存溢出"><span class="mr-2">堆外内存溢出</span><a href="#堆外内存溢出" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>严格来说，上面的 Metaspace 也是属于堆外内存的。但是我们这里的堆外内存指的是 Java 应用程序通过直接方式从操作系统中申请的内存。所以严格来说，这里是指直接内存。</p><p>程序将通过 ByteBuffer 的 allocateDirect 方法每 1 秒钟申请 1MB 的直接内存。不要忘了通过链接触发这个过程。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jvmpractise.oom</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpExchange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.management.ManagementFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.management.MemoryPoolMXBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OffHeapOOMTest</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">_1MB</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>
	<span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ByteBuffer</span><span class="o">&gt;</span> <span class="n">byteList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">oom</span><span class="o">(</span><span class="nc">HttpExchange</span> <span class="n">exchange</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">response</span> <span class="o">=</span> <span class="s">"oom begin!"</span><span class="o">;</span>
			<span class="n">exchange</span><span class="o">.</span><span class="na">sendResponseHeaders</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">().</span><span class="na">length</span><span class="o">);</span>
			<span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponseBody</span><span class="o">();</span>
			<span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
			<span class="n">os</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">_1MB</span><span class="o">);</span>
			<span class="n">byteList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">"MB"</span><span class="o">);</span>
			<span class="n">memPrint</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">srv</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="nc">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="nc">HttpServer</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8888</span><span class="o">),</span> <span class="mi">0</span><span class="o">);</span>
		<span class="nc">HttpContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">createContext</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">setHandler</span><span class="o">(</span><span class="nl">OffHeapOOMTest:</span><span class="o">:</span><span class="n">oom</span><span class="o">);</span>
		<span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">srv</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="kd">static</span> <span class="kt">void</span> <span class="nf">memPrint</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">MemoryPoolMXBean</span> <span class="n">memoryPoolMXBean</span> <span class="o">:</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="na">getMemoryPoolMXBeans</span><span class="o">())</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">memoryPoolMXBean</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
					<span class="s">"  committed:"</span> <span class="o">+</span> <span class="n">memoryPoolMXBean</span><span class="o">.</span><span class="na">getUsage</span><span class="o">().</span><span class="na">getCommitted</span><span class="o">()</span> <span class="o">+</span>
					<span class="s">"  used:"</span> <span class="o">+</span> <span class="n">memoryPoolMXBean</span><span class="o">.</span><span class="na">getUsage</span><span class="o">().</span><span class="na">getUsed</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>但是，使用 VisualVM 看不到这个过程，使用 JMX 的 API 同样也看不到。通过 top 或者操作系统的监控工具，能够看到内存占用的明显增长。为了限制这些危险的内存申请，如果确定在自己的程序中用到了大量的 JNI 和 JNA 操作，要显式的设置 <code class="language-plaintext highlighter-rouge">MaxDirectMemorySize</code> 参数。</p><p>启动命令：<code class="language-plaintext highlighter-rouge">java -XX:MaxDirectMemorySize=10M -Xmx10M OffHeapOOMTest</code></p><p>以下是程序运行一段时间抛出的错误：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>Exception <span class="k">in </span>thread <span class="s2">"Thread-2"</span> java.lang.OutOfMemoryError: Direct buffer memory
   at java.nio.Bits.reserveMemory<span class="o">(</span>Bits.java:694<span class="o">)</span>
   at java.nio.DirectByteBuffer.&lt;init&gt;<span class="o">(</span>DirectByteBuffer.java:123<span class="o">)</span>
   at java.nio.ByteBuffer.allocateDirect<span class="o">(</span>ByteBuffer.java:311<span class="o">)</span>
   at OffHeapOOMTest.oom<span class="o">(</span>OffHeapOOMTest.java:27<span class="o">)</span>
   at com.sun.net.httpserver.Filter<span class="nv">$Chain</span>.doFilter<span class="o">(</span>Filter.java:79<span class="o">)</span>
   at sun.net.httpserver.AuthFilter.doFilter<span class="o">(</span>AuthFilter.java:83<span class="o">)</span>
   at com.sun.net.httpserver.Filter<span class="nv">$Chain</span>.doFilter<span class="o">(</span>Filter.java:82<span class="o">)</span>
   at sun.net.httpserver.ServerImpl<span class="nv">$Exchange$LinkHandler</span>.handle<span class="o">(</span>ServerImpl.java:675<span class="o">)</span>
   at com.sun.net.httpserver.Filter<span class="nv">$Chain</span>.doFilter<span class="o">(</span>Filter.java:79<span class="o">)</span>
   at sun.net.httpserver.ServerImpl<span class="nv">$Exchange</span>.run<span class="o">(</span>ServerImpl.java:647<span class="o">)</span>
   at sun.net.httpserver.ServerImpl<span class="nv">$DefaultExecutor</span>.execute<span class="o">(</span>ServerImpl.java:158<span class="o">)</span>
   at sun.net.httpserver.ServerImpl<span class="nv">$Dispatcher</span>.handle<span class="o">(</span>ServerImpl.java:431<span class="o">)</span>
   at sun.net.httpserver.ServerImpl<span class="nv">$Dispatcher</span>.run<span class="o">(</span>ServerImpl.java:396<span class="o">)</span>
   at java.lang.Thread.run<span class="o">(</span>Thread.java:748<span class="o">)</span>
</pre></table></code></div></div><h2 id="栈溢出"><span class="mr-2">栈溢出</span><a href="#栈溢出" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>栈溢出<strong>指的就是这里的数据太多造成的泄漏</strong>。通过 <code class="language-plaintext highlighter-rouge">-Xss</code> 参数可以设置它的大小。比如：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># 设置栈大小为 128K</span>
<span class="nt">-Xss128K</span>
</pre></table></code></div></div><p>由于每个线程都有一个虚拟机栈。线程的开销也是要占用内存的。如果系统中的线程数量过多，那么占用内存的大小也是非常可观的。</p><p>栈溢出不会造成 JVM 进程死亡，危害“相对较小”。下面是一个简单的模拟栈溢出的代码，只需要递归调用就可以了：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.jvmpractise.oom</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StackOverflowTest</span> <span class="o">{</span>
	<span class="kd">static</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">static</span> <span class="kt">void</span> <span class="nf">a</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
		<span class="n">count</span><span class="o">++;</span>
		<span class="n">b</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="kd">static</span> <span class="kt">void</span> <span class="nf">b</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
		<span class="n">count</span><span class="o">++;</span>
		<span class="n">a</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">a</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><p>运行后，程序直接报错：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">***</span> java.lang.instrument ASSERTION FAILED <span class="k">***</span>: <span class="s2">"!errorOutstanding"</span> with message transform method call failed at JPLISAgent.c line: 844
<span class="k">***</span> java.lang.instrument ASSERTION FAILED <span class="k">***</span>: <span class="s2">"!errorOutstanding"</span> with message transform method call failed at JPLISAgent.c line: 844
Exception <span class="k">in </span>thread <span class="s2">"main"</span> java.lang.StackOverflowError
	at java.io.PrintStream.write<span class="o">(</span>PrintStream.java:526<span class="o">)</span>
	at java.io.PrintStream.print<span class="o">(</span>PrintStream.java:597<span class="o">)</span>
	at java.io.PrintStream.println<span class="o">(</span>PrintStream.java:736<span class="o">)</span>
	at cn.happymaya.jvmpractise.oom.StackOverflowTest.a<span class="o">(</span>StackOverflowTest.java:6<span class="o">)</span>
	at cn.happymaya.jvmpractise.oom.StackOverflowTest.b<span class="o">(</span>StackOverflowTest.java:13<span class="o">)</span>
	at cn.happymaya.jvmpractise.oom.StackOverflowTest.a<span class="o">(</span>StackOverflowTest.java:8<span class="o">)</span>
</pre></table></code></div></div><p>如果应用经常发生这种情况，可以试着调大这个值。</p><p><strong>但一般都是因为程序错误引起的，最好检查一下自己的代码。</strong></p><h2 id="进程异常退出"><span class="mr-2">进程异常退出</span><a href="#进程异常退出" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>上面这几种溢出场景，都有明确的原因和报错，排查起来也是非常容易的。但是还有一类应用，死亡的时候，静悄悄的，什么都没留下。</p><p>这是趣味性和技巧性非常突出的一个问题。通过执行 <code class="language-plaintext highlighter-rouge">dmesg</code> 命令，大概率会看到进程崩溃信息躺在那里。</p><p><img data-src="https://images.happymaya.cn/assert/java/jvm/jvm-10-04.png" alt="" data-proofer-ignore></p><p>为了能看到发生的时间，我习惯性加上参数 T（dmesg -T）。</p><p>这个现象，和 Linux 的内存管理有关。由于 Linux 系统采用的是<strong>虚拟内存分配方式</strong>，JVM 的代码、库、堆和栈的使用都会消耗内存，但是申请出来的内存，只要没真正 access 过，是不算的，因为没有真正为之分配物理页面。</p><p>随着使用内存越用越多。第一层防护墙就是 SWAP；当 SWAP 也用的差不多了，会尝试释放 cache；当这两者资源都耗尽，杀手就出现了。oom-killer 会在系统内存耗尽的情况下跳出来，选择性的干掉一些进程以求释放一点内存。</p><p>所以这时的 Java 进程，是操作系统“主动”终结的，JVM 连发表遗言的机会都没有。这个信息，只能在操作系统日志里查找。</p><p>要解决这种问题，首先不能太贪婪。比如一共 8GB 的机器，你把整整 7.5GB 都分配给了 JVM。当操作系统内存不足时，你的 JVM 就可能成为 oom-killer 的猎物。</p><p>相对于被动终结，还有一种主动求死的方式。比如：<strong>直接调用 System.exit() 函数。这个函数危险得很，它将强制终止应用，而且什么都不会留下。应该扫描的代码，确保这样的逻辑不会存在。</strong></p><p>还有一种最初级最常见还经常发生的，会造成应用程序意外死亡的情况，那就是对 Java 程序错误的启动方式。</p><p>使用 XShell 登陆之后，调用<code class="language-plaintext highlighter-rouge">java com.cn.AA &amp;</code>命令进行启动。</p><p>这样调用还算有点意识，在最后使用了“&amp;”号，以期望进程在后台运行。但可惜的是，很多情况下，随着 XShell Tab 页的关闭，或者等待超时，后面的 Java 进程就随着一块停止了，很让人困惑。</p><p>正确的启动方式，就是使用 nohup 关键字：<code class="language-plaintext highlighter-rouge">nohup java com.cn.AA &amp;</code>，或者阻塞在其他更加长命的进程里（比如docker）。</p><p>进程这种静悄悄的死亡方式，会给问题排查带来更多的困难。在发生问题时，要确保留下了足够的证据，来支持接下来的分析。不能喊一句“出事啦”，然后就陷入无从下手的尴尬境地。</p><p>通常，在关闭服务的时候，会使用“kill -15”，而不是“kill -9”，以便让服务在临死之前喘口气。信号 9 和 15 的区别，是面试经常问的一个问题，也是一种非常有效的手段。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/jvm/'>JVM</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/jvm/" class="post-tag no-text-decoration" >JVM</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=模拟 JVM 内存溢出场景 - ThinkerWalker&amp;url=/posts/memory-overfolw/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=模拟 JVM 内存溢出场景 - ThinkerWalker&amp;u=/posts/memory-overfolw/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/memory-overfolw/&amp;text=模拟 JVM 内存溢出场景 - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/jvm-memory/"><div class="card-body"> <em class="timeago small" data-ts="1627914180" > 2021-08-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JVM 内存管理</h3><div class="text-muted small"><p> 随着 Java 的发展，内存布局一直在调整之中。比如，Java 8 及之后的版本，彻底移除了持久代，而使用 Metaspace 来进行替代。这也表示着 -XX:PermSize 和 -XX:MaxPermSize 等参数调优，已经没有了意义。但大体上，比较重要的内存区域是固定的。 数据私有（线程相关） 程序计数器（Program counter regist...</p></div></div></a></div><div class="card"> <a href="/posts/gc-2-1/"><div class="card-body"> <em class="timeago small" data-ts="1627914180" > 2021-08-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>垃圾回收 - 垃圾回收算法</h3><div class="text-muted small"><p> 之所以 Java 不用“手动管理”内存回收，代码写起来很顺畅。是因为 JVM 是有专门的线程在做这件事情。当内存空间达到一定条件时，会自动触发。这个过程就叫作 GC，负责 GC 的组件，就叫作垃圾回收器。 JVM 规范没有规定垃圾回收器怎么实现，它只需要保证不要把正在使用的对象给回收掉就可以。在现在的服务器环境中，经常被使用的垃圾回收器有 CMS 和 G1，但 JVM 还有其他几个常见的垃...</p></div></div></a></div><div class="card"> <a href="/posts/classloader/"><div class="card-body"> <em class="timeago small" data-ts="1628000580" > 2021-08-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>类的加载机制</h3><div class="text-muted small"><p> 类的加载机制 JVM 的类加载机制和 Java 的类加载机制类似，但 JVM 的类加载过程稍有些复杂。 JVM 通过加载 .class 文件，能够将其中的字节码解析成操作系统机器码。那这些文件是怎么加载进来的呢？又有哪些约定？ 类加载过程 并不是说，把一个文件修改成 .class 后缀，就能够被 JVM 识别。类的加载过程非常复杂，主要有这几个过程： 加载； 验证； ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/gc-5/" class="btn btn-outline-primary" prompt="上一篇"><p>解决 GC 问题的思路</p></a> <a href="/posts/memory-leakage/" class="btn btn-outline-primary" prompt="下一篇"><p>解决内存泄漏的思路</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
