<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Spring Data JPA - Defining Query Methods 的命名语法与参数" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="Spring Data JPA 的最大特色是利用方法名定义查询方法（Defining Query Methods）来做 CRUD 操作。" /><meta property="og:description" content="Spring Data JPA 的最大特色是利用方法名定义查询方法（Defining Query Methods）来做 CRUD 操作。" /><link rel="canonical" href="/posts/defining-query-methods/" /><meta property="og:url" content="/posts/defining-query-methods/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-04T15:33:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spring Data JPA - Defining Query Methods 的命名语法与参数" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2022-07-23T23:06:17+00:00","datePublished":"2020-09-04T15:33:00+00:00","description":"Spring Data JPA 的最大特色是利用方法名定义查询方法（Defining Query Methods）来做 CRUD 操作。","headline":"Spring Data JPA - Defining Query Methods 的命名语法与参数","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/defining-query-methods/"},"url":"/posts/defining-query-methods/"}</script><title>Spring Data JPA - Defining Query Methods 的命名语法与参数 | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Spring Data JPA - Defining Query Methods 的命名语法与参数</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Spring Data JPA - Defining Query Methods 的命名语法与参数</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1599233580" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-09-04 </em> </span> <span> 更新于 <em class="timeago" data-ts="1658617577" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-07-24 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4779 字"> <em>26 分钟</em>阅读</span></div></div></div><div class="post-content"><p>Spring Data JPA 的最大特色是利用<strong>方法名定义查询方法（Defining Query Methods）</strong>来做 CRUD 操作。</p><p>Spring Data JPA 的 <code class="language-plaintext highlighter-rouge">Defining Query Methods（DQM）</code>通过<strong>方法名</strong>和<strong>参数</strong>，可以很好地解决上面的问题，也能让方法名的语义更加清晰，开发效率也会提升很多。</p><p>DQM 语法共有 2 种，可以实现上面的那些问题，具体如下：</p><ul><li>一种是直接通过方法名就可以实现；<li>另一种是 <code class="language-plaintext highlighter-rouge">@Query</code> 手动在方法上定义。</ul><h2 id="定义查询方法的配置和使用方法"><span class="mr-2">定义查询方法的配置和使用方法</span><a href="#定义查询方法的配置和使用方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>若想要实现 CRUD 的操作，常规做法是写一大堆 SQL 语句。</p><p>但在 JPA 里面，只需要继承 Spring Data Common 里面的任意 Repository 接口或者子接口，然后直接通过方法名就可以实现，</p><p>第 1 步，User 实体的 UserRepository 继承 Spring Data Common 里面的 Repository 接口：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">User</span> <span class="nf">findByEmailAddress</span><span class="o">(</span><span class="nc">String</span> <span class="n">emailAddress</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>第 2 步，对于 Service 层就可以直接使用 UserRepository 接口：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span><span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJpa</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">userRepository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">();</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>这个时候就可以直接调用 CrudRepository 里面暴露的所有接口方法，以及 UserRepository 里面定义的方法，不需要写任何 SQL 语句，也不需要写任何实现方法。通过上面的两步完成了 Defining Query Methods（DQM）的基本使用。</p><p>另外一种情况：<strong>选择性暴露方法</strong>。</p><p>然而，有时如果不想暴露 CrudRepository 里面的所有方法，那么可以直接继承我们认为需要暴露的那些方法的接口。</p><p>假如 UserRepository 只想暴露 findOne 和 save，除了这两个方法之外不允许任何的 User 操作，其做法如下。</p><p>选择性地暴露 CRUD 方法，直接继承 Repository（因为这里面没有任何方法），把 CrudRepository 里面的 save 和 findOne 方法复制到自己的 MyBaseRepository 接口即可，代码如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">@NoRepositoryBean</span>
<span class="kd">interface</span> <span class="nc">MyBaseRepository</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ID</span> <span class="kd">extends</span> <span class="nc">Serializable</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ID</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">T</span> <span class="nf">findOne</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">);</span> 
    <span class="no">T</span> <span class="nf">save</span><span class="o">(</span><span class="no">T</span> <span class="n">entity</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">MyBaseRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">User</span> <span class="nf">findByEmailAddress</span><span class="o">(</span><span class="nc">String</span> <span class="n">emailAddress</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>这样在 Service 层就只有 <code class="language-plaintext highlighter-rouge">findOne</code>、<code class="language-plaintext highlighter-rouge">save</code>、<code class="language-plaintext highlighter-rouge">findByEmailAddress</code> 这 3 个方法可以调用，不会有更多方法了，可以对 SimpleJpaRepository 里面任意已经实现的方法做选择性暴露。</p><p>综上所述，得出以下 2 点结论：</p><ul><li>MyRepository Extends Repository 接口可以实现 Defining Query Methods 的功能；<li>继承其他 Repository 的子接口，或者自定义子接口，可以选择性地暴露 SimpleJpaRepository 里面已经实现的基础公用方法。</ul><p>在平时的工作中，可以通过方法名，或者定义方法名上面添加 @Query 注解两种方式来实现 CRUD 的目的。</p><p>而 Spring 提供了两种切换方式。</p><h2 id="方法的查询策略设置"><span class="mr-2">方法的查询策略设置</span><a href="#方法的查询策略设置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>目前在实际生产中还没有遇到要修改默认策略的情况，但必须要知道有这样的配置方法，做到心中有数，这样才能知道为什么方法名可以，@Query 也可以。通过 @EnableJpaRepositories 注解来配置方法的查询策略，详细配置方法如下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>@EnableJpaRepositories<span class="o">(</span><span class="nv">queryLookupStrategy</span><span class="o">=</span> QueryLookupStrategy.Key.CREATE_IF_NOT_FOUND<span class="o">)</span>
</pre></table></code></div></div><p>其中，QueryLookupStrategy.Key 的值共 3 个，具体如下：</p><ul><li><strong>Create</strong>：直接根据方法名进行创建，规则是根据方法名称的构造进行尝试，一般的方法是从方法名中删除给定的一组已知前缀，并解析该方法的其余部分。如果方法名不符合规则，启动的时候会报异常，这种情况可以理解为，即使配置了 @Query 也是没有用的；<li><strong>USE_DECLARED_QUERY</strong>：声明方式创建，启动的时候会尝试找到一个声明的查询，如果没有找到将抛出一个异常，可以理解为必须配置 @Query；<li><strong>CREATE_IF_NOT_FOUND</strong>：这个是默认的，除非有特殊需求，可以理解为这是以上 2 种方式的兼容版。先用声明方式（@Query）进行查找，如果没有找到与方法相匹配的查询，那用 Create 的方法名创建规则创建一个查询；这两者都不满足的情况下，启动就会报错。</ul><p>以 Spring Boot 项目为例，更改其配置方法如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@EnableJpaRepositories</span><span class="o">(</span><span class="n">queryLookupStrategy</span><span class="o">=</span> <span class="nc">QueryLookupStrategy</span><span class="o">.</span><span class="na">Key</span><span class="o">.</span><span class="na">CREATE_IF_NOT_FOUND</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example1Application</span> <span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Example1Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>以上就是方法的查询策略设置，很简单。</p><h2 id="defining-query-methoddqm语法"><span class="mr-2">Defining Query Method（DQM）语法</span><a href="#defining-query-methoddqm语法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>该语法是：带查询功能的方法名由<strong>查询策略（关键字）+ 查询字段 + 一些限制性条件组成</strong>，具有语义清晰、功能完整的特性，实际工作中 80% 的 API 查询都可以简单实现。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">PersonRepository</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

   <span class="c1">// and 的查询关系</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByEmailAddressAndLastname</span><span class="o">(</span><span class="nc">EmailAddress</span> <span class="n">emailAddress</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lastname</span><span class="o">);</span>

   <span class="c1">// 包含 distinct 去重，or 的 sql 语法</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findDistinctPeopleByLastnameOrFirstname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">String</span> <span class="n">firstname</span><span class="o">);</span>

   <span class="c1">// 根据 lastname 字段查询忽略大小写</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastnameIgnoreCase</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">);</span>

   <span class="c1">// 根据 lastname 和 firstname 查询 equal 并且忽略大小写</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastnameAndFirstnameAllIgnoreCase</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">String</span> <span class="n">firstname</span><span class="o">);</span> 

   <span class="c1">// 对查询结果根据 lastname 排序，正序</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastnameOrderByFirstnameAsc</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">);</span>

<span class="err"> </span>  <span class="c1">// 对查询结果根据 l</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastnameOrderByFirstnameDesc</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">);</span>

<span class="o">}</span>

</pre></table></code></div></div><p>下面表格是一个在上面 DQM 方法语法里常用的关键字列表，方便快速查阅，并满足在实际代码中更加复杂的场景： | 关键字 | 案例 | JPQL表达 | | —————– | ———————————————————— | ——————————————- | | And | findByLastnameAndFirstname | …where x.lastname = ?1 and x.firstname = ?2 | | Or | findByLastnameOrFirstname | ..where x.lastname = ?1 or x.firstname = ?2 | | Is,Equals | findByFirstname<br />findByFirstnamels<br />findByFirstnameEquals | ..where x.firstname =?1 | | Between | findByStartDateBetween | …where x.startDate between ?1 and ?2 | | LessThan | findByAgeLessThan | …where x.age &lt; ?1 | | LessThanEqual | findByAgeLessThanEqual | …where x.age &lt;= ?l | | GreaterThan | findByAgeGreaterThan | …where x.age &gt; ?1 | | GreaterThanEqual | findByAgeGreaterThanEqual | …where x.age &gt;= ?1 | | After | findByStartDateAfter | ..where x.startDate &gt; ?1 | | Before | findByStartDateBefore | …where x.startDate &lt; ?1 | | IsNull | findByAgelsNull | …where x.age is null | | IsNotNull,NotNull | findByAge(Is)NotNull | …where x.age not null | | Like | findByFirstnameLike | ..where x.firstname like ?1 | | NotLike | findByFirstnameNotLike | ..where x.firstname not like ?1 | | StartingWith | findByFirstnameStartingWith | ..where x.firstname like ?1 (参数增加前缀%) | | EndingWith | findByFirstnameEndingWith | ..where x.firstname like ?1 (参数增加后缀%) | | Containing | findByFirstnameContaining | ..where x.firstname like ?1 (参数被%包裹) | | OrderBy | findByAgeOrderByLastnameDesc | ..where x.age=?1 order by x.lastname desc | | Not | findByLastnameNot | ..where x.lastname &lt;&gt; ?1 | | In | findByAgeln(Collection ages) | …where x.age in ?l | | NotIn | findByAgeNotln(Collection ages) | …where x.age not in ?l | | True | findByActiveTrue() | …where x.active = true | | False | findByActiveFalse() | ..where x.active = false | | IgnoreCase | findByFirstnamelgnoreCase | ..where UPPER(x.firstame) = UPPER(?1) |</p><p>综上，总结 3 点经验：</p><ul><li>方法名的表达式通常是实体属性连接运算符的组合，如 <code class="language-plaintext highlighter-rouge">And</code>、<code class="language-plaintext highlighter-rouge">or</code>、<code class="language-plaintext highlighter-rouge">Between</code>、<code class="language-plaintext highlighter-rouge">LessThan</code>、<code class="language-plaintext highlighter-rouge">GreaterThan</code>、<code class="language-plaintext highlighter-rouge">Like</code> 等属性连接运算表达式，不同的数据库（NoSQL、MySQL）可能产生的效果不一样，如果遇到问题，打开 SQL 日志观察即可；<li>IgnoreCase 可以针对单个属性（如 <code class="language-plaintext highlighter-rouge">findByLastnameIgnoreCase(…)</code>），也可以针对查询条件里面所有的实体属性忽略大小写（所有属性必须在 String 情况下，如 <code class="language-plaintext highlighter-rouge">findByLastnameAndFirstnameAllIgnoreCase(…)</code>)<li>OrderBy 可以在某些属性的排序上提供方向（Asc 或 Desc），称为<strong>静态排序</strong>，也可以通过一个方便的参数 Sort 实现<strong>指定字段的动态排序的查询方法</strong>（如 <code class="language-plaintext highlighter-rouge">repository.findAll(Sort.by(Sort.Direction.ASC, "myField"))</code>）。</ul><p>上面的表格虽然大多是 find 开头的方法，除此之外，JPA 还支持 <code class="language-plaintext highlighter-rouge">read</code>、<code class="language-plaintext highlighter-rouge">get</code>、<code class="language-plaintext highlighter-rouge">query</code>、<code class="language-plaintext highlighter-rouge">stream</code>、<code class="language-plaintext highlighter-rouge">count</code>、<code class="language-plaintext highlighter-rouge">exists</code>、<code class="language-plaintext highlighter-rouge">delete</code>、<code class="language-plaintext highlighter-rouge">remove</code> 等前缀，如字面意思一样。</p><p>来看看 count、delete、remove 的例子，其他前缀可以举一反三。实例代码如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// 查询总数</span>
    <span class="kt">long</span> <span class="nf">countByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">);</span>
    
    <span class="c1">// 根据一个字段进行删除操作，并返回删除行数</span>
    <span class="kt">long</span> <span class="nf">deleteByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">);</span>

    <span class="c1">// 根据 Lastname 删除一堆 User,并返回删除的 User</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">removeByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">);</span>

<span class="o">}</span>

</pre></table></code></div></div><p>有的时候随着版本的更新，也会有更多的语法支持，或者不同的版本语法可能也不一样，通过源码来看一下上面说的几种语法。可以到类 <code class="language-plaintext highlighter-rouge">org.springframework.data.repository.query.parser.PartTree</code> 查看相关源码的逻辑和处理方法。</p><p>根据源码可以分析出来，query method 包含其他的表达式，比如 find、count、delete、exist 等关键字在 by 之前通过正则表达式匹配。</p><p>由此可知，方法中的关键字不是乱填的，是枚举定义好的。接下来打开枚举类 Type 源码看下，比什么都清楚。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="nc">Type</span> <span class="o">{</span>
    <span class="no">BETWEEN</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsBetween"</span><span class="o">,</span> <span class="s">"Between"</span><span class="o">}),</span>
    <span class="no">IS_NOT_NULL</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsNotNull"</span><span class="o">,</span> <span class="s">"NotNull"</span><span class="o">}),</span>
    <span class="no">IS_NULL</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsNull"</span><span class="o">,</span> <span class="s">"Null"</span><span class="o">}),</span>

    <span class="no">LESS_THAN</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsLessThan"</span><span class="o">,</span> <span class="s">"LessThan"</span><span class="o">}),</span>
    <span class="no">LESS_THAN_EQUAL</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsLessThanEqual"</span><span class="o">,</span> <span class="s">"LessThanEqual"</span><span class="o">}),</span>
    <span class="no">GREATER_THAN</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsGreaterThan"</span><span class="o">,</span> <span class="s">"GreaterThan"</span><span class="o">}),</span>

    <span class="no">GREATER_THAN_EQUAL</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsGreaterThanEqual"</span><span class="o">,</span> <span class="s">"GreaterThanEqual"</span><span class="o">}),</span>
    <span class="no">BEFORE</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsBefore"</span><span class="o">,</span> <span class="s">"Before"</span><span class="o">}),</span>
    <span class="no">AFTER</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsAfter"</span><span class="o">,</span> <span class="s">"After"</span><span class="o">}),</span>

    <span class="no">NOT_LIKE</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsNotLike"</span><span class="o">,</span> <span class="s">"NotLike"</span><span class="o">}),</span>
    <span class="no">LIKE</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsLike"</span><span class="o">,</span> <span class="s">"Like"</span><span class="o">}),</span>
    <span class="no">STARTING_WITH</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsStartingWith"</span><span class="o">,</span> <span class="s">"StartingWith"</span><span class="o">,</span> <span class="s">"StartsWith"</span><span class="o">}),</span>

    <span class="no">ENDING_WITH</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsEndingWith"</span><span class="o">,</span> <span class="s">"EndingWith"</span><span class="o">,</span> <span class="s">"EndsWith"</span><span class="o">}),</span>
    <span class="no">IS_NOT_EMPTY</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsNotEmpty"</span><span class="o">,</span> <span class="s">"NotEmpty"</span><span class="o">}),</span>
    <span class="no">IS_EMPTY</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsEmpty"</span><span class="o">,</span> <span class="s">"Empty"</span><span class="o">}),</span>

    <span class="no">NOT_CONTAINING</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsNotContaining"</span><span class="o">,</span> <span class="s">"NotContaining"</span><span class="o">,</span> <span class="s">"NotContains"</span><span class="o">}),</span>
    <span class="no">CONTAINING</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsContaining"</span><span class="o">,</span> <span class="s">"Containing"</span><span class="o">,</span> <span class="s">"Contains"</span><span class="o">}),</span>
    <span class="no">NOT_IN</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsNotIn"</span><span class="o">,</span> <span class="s">"NotIn"</span><span class="o">}),</span>

    <span class="no">IN</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsIn"</span><span class="o">,</span> <span class="s">"In"</span><span class="o">}),</span>
    <span class="no">NEAR</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsNear"</span><span class="o">,</span> <span class="s">"Near"</span><span class="o">}),</span>
    <span class="no">WITHIN</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsWithin"</span><span class="o">,</span> <span class="s">"Within"</span><span class="o">}),</span>

    <span class="no">REGEX</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"MatchesRegex"</span><span class="o">,</span> <span class="s">"Matches"</span><span class="o">,</span> <span class="s">"Regex"</span><span class="o">}),</span>
    <span class="no">EXISTS</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"Exists"</span><span class="o">}),</span>
    <span class="no">TRUE</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsTrue"</span><span class="o">,</span> <span class="s">"True"</span><span class="o">}),</span>
    <span class="no">FALSE</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsFalse"</span><span class="o">,</span> <span class="s">"False"</span><span class="o">}),</span>

    <span class="no">NEGATING_SIMPLE_PROPERTY</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"IsNot"</span><span class="o">,</span> <span class="s">"Not"</span><span class="o">}),</span>
    <span class="no">SIMPLE_PROPERTY</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"Is"</span><span class="o">,</span> <span class="s">"Equals"</span><span class="o">});</span>
    <span class="o">....</span>
<span class="o">}</span>

</pre></table></code></div></div><p>看源码就可以知道框架支持了哪些逻辑关键字，比如 NotIn、Like、In、Exists 等，有的时候比查文档和任何人写的博客都准确、还快。</p><h2 id="特定类型的参数sort-排序和-pageable-分页"><span class="mr-2">特定类型的参数：Sort 排序和 Pageable 分页</span><a href="#特定类型的参数sort-排序和-pageable-分页" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Spring Data JPA 为了方便我们排序和分页，支持了两个特殊类型的参数：<strong>Sort</strong> 和 <strong>Pageable</strong>。</p><p>Sort 在查询的时候可以实现动态排序，其源码：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">Sort</span><span class="o">(</span><span class="nc">Direction</span> <span class="n">direction</span><span class="o">,</span> <span class="nc">String</span><span class="o">...</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">(</span><span class="n">direction</span><span class="o">,</span> <span class="n">properties</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;()</span> <span class="o">:</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">properties</span><span class="o">));</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Sort 里面决定了哪些字段的排序方向（ASC 正序、DESC 倒序）。</p><p>Pageable 在查询的时候可以实现分页效果和动态排序双重效果。</p><p>Pageable 是一个接口，里面有常见的<strong>分页方法排序</strong>、<strong>当前页</strong>、<strong>下一行</strong>、<strong>当前指针</strong>、<strong>一共多少页</strong>、<strong>页码</strong>、**pageSize **等。</p><p>下面代码定义了根据 Lastname 查询 User 的分页和排序的实例，此段代码是在 UserRepository 接口里面定义的方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">// 根据分页参数查询User，返回一个带分页结果的Page(下一课时详解)对象（方法一）</span>
<span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

<span class="c1">// 根据分页参数返回一个Slice的user结果（方法二）</span>
<span class="nc">Slice</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

<span class="c1">// 根据排序结果返回一个List（方法三）</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>

<span class="c1">// 根据分页参数返回一个List对象（方法四）</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

</pre></table></code></div></div><ol><li>方法一：允许将 org.springframework.data.domain.Pageable 实例传递给查询方法，将分页参数添加到静态定义的查询中，通过 Page 返回的结果得知可用的元素和页面的总数。这种分页查询方法可能是昂贵的（会默认执行一条 count 的 SQL 语句），所以用的时候要考虑一下使用场景；<li>方法二：返回结果是 Slice，因为只知道是否有下一个 Slice 可用，而不知道 count，所以当查询较大的结果集时，只知道数据是足够的，也就是说用在业务场景中时不用关心一共有多少页；<li>方法三：如果只需要排序，需在 org.springframework.data.domain.Sort 参数中添加一个参数，正如上面看到的，只需返回一个 List 也是有可能的；<li>方法四：排序选项也通过 Pageable 实例处理，在这种情况下，Page 将不会创建构建实际实例所需的附加元数据（即不需要计算和查询分页相关数据），而仅仅用来做限制查询给定范围的实体。</ol><p>由此可知，可以通过 PageRequest 里面提供的几个 of 静态方法（多态），分别构建页码、页面大小、排序等。我们来看下，在使用中的写法，如下所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">// 查询user里面的 lastname=jk 的第一页，每页大小是 20 条；并会返回一共有多少页的信息</span>
<span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByLastname</span><span class="o">(</span><span class="s">"jk"</span><span class="o">,</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">));</span>

<span class="c1">// 查询user里面的 lastname=jk 的第一页的 20 条数据，不知道一共多少条</span>
<span class="nc">Slice</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span><span class="err"> </span><span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByLastname</span><span class="o">(</span><span class="s">"jk"</span><span class="o">,</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">));</span>

<span class="c1">// 查询出来所有的 user 里面的lastname=jk的User数据，并按照name正序返回List</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span><span class="err"> </span><span class="n">users</span> <span class="o">=</span><span class="err"> </span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByLastname</span><span class="o">(</span><span class="s">"jk"</span><span class="o">,</span><span class="k">new</span> <span class="nc">Sort</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">))</span>

<span class="c1">// 按照 createdAt 倒序，查询前一百条 User 数据</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span><span class="err"> </span><span class="n">users</span> <span class="o">=</span><span class="err"> </span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByLastname</span><span class="o">(</span><span class="s">"jk"</span><span class="o">,</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"createdAt"</span><span class="o">));</span>

</pre></table></code></div></div><p>上面讲解了分页和排序的应用场景，在实际工作中，如果遇到不知道参数怎么传递的情况，可以看一下源码，因为 Java 是类型安全的。</p><h2 id="限制查询结果-first-和-top"><span class="mr-2">限制查询结果 First 和 Top</span><a href="#限制查询结果-first-和-top" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>这是分页的另一种表达方式。</p><p>有的时候想直接查询前几条数据，也不需要动态排序，那么就可以简单地在方法名字中使用 First 和 Top 关键字，来限制返回条数。</p><p>userRepository 里面可以定义的一些限制返回结果的使用。在查询方法上加限制查询结果的关键字 First 和 Top。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nc">User</span> <span class="nf">findFirstByOrderByLastnameAsc</span><span class="o">();</span>
<span class="nc">User</span> <span class="nf">findTopByOrderByAgeDesc</span><span class="o">();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findDistinctUserTop3ByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findFirst10ByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findTop10ByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</pre></table></code></div></div><p>其中：</p><ul><li>查询方法在使用 First 或 Top 时，数值可以追加到 First 或 Top 后面，指定返回最大结果的大小；<li>如果数字被省略，则假设结果大小为 1；<li>限制表达式也支持 Distinct 关键字；<li>支持将结果包装到 Optional 中；<li>如果将 Pageable 作为参数，以 Top 和 First 后面的数字为准，即分页将在限制结果中应用。</ul><p>First 和 Top 关键字的使用非常简单，可以让方法名语义更加清晰。</p><h3 id="nonnullnonnullapinullable"><span class="mr-2">@NonNull、@NonNullApi、@Nullable</span><a href="#nonnullnonnullapinullable" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>从 Spring Data 2.0 开始，JPA 新增了<a href="https://docs.spring.io/spring-framework/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/NonNull.html">@NonNull</a>，<a href="https://docs.spring.io/spring-framework/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/NonNullApi.html">@NonNullApi</a>，<a href="https://docs.spring.io/spring-framework/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/Nullable.html">@Nullable</a>，是对 null 的参数和返回结果做的支持。</p><ul><li>@NonNullApi：在包级别用于声明参数，以及返回值的默认行为是不接受或产生空值的；<li>@NonNull：用于不能为空的参数或返回值（在 @NonNullApi 适用的参数和返回值上不需要）；<li>@Nullable：用于可以为空的参数或返回值。</ul><p>在自己的 Repository 所在 package 的 package-info.java 类里面做如下声明：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nd">@org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NonNullApi</span>
<span class="kn">package</span> <span class="nn">com.myrespository</span><span class="o">;</span>
</pre></table></code></div></div><p>myrespository 下面的 UserRepository 实现如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.myrespository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.lang.Nullable</span><span class="o">;</span>
<span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nc">User</span> <span class="nf">getByEmailAddress</span><span class="o">(</span><span class="nc">EmailAddress</span> <span class="n">emailAddress</span><span class="o">);</span> 
<span class="o">}</span>
</pre></table></code></div></div><p>这个时候当 emailAddress 参数为 null 的时候就会抛异常，当返回结果为 null 的时候也会抛异常。</p><p>因为在 package 的 package-info.java里面指定了 NonNullApi，所有返回结果和参数不能为 Null。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// 当添加@Nullable 注解之后，参数和返回结果这个时候就都会允许为 null 了；</span>
<span class="nd">@Nullable</span>
<span class="nc">User</span> <span class="nf">findByEmailAddress</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">EmailAddress</span> <span class="n">emailAdress</span><span class="o">);</span>

<span class="c1">// 返回结果允许为 null,参数不允许为 null 的情况</span>
<span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findOptionalByEmailAddress</span><span class="o">(</span><span class="nc">EmailAddress</span> <span class="n">emailAddress</span><span class="o">);</span> 

</pre></table></code></div></div><p>学习了 Defining Query Methods 的语法和其所表达的命名规范，在实际工作中，也可以将方法名（非常语义化的 respository 里面所定义方法命名规范）的强制约定规范运用到 controller 和 service 层，这样全部统一后，可以减少很多的沟通成本。</p><p>Spring Data Common 里面的 repository 基类，否可以应用推广到 service 层呢？能否也建立一个自己的 baseService？来看下面的实战例子：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BaseService</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ID</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getDomainClass</span><span class="o">();</span>
    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="no">S</span> <span class="nf">save</span><span class="o">(</span><span class="no">S</span> <span class="n">entity</span><span class="o">);</span>
    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">saveAll</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">entities</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="no">T</span> <span class="n">entity</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">deleteById</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">deleteAll</span><span class="o">();</span>
    <span class="kt">void</span> <span class="nf">deleteAll</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">entities</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">deleteInBatch</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">entities</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">deleteAllInBatch</span><span class="o">();</span>

    <span class="no">T</span> <span class="nf">getOne</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">);</span>

    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">findOne</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">);</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">);</span>
    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findAllById</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">ID</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">);</span>

    <span class="kt">long</span> <span class="nf">count</span><span class="o">();</span>
    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="kt">long</span> <span class="nf">count</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">);</span>

    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">exists</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">existsById</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">flush</span><span class="o">();</span>
    <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="no">S</span> <span class="nf">saveAndFlush</span><span class="o">(</span><span class="no">S</span> <span class="n">entity</span><span class="o">);</span>

<span class="o">}</span>
</pre></table></code></div></div><p>模仿 JpaRepository 接口也自定义了一个自己的BaseService，声明了常用的CRUD操作，上面的代码是生产代码，可以作为参考。</p><p>当然了也可以建立自己的 <code class="language-plaintext highlighter-rouge">PagingAndSortingService</code>、<code class="language-plaintext highlighter-rouge">ComplexityService</code>、<code class="language-plaintext highlighter-rouge">SampleService</code> 等来划分不同的 service接口，供不同目的 Service 子类继承。</p><p>再来模仿一个 SimpleJpaRepository，来实现自己的 BaseService 的实现类。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseServiceImpl</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ID</span><span class="o">,</span> <span class="no">R</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ID</span><span class="o">&gt;&gt;</span> <span class="kd">implements</span> <span class="nc">BaseService</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ID</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&gt;</span> <span class="no">DOMAIN_CLASS_CACHE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="no">R</span> <span class="n">repository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BaseServiceImpl</span><span class="o">(</span><span class="no">R</span> <span class="n">repository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">repository</span> <span class="o">=</span> <span class="n">repository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getDomainClass</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Class</span> <span class="n">thisClass</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">();</span>
        <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">domainClass</span> <span class="o">=</span> <span class="no">DOMAIN_CLASS_CACHE</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">thisClass</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">domainClass</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">domainClass</span> <span class="o">=</span> <span class="nc">GenericsUtils</span><span class="o">.</span><span class="na">getGenericClass</span><span class="o">(</span><span class="n">thisClass</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="no">DOMAIN_CLASS_CACHE</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">thisClass</span><span class="o">,</span> <span class="n">domainClass</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">domainClass</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="no">R</span> <span class="nf">getRepository</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="no">S</span> <span class="nf">save</span><span class="o">(</span><span class="no">S</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">saveAll</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">entities</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">entities</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="no">T</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteById</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteAll</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">entities</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">(</span><span class="n">entities</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteInBatch</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">entities</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">deleteInBatch</span><span class="o">(</span><span class="n">entities</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteAllInBatch</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">deleteAllInBatch</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">T</span> <span class="nf">getOne</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">getOne</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">findOne</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">example</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Sort</span> <span class="n">sort</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">sort</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">example</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">example</span><span class="o">,</span> <span class="n">sort</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">example</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">findAllById</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">ID</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAllById</span><span class="o">(</span><span class="n">ids</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">count</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">count</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="kt">long</span> <span class="nf">count</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">example</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">exists</span><span class="o">(</span><span class="nc">Example</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">example</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">example</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">existsById</span><span class="o">(</span><span class="no">ID</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">existsById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flush</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="no">S</span> <span class="nf">saveAndFlush</span><span class="o">(</span><span class="no">S</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">saveAndFlush</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>以上代码就是 BaseService 常用的 CURD 实现代码，这里面大部分也是直接调用 Repository 提供的方法。</p><p>需要注意的是，当继承 BaseServiceImpl 的时候需要传递自己的 Repository，如下面实例代码：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="kd">extends</span> <span class="nc">BaseServiceImpl</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">,</span> <span class="nc">UserRepository</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">UserServiceImpl</span><span class="o">(</span><span class="nc">UserRepository</span> <span class="n">repository</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">repository</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">.....</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>如何返回自定义 DTO 而不是 Entity !</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring-data-jpa/" class="post-tag no-text-decoration" >Spring Data JPA</a> <a href="/tags/defining-query-methods/" class="post-tag no-text-decoration" >Defining Query Methods</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spring Data JPA - Defining Query Methods 的命名语法与参数 - ThinkerWalker&amp;url=/posts/defining-query-methods/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spring Data JPA - Defining Query Methods 的命名语法与参数 - ThinkerWalker&amp;u=/posts/defining-query-methods/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/defining-query-methods/&amp;text=Spring Data JPA - Defining Query Methods 的命名语法与参数 - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring-data-jpa-first/"><div class="card-body"> <em class="timeago small" data-ts="1598974380" > 2020-09-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA</h3><div class="text-muted small"><p> Spring Boot 和 Spring Data JPA 第一步：利用 IDEA 和 SpringBoot 2.3.3 快速创建一个演示项目 选择 Spring Boot 的依赖： Lombok：帮我们创建一个简单的 Entity 的 POJO，主要用来省去创建 GET 和 SET 方法； Spring Web：MVC 必备组件； Spring Data JPA：重头戏...</p></div></div></a></div><div class="card"> <a href="/posts/spring-data-jpa-test/"><div class="card-body"> <em class="timeago small" data-ts="1599060780" > 2020-09-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>利用单元测试和集成测试</h3><div class="text-muted small"><p> 如果测试用例非常完备，是可以提升团队体效率的 Spring Data JPA 单元测试 实际工作中我们免不了要和 Repository 打交道，那么这层的测试用例应该怎么写呢？怎么才能提高开发效率呢？关于 JPA 的 Repository，下面我们分成两个部分来介绍：了解基本语法；分析最佳实践。 Spring Data JPA Repository 的测试用例 测试用例写法步骤如下。 ...</p></div></div></a></div><div class="card"> <a href="/posts/query-annotation/"><div class="card-body"> <em class="timeago small" data-ts="1599147180" > 2020-09-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA - @Query</h3><div class="text-muted small"><p> 新增一个 @Query 的方法，快速体验一下 @Query 的使用方法，如下所示： package com.example.jpa.example1; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.jpa.repository.Query; impor...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/query-annotation/" class="btn btn-outline-primary" prompt="上一篇"><p>Spring Data JPA - @Query</p></a> <a href="/posts/spring-data-common-repository/" class="btn btn-outline-primary" prompt="下一篇"><p>Spring Data Common 之 Repository</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
