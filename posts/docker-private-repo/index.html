<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Docker 仓库（05）" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="仓库是什么？" /><meta property="og:description" content="仓库是什么？" /><link rel="canonical" href="/posts/docker-private-repo/" /><meta property="og:url" content="/posts/docker-private-repo/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-06T11:33:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Docker 仓库（05）" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2022-05-26T21:13:46+00:00","datePublished":"2020-08-06T11:33:00+00:00","description":"仓库是什么？","headline":"Docker 仓库（05）","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/docker-private-repo/"},"url":"/posts/docker-private-repo/"}</script><title>Docker 仓库（05） | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Docker 仓库（05）</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 500'%3E%3C/svg%3E" data-src="https://images.happymaya.cn/assert/docker/docker.jpeg" class="preview-img bg" alt="Preview Image" width="800" height="500" data-proofer-ignore><h1 data-toc-skip>Docker 仓库（05）</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1596713580" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-08-06 </em> </span> <span> 更新于 <em class="timeago" data-ts="1653599626" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-27 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2235 字"> <em>12 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="仓库是什么">仓库是什么？</h1><p>仓库（Repository）是存储和分发 Docker 镜像的地方。</p><p>镜像仓库类似于代码仓库，Docker Hub 的命名来自 GitHub，Github 是常用的代码存储和分发的地方。</p><p>同样 Docker Hub 是用来提供 Docker 镜像存储和分发的地方。</p><p>注册服务器（Registry）和仓库（Repository）的区别：</p><ol><li>注册服务器是存放仓库的实际服务器，仓库则可以理解为一个具体的项目或者目录<li>注册服务器可以包含很多个仓库，每个仓库又可以包含多个镜像</ol><p>例如：docker.io/centos，docker.io 是注册服务器，centos 是仓库名</p><p>仓库类型，镜像仓库分为<strong>公共镜像仓库</strong>和<strong>私有镜像仓库。</strong></p><h1 id="公共镜像仓库">公共镜像仓库</h1><p>公共镜像仓库一般是 Docker 官方或者其他第三方组织（阿里云，腾讯云，网易云等）提供的，允许所有人注册和使用的镜像仓库。</p><p>Docker Hub 是全球最大的镜像市场，目前已经有超过 10w 个容器镜像，这些容器镜像主要来自软件供应商、开源组织和社区。大部分的操作系统镜像和软件镜像都可以直接在 Docker Hub 下载并使用。</p><p>以 Docker Hub ，总结公共镜像仓库分发和存储镜像。</p><ol><li>首先访问 <a href="https://hub.docker.com/">Docker Hub官网</a>，点击注册按钮进入注册账号界面；<li>注册完成后，点击创建仓库，新建一个仓库用于推送镜像；</ol><p>创建好仓库后，就可以推送本地镜像到新创建的仓库中。</p><p>下面通过一个实例，演示如何推送镜像到自己的仓库中。</p><p>第一步，使用以下命令拉去 happymaya 镜像</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker pull happymaya

Using default tag: latest
latest: Pulling from library/happymaya
Digest: sha256:4f47c01fa91355af2865ac10fef5bf6ec9c7f42ad2321377c21e844427972977
Status: Image is up to <span class="nb">date </span><span class="k">for </span>busybox:latest
docker.io/library/happymaya:latest
</pre></table></code></div></div><p>第二步，使用 docker login 命令登录镜像服务器（只有已经登录的用户才可以推送镜像到仓库）</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker login

Login with your Docker ID to push and pull images from Docker Hub. 
If you don<span class="s1">'t have a Docker ID, head over to https://hub.docker.com to create one.
Username: superhsc
Password:
Login Succeeded
</span></pre></table></code></div></div><blockquote class="prompt-warning"><div><p><code class="language-plaintext highlighter-rouge">docker login</code>命令默认会请求 Docker Hub，如果想登录第三方镜像仓库或者自建的镜像仓库，在<code class="language-plaintext highlighter-rouge">docker login</code>后面加上注册服务器即可。 例如：登录访问阿里云镜像服务器，则使用<code class="language-plaintext highlighter-rouge">docker login registry.cn-beijing.aliyuncs.com</code>，输入阿里云镜像服务的用户名密码即可。</p></div></blockquote><p>第三步，先把镜像“重命名”，才能正确推送到自己创建的镜像仓库中，使用 <code class="language-plaintext highlighter-rouge">docker tag</code>命令将镜像“重命名” 第四步，镜像“重命名”后使用<code class="language-plaintext highlighter-rouge">docker push</code>命令就可以推送镜像到自己创建的仓库中</p><p>此时，happymaya 这个镜像就被推送到自定义的镜像仓库了。还可以新建其他的镜像仓库，然后将自己构建的镜像推送到仓库中。</p><h1 id="搭建私有仓库">搭建私有仓库</h1><h2 id="启动本地仓库"><span class="mr-2">启动本地仓库</span><a href="#启动本地仓库" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>有时候，出于安全或保密的需求，需要搭建一个自己的镜像仓库</p><p>Docker 官方提供了开源的镜像仓库 <a href="https://github.com/docker/distribution">Distribution</a>，并且镜像存放在 Docker Hub 的 <a href="https://hub.docker.com/_/registry">Registry</a> 仓库下供我们下载。</p><p>可以使用如下命令启动一个本地镜像仓库：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 5000:5000 <span class="nt">--name</span> registry registry:2.7

Unable to find image <span class="s1">'registry:2.7'</span> locally
2.7: Pulling from library/registry
cbdbe7a5bc2a: Pull <span class="nb">complete
</span>47112e65547d: Pull <span class="nb">complete
</span>46bcb632e506: Pull <span class="nb">complete
</span>c1cc712bcecd: Pull <span class="nb">complete
</span>3db6272dcbfa: Pull <span class="nb">complete
</span>Digest: sha256:8be26f81ffea54106bae012c6f349df70f4d5e7e2ec01b143c46e2c03b9e551d
Status: Downloaded newer image <span class="k">for </span>registry:2.7
d7e449a8a93e71c9a7d99c67470bd7e7a723eee5ae97b3f7a2a8a1cf25982cc3

</pre></table></code></div></div><p>然后使用 <code class="language-plaintext highlighter-rouge">docker ps</code> 命令查看下刚才启动的容器：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker ps

CONTAINER ID  IMAGE         COMMAND                 CREATED          STATUS         PORTS                    NAMES
d7e449a8a93e  registry:2.7  <span class="s2">"/entrypoint.sh /etc…"</span>  50 seconds ago   Up 49 seconds  0.0.0.0:5000-&gt;5000/tcp   registry
</pre></table></code></div></div><p>此时就拥有了一个私有镜像仓库，访问地址为 <code class="language-plaintext highlighter-rouge">http://localhost:5000</code> .</p><h2 id="推送镜像到本地仓库"><span class="mr-2">推送镜像到本地仓库</span><a href="#推送镜像到本地仓库" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>第一步，使用<code class="language-plaintext highlighter-rouge">docker tag</code>命令把 <code class="language-plaintext highlighter-rouge">happymaya</code> 镜像”重命名”为<code class="language-plaintext highlighter-rouge">localhost:5000/happymaya</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker tag busybox localhost:5000/happymaya
</pre></table></code></div></div><p>此时 <code class="language-plaintext highlighter-rouge">Docker</code> 为 <code class="language-plaintext highlighter-rouge">busybox</code> 镜像创建了一个别名 <code class="language-plaintext highlighter-rouge">localhost:5000/happymaya</code>，<code class="language-plaintext highlighter-rouge">localhost:5000</code> 为主机名和端口，<code class="language-plaintext highlighter-rouge">Docker</code> 将会把镜像推送到这个地址。</p><p>第二步，使用 <code class="language-plaintext highlighter-rouge">docker push</code> 推送镜像到本地仓库</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker push localhost:5000/happymaya

The push refers to repository <span class="o">[</span>localhost:5000/happymaya]
514c3a3e64d4: Layer already exists
latest: digest: sha256:400ee2ed939df769d4681023810d2e4fb9479b8401d97003c710d0e20f7c49c6 size: 527
</pre></table></code></div></div><p>第三步，验证从本地镜像仓库拉取镜像</p><p>（1）删除本地的<code class="language-plaintext highlighter-rouge">happymaya</code>和<code class="language-plaintext highlighter-rouge">localhost:5000/happymaya</code>镜像</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker rmi happymaya localhost:5000/happymaya

Untagged: happymaya:latest
Untagged: busybox@sha256:4f47c01fa91355af2865ac10fef5bf6ec9c7f42ad2321377c21e844427972977
Untagged: localhost:5000/happymaya:latest
Untagged: localhost:5000/happymaya@sha256:400ee2ed939df769d4681023810d2e4fb9479b8401d97003c710d0e20f7c49c6
</pre></table></code></div></div><p>（2）查看本地 <code class="language-plaintext highlighter-rouge">happymaya</code> 镜像</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker image <span class="nb">ls </span>happymaya
REPOSITORY   TAG   IMAGE ID  CREATED   SIZE
</pre></table></code></div></div><p>可以看到此时本地已经没有 <code class="language-plaintext highlighter-rouge">happymaya</code> 这个镜像了。</p><p>（3）从本地镜像仓库拉取 <code class="language-plaintext highlighter-rouge">happymaya</code> 镜像：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker pull localhost:5000/happymaya 

Using default tag: latest
latest: Pulling from happymaya 
Digest: sha256:400ee2ed939df769d4681023810d2e4fb9479b8401d97003c710d0e20f7c49c6
Status: Downloaded newer image <span class="k">for </span>localhost:5000/happymaya :latest
localhost:5000/happymaya :latest

</pre></table></code></div></div><p>（4） 最后再使用 <code class="language-plaintext highlighter-rouge">docker image ls happymaya</code>命令，这时可以看到已经成功从私有镜像仓库拉取<code class="language-plaintext highlighter-rouge">happymaya</code>镜像到本地了</p><h2 id="持久化镜像存储"><span class="mr-2">持久化镜像存储</span><a href="#持久化镜像存储" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>容器是无状态的。上面私有仓库的启动方式可能会导致镜像丢失，因为没有把仓库的数据信息持久化到主机磁盘上，这在生产环境中是无法接受的。</p><p>可以使用以下命令将镜像持久化到主机目录：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker run <span class="nt">-v</span> /var/lib/registry/data:/var/lib/registry <span class="nt">-d</span> <span class="nt">-p</span> 5000:5000 <span class="nt">--name</span> registry registry:2.7
</pre></table></code></div></div><p>上面启动<code class="language-plaintext highlighter-rouge">registry</code>的命令中加入了<code class="language-plaintext highlighter-rouge">-v /var/lib/registry/data:/var/lib/registry</code></p><ul><li>-v 的含义是把 Docker 容器的某个目录或文件挂载到主机上，保证容器被重建后数据不丢失<li>-v 参数冒号前面为主机目录，冒号后面为容器内目录。</ul><blockquote><p>事实上，registry 的持久化存储除了支持本地文件系统还支持很多种类型，例如：</p><ul><li>S3<li>Google Cloud Platform<li>Microsoft Azure Blob Storage Service 等多种存储类型。。</ul></blockquote><p>此时，虽然可以本地访问和拉取，但是如果想在另外一台机器上，是无法通过 Docker 访问到这个镜像仓库的。</p><p>因为 Docker 要求非 localhost 访问的镜像仓库必须使用 HTTPS，此时就需要构建外部可访问的镜像仓库（或者配置 insecure-registry）。</p><h2 id="构建外部可访问的镜像仓库"><span class="mr-2">构建外部可访问的镜像仓库</span><a href="#构建外部可访问的镜像仓库" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>要构建一个支持 HTTPS 访问的安全镜像仓库，需要满足以下两个条件：</p><ul><li>拥有一个合法的域名，并且可以正确解析到镜像服务器；<li>从证书颁发机构（CA）获取一个证书。</ul><p>在准备好域名和证书后，就可以部署的镜像服务器了。</p><p>这里以<code class="language-plaintext highlighter-rouge">regisry.happymaya.io</code>这个域名为例，步骤如下：</p><p>（1）准备存放证书的目录 <code class="language-plaintext highlighter-rouge">/var/lib/registry/certs</code></p><p>（2）把申请到的证书私钥和公钥分别放到该目录下， 假设申请到的证书文件分别为<code class="language-plaintext highlighter-rouge">regisry.happymaya.io.crt</code>和<code class="language-plaintext highlighter-rouge">regisry.happymaya.io.key</code></p><p>（3）停止并删除已启动的仓库容器</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker stop registry <span class="o">&amp;&amp;</span> docker <span class="nb">rm </span>registry
</pre></table></code></div></div><p>（4）使用以下命令启动新的镜像仓库</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">--name</span> registry <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"/var/lib/registry/data:/var/lib/registry </span><span class="se">\</span><span class="s2">
  -v "</span>/var/lib/registry/certs:/certs <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">REGISTRY_HTTP_ADDR</span><span class="o">=</span>0.0.0.0:443 <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="o">=</span>/certs/regisry.lagoudocker.io.crt <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">REGISTRY_HTTP_TLS_KEY</span><span class="o">=</span>/certs/regisry.lagoudocker.io.key <span class="se">\</span>
  <span class="nt">-p</span> 443:443 <span class="se">\</span>
  registry:2.7

</pre></table></code></div></div><p>这里，使用 <code class="language-plaintext highlighter-rouge">-v</code> 参数把镜像数据持久化在<code class="language-plaintext highlighter-rouge">/var/lib/registry/data</code>目录中，</p><p>同时把主机上的证书文件挂载到了容器的 <code class="language-plaintext highlighter-rouge">/certs</code> 目录下，同时通过 <code class="language-plaintext highlighter-rouge">-e</code> 参数设置 HTTPS 相关的环境变量参数，最后让仓库在主机上监听 443 端口。</p><p>（5）仓库启动后，就可以远程推送镜像了</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker tag busybox regisry.lagoudocker.io/busybox
<span class="nv">$ </span>docker push regisry.lagoudocker.io/busybox
</pre></table></code></div></div><h1 id="harbor">Harbor</h1><p>Docker 官方开源的镜像仓库<code class="language-plaintext highlighter-rouge">Distribution</code>仅满足了镜像存储和管理的功能，用户权限管理相对较弱，并且没有管理界面。</p><p>如果想要构建一个企业的镜像仓库，<a href="https://goharbor.io/">Harbor</a> 是一个非常不错的解决方案。</p><ul><li>Harbor 是一个基于 Distribution 项目开发的一款企业级镜像管理软件<li>拥有 RBAC （基于角色的访问控制）、管理用户界面以及审计等非常完善的功能<li>目前已经从 CNCF 毕业，这代表它已经有了非常高的软件成熟度<li>生产中使用的企业较多，社区更加活跃一些</ul><p>Harbor 的使命是成为 Kubernetes 信任的云原生镜像仓库。 Harbor 需要结合 Kubernetes 才能发挥其最大价值，可以在的 <a href="https://goharbor.io/">Harbor 官网</a>了解更多。</p><blockquote class="prompt-warning"><div><p>当使用 Docker Hub 拉取镜像很慢的时候，如何加快镜像的拉取速度 ? 参考文档 <a href="https://zhuanlan.zhihu.com/p/291280980">Docker 拉取镜像速度慢怎么破？</a></p></div></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/'>虚拟化技术</a>, <a href='/categories/docker-%E8%90%BD%E5%9C%B0%E7%AC%94%E8%AE%B0/'>Docker 落地笔记</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Docker 仓库（05） - ThinkerWalker&amp;url=/posts/docker-private-repo/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Docker 仓库（05） - ThinkerWalker&amp;u=/posts/docker-private-repo/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/docker-private-repo/&amp;text=Docker 仓库（05） - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/docker-core-idea/"><div class="card-body"> <em class="timeago small" data-ts="1596367980" > 2020-08-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker 的核心概念（02）</h3><div class="text-muted small"><p> 核心概念 Docker 的操作围绕镜像、容器、仓库三大核心概念。 镜像 通俗的讲，镜像是一个只读的文件和文件夹组合 镜像包含容器运行时所需要的所有基础文件和配置信息 镜像是容器启动的基础，是容器启动的先决条件。 如果想要使用一个镜像，有两种方式： 自己创建镜像。通常情况下，一个镜像是基于一个基础镜像构建的，可以在基础镜像上添加一些用户自定义的内容。例如基于 Cen...</p></div></div></a></div><div class="card"> <a href="/posts/docker-mirror-operation/"><div class="card-body"> <em class="timeago small" data-ts="1596375180" > 2020-08-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker 镜像的操作（03）</h3><div class="text-muted small"><p> 镜像 一个只读的 Docker 容器模板，包含启动容器所需要的所有文件系统结构和内容 一个特殊的文件系统，它提供了容器运行时所需的程序、软件库、资源、配置等静态数据。即镜像不包含任何动态数据，镜像内容在构建后不会被改变。 镜像的操作 镜像的操作分为： 拉取镜像，使用docker pull命令拉取远程仓库的镜像到本地 重命名镜像，使用docker tag命令“重命名”...</p></div></div></a></div><div class="card"> <a href="/posts/docker-basic-operation/"><div class="card-body"> <em class="timeago small" data-ts="1596641580" > 2020-08-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker 容器的操作（04）</h3><div class="text-muted small"><p> 容器（Container）是什么？ 容器是基于镜像创建的可运行实例，并且单独存在 一个镜像可以创建出多个容器 容器的本质是进程，启动需要一个不能退出的命令作为主进程 运行容器化环境时，实际是在容器内部创建该文件的读写副本， 将会添加一个容器层，该层允许修改镜像的整个副本。 容器的生命周期 容器的生命周期分为 5 种： created：初建状态，通过 do...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/docker-basic-operation/" class="btn btn-outline-primary" prompt="上一篇"><p>Docker 容器的操作（04）</p></a> <a href="/posts/dockerfile/" class="btn btn-outline-primary" prompt="下一篇"><p>Docker Dockerfile（06）</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
