<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="打造无状态存储，随时切库的写服务" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="分库分表只解决了容量的问题，并没有解决写服务的高可用问题，或者说分库分表在一定程度上增加了系统故障的概率。" /><meta property="og:description" content="分库分表只解决了容量的问题，并没有解决写服务的高可用问题，或者说分库分表在一定程度上增加了系统故障的概率。" /><link rel="canonical" href="/posts/NoStatus-WriteService-09/" /><meta property="og:url" content="/posts/NoStatus-WriteService-09/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-10T02:41:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="打造无状态存储，随时切库的写服务" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2021-04-10T02:41:00+00:00","datePublished":"2021-04-10T02:41:00+00:00","description":"分库分表只解决了容量的问题，并没有解决写服务的高可用问题，或者说分库分表在一定程度上增加了系统故障的概率。","headline":"打造无状态存储，随时切库的写服务","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/NoStatus-WriteService-09/"},"url":"/posts/NoStatus-WriteService-09/"}</script><title>打造无状态存储，随时切库的写服务 | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>打造无状态存储，随时切库的写服务</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>打造无状态存储，随时切库的写服务</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1618022460" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-04-10 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3361 字"> <em>18 分钟</em>阅读</span></div></div></div><div class="post-content"><p>分库分表只解决了容量的问题，并没有解决写服务的高可用问题，或者说分库分表在一定程度上增加了系统故障的概率。</p><p>从概率上看，原有的单库架构有 50% 的可能性会发生数据库故障。但如果是 5 个分库，则会有 96%的可能性出现故障。</p><blockquote><p>共计有 5 个分库，每一个分库不故障的概率都是 50%。如果整个集群不发生故障，就需要每一个分片都不故障，那么整个集群不发生故障的概率为： \(1-0.5^2=0.96\)</p></blockquote><p>因此，采用分库分表的架构之后，系统的稳定性变得更低了。</p><p>在读服务里，可以采用<strong>数据冗余</strong>来<strong>保障架构的高可用</strong>；</p><p>但在写服务里则无法使用此方案，因为写入服务的数据是用户提交产生的，无法在写入时使用冗余来提高高可用性。</p><p>写冗余需要有满足 CAP 原则的存储支持，<strong>CAP 原则最多只能同时满足两个特性，要么 CP 要么 AP</strong>，因此写冗余无法直接满足。</p><p>本文总结一种能够实现随时切库的高可用写服务方案，不管是单库还是分库分表的原有架构，它都可以原生支持。</p><h2 id="写入业务的目标是成功写入"><span class="mr-2">写入业务的目标是成功写入</span><a href="#写入业务的目标是成功写入" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>写业务是指需要将用户传入的数据进行全部存储的一种场景</strong>。常见的案例有：</p><ul><li>在各大网站提交的申请表单，比如落户申请、身份证办理申请、护照办理申请等；<li>在电商、外派平台里的购物订单，其中会包含商品、价格、收货人等信息；<li>在重要期刊和一些论坛里，提交的论文、博客等。</ul><p>假设明天是论文提交截止日，一定不希望论文提交系统出现问题。</p><p>即使系统出现故障，在论文提交后晚几分钟才能查看内容，但只要你提交成功了，这类故障并不会产生太大的影响。</p><p>其他场景也是类似。对于写入业务，当出现各种故障时，<strong>最重要的是保证系统可写入。</strong></p><h2 id="只要有可用存储即可写入"><span class="mr-2">只要有可用存储即可写入</span><a href="#只要有可用存储即可写入" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>系统可随时写入，就是当出现任何故障，如网络中断、CPU 飙升、磁盘满等问题时，系统依然可以随时写入数据。</strong></p><h2 id="无状态存储架构设计"><span class="mr-2">无状态存储架构设计</span><a href="#无状态存储架构设计" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>分库分表架构里，假设当前只有两个分库，并且这两个分库分别部署在不同机房里，架构如下图 1 所示：</p><p><img data-src="https://images.happymaya.cn/assert/backen-system/jiagou-09-01.png" alt="分库分表且分机房架构" data-proofer-ignore></p><p>当其中一个分库所处的机房出现网络故障，导致该分库不可达时，理论上系统就出现故障了。</p><p>分库分表后，数据在写入时按固定规则（比如用户账号）路由到具体分库的，当某个分库不可达时，对应规则的数据就无法写入了。</p><p><strong>写服务最重要的是保障数据写入</strong>，为了保障可写入，在某一个分库故障（如网络不可达）后，<strong>将原有的数据全部写入当前可用的数据库</strong>！</p><p>从保障数据可随时写入的角度看，此方式是可行的。升级后的架构如下图 2 所示：</p><p><img data-src="https://images.happymaya.cn/assert/backen-system/jiagou-09-02.png" alt="可随时写入的架构方案" data-proofer-ignore></p><p>这种当分库分表里一个分库出现故障后，就随机寻找一个可用的数据库进行写入的方式即是一种保障系统高可用的架构方案。</p><p>此方案可以将图 2 和按固定规则路由的分库分表方案进行结合，方案如下图 3 所示：</p><p><img data-src="https://images.happymaya.cn/assert/backen-system/jiagou-09-03.png" alt="结合后的随机写入架构" data-proofer-ignore></p><p>结合后的架构里，存储依然使用分库分表，但写入规则则发生了一些变化。它不再按固定路由进行写入，而是根据当前实时可用的数据库列表进行随机（如顺序轮流）写入。</p><p>如果某一台数据库出现故障不可用后，则把它从当前可用数据库列表移除。</p><p>如果数据库大面积不可用，可用列表中的数据库变少时，适当地扩容一些数据库资源，并将它添加至当前可用的数据列中。因为此架构可以实现随时切换问题数据库、随时低成本扩容数据库，故又称它为<strong>无状态存储架构设计</strong>。</p><h2 id="维护可用列表"><span class="mr-2">维护可用列表</span><a href="#维护可用列表" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>在写服务运行过程中，通过<strong>自动感知</strong>或<strong>人工确认</strong>的方式维护可用的数据库列表。</p><p>在写服务调用数据库写入时，设置一个阈值。如果写入某一台数据库，在连续几分钟内，失败多少次，则可以判定此数据库故障，并将此判定进行上报。</p><p>当整个写服务集群里，超过半数都认为此数据库故障了，则可以将此数据库从可用列表中剔除。</p><p>此判定方法类似于 Paxos 算法，它在分布式协调和故障迁移中十分流行，此处也适当进行了一些借鉴。</p><p>判定某一台数据库故障并将其下线是一个挺耗费成本的事情，为了防止误剔除某一台只是发生网络抖动的数据库，在真正下线某一个机器前，增加一个报警，给人工确认一个机会。可以设置当多少时间内，人工未响应，即可自动下线。</p><p>上述是将可用列表机器进行下线的方案。对于新扩容的数据库资源，通过系统功能自动加入即可。</p><p>虽然，可以按顺序进行随机写入的，但还是<strong>建议在实现时将顺序随机写入升级为按权重写入</strong>，比如对新加入的机器设置更高的写入权重。</p><p>因为新扩容的机器容量为空，<strong>更高的写入权重，可以让数据更快地在全部数据库里变得均衡</strong>。增加权重的架构如下图 4 所示：</p><p><img data-src="https://images.happymaya.cn/assert/backen-system/jiagou-09-04.png" alt="按权重的数据写入架构" data-proofer-ignore></p><h2 id="写入的处理问题"><span class="mr-2">写入的处理问题</span><a href="#写入的处理问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>通过数据库写入的随机化，实现了写服务的高可用方案。</p><p>但不得不说，虽然解决了写入的高可用，但想要达成一个完整的架构方案，此设计还有几个重要的技术点需要解决：</p><ul><li>如果某一个分库故障后便将其从可用列表中移除，应该如何处理其中已写入的数据呢？<li>因为数据是随机写入，应该如何查询写入的数据呢？</ul><p>对于上述的问题，一个整体的架构解决方案。如下图 5 所示：</p><p><img data-src="https://images.happymaya.cn/assert/backen-system/jiagou-09-05.png" alt="采用随机写入后的整体架构方案" data-proofer-ignore></p><p>简单来说，整体的架构方案就是在分库分表的方案基础上，做了进一步升级。</p><p>架构图的右边部分和分库分表几乎一模一样，左边部分则是本文的方案，它主要包含以下两个部分的内容：</p><ol><li><p>数据随机写入模块，保证在故障时数据依然可以写入。</p><li><p>数据同步模块，将数据从随机写入的数据库集群实时地同步至分库分表集群里。后续的所有流程，都和原有的保持一致了。</p></ol><p>通过写入模块和同步模块的配合，即实<strong>现了基于无状态存储的高可用架构的整套方案。</strong></p><h2 id="数据同步问题解决数据延迟"><span class="mr-2">数据同步问题（解决数据延迟）</span><a href="#数据同步问题解决数据延迟" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>在采用同步模块后，从逻辑上是可以实现写入后数据可查询的。</p><p>但只是逻辑上的，因为增加了同步模块后数据延迟是不可避免。更有甚者，可能因数据同步存在 Bug 导致数据一直未同步的场景。</p><p>针对这个问题，解决的架构方案如下图 6 所示：</p><p><img data-src="https://images.happymaya.cn/assert/backen-system/jiagou-09-06.png" alt="解决数据延迟的架构" data-proofer-ignore></p><p>在数据写入后，用户需要立即查看写入内容的场景并不太多。</p><p>比如上传完论文后，只要立刻确定论文上传成功，且查看系统里的论文内容和上传的一致即可。</p><p>对于这些有时延要求的场景，图 5 的架构里已经进行了单独预处理。</p><p>当数据写入随机存储成功后，在请求返回前，主动地将数据写入缓存中，同时将此次写入的数据全部返回给前台。但此处并不强制缓存一定要写成功，缓存写入失败也可以返回成功。对时延敏感的场景，可以直接查询此缓存。</p><p>对于无状态存储中的数据，在写入请求中主动触发同步模块进行迁移，如上图 5 中标号 X 的流程。同步模块在接收到请求后，立刻将数据同步至分库分表及缓存中，后续流程就和上一讲保持一致了。</p><p>主动触发同步模块的请求及同步模块本身运行都有可能出现异常，对于可能出现的异常情况，可以设计兜底策略进行处理。</p><p>兜底策略和同步模块比较类似，主要架构如下图 7 所示：</p><p><img data-src="https://images.happymaya.cn/assert/backen-system/jiagou-09-07.png" alt="兜底同步策略" data-proofer-ignore></p><p>兜底的同步对于无状态存储中的数据按创建时间进行不断轮询，轮询会对超过设置的时间阈值（如 5S）仍未得到同步的数据进行主动同步。</p><p>此兜底方案保证了当上述缓存预写入和主动同步故障时，数据仍然可以写入分库分表。</p><p>此外，如果兜底策略的时间阈值设置得过小，有可能和主动同步产生重复同步。<strong>对于重复同步，在分库分表处设置数据库唯一索引、插入前查询进行简单防重即可</strong>。</p><h2 id="缓存可降级"><span class="mr-2">缓存可降级</span><a href="#缓存可降级" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>因为主动写入缓存可能存在异常，导致数据未写入缓存，且主动数据同步和兜底同步是先写分库分表再通过 Binlog 刷新缓存，存在一定的延迟。</p><p>因此在查询时需要具备降级功能，当缓存中未查询到时，可以主动降级到数据库进行一次兜底查询，并将查询到的值存储至缓存中。后续再有数据变更，和原有保持一致即可。</p><p>可降级的架构方案如下图 8 所示：</p><p><img data-src="https://images.happymaya.cn/assert/backen-system/jiagou-09-08.png" alt="缓存可降级架构方案" data-proofer-ignore></p><h2 id="其他功能流程保持复用"><span class="mr-2">其他功能流程保持复用</span><a href="#其他功能流程保持复用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>采用无状态存储后，原有分库分表及无状态存储集群，除了上述之外的一些架构细节，是否还会有什么变化？比如，假设某一台无状态存储的数据库故障后，如果该故障数据库中仍有数据未同步如何处理？</p><p>其实此数据库故障后的处理流程和任何线上数据库故障一样，都是经由 DBA 确认该数据库的从库和主库数据是否一致。如一致，升级该库的从库为主库，并将其加回无状态集群即可。对于其余的一些架构细节亦是如此。</p><h2 id="总结"><span class="mr-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>虽然当某一台无状态存储出现故障时，其中遗留的数据会出现短时的同步延迟，但<strong>此方案可以将出问题的无状态存储立刻移除，保障了写入的 7*24 高可用</strong>。</p><p>对于一些对写入有极致要求的场景，比如在电商的大促零点时刻，每一秒钟都会产生上百万、千万的下单金额。可以进行适当地体验降级，比如让用户晚几秒看到历史订单列表，但一定要保障在此时刻用户可以下单并看到此订单的结果，以及对应的收件信息（如收货地址、电话、收货人）。对于上述场景，此方案也可以很好地应对。</p><p>此方案虽然应对了对写入有极致要求的场景，但它会将系统变得更加复杂且落地的开发成本和部署成本都更高，这也是它的弊端。架构是为了达到解决问题的目标而做的平衡，而不是技术比拼。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/architecture-design/'>Architecture Design</a>, <a href='/categories/backend-system/'>Backend System</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/architecture-design/" class="post-tag no-text-decoration" >Architecture Design</a> <a href="/tags/backend-system/" class="post-tag no-text-decoration" >Backend System</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=打造无状态存储，随时切库的写服务 - ThinkerWalker&amp;url=/posts/NoStatus-WriteService-09/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=打造无状态存储，随时切库的写服务 - ThinkerWalker&amp;u=/posts/NoStatus-WriteService-09/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/NoStatus-WriteService-09/&amp;text=打造无状态存储，随时切库的写服务 - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Business-System-Commonalities-01/"><div class="card-body"> <em class="timeago small" data-ts="1614666780" > 2021-03-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>后端业务系统共性总结</h3><div class="text-muted small"><p> 国内的各大互联网公司业务模式非常丰富，所提供的业务服务也是形态各异，比如： 腾讯：主要提供即时通信、游戏等服务 京东、阿里等电商平台提供商品购买、快递寄收件、金融投资等服务 滴滴提供打车服务 今日头条、新浪微博提供短视频、新闻资讯类阅读服务 美团提供商品购买、外卖订购服务 百度提供搜索查询服务 虽然上述列举的公司业务类型不同，但对后台开发岗位的招聘要求却很相似...</p></div></div></a></div><div class="card"> <a href="/posts/use-splitting-to-reduce-complexity-architecture-02/"><div class="card-body"> <em class="timeago small" data-ts="1614948300" > 2021-03-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>利用“拆分”降低架构复杂度</h3><div class="text-muted small"><p> 上一文，从技术的目的性这个维度，将业务后台系统的类型归为三大类： 读业务； 写业务； 扣减业务。 除了基于技术维度的拆分，在后台架构里还有很多其他形式的拆分，比如上文里面的外卖系统架构，整个后台可以拆分为： 用户 订单 商品 价格等模块 通过拆分可以将一个涉及面广、复杂度高的系统拆解为多个小模块，让各个团队单独负责并专项击破。 拆分是架构设计大型...</p></div></div></a></div><div class="card"> <a href="/posts/full-cache-readService-04/"><div class="card-body"> <em class="timeago small" data-ts="1615116780" > 2021-03-07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>使用全量缓存构建毫秒级的读服务</h3><div class="text-muted small"><p> 利用全量缓存打造一个无毛刺、平均性能在 100ms 以内的读服务。 全量缓存的基本架构 全量缓存是指将数据库中的所有数据都存储在缓存中（需要高性能查询的数据，而不是全部业务数据。如果高性能的数据依然很多，可以对数据按查询频率进行区分。缓存里只存储高频率访问数据，其他低频率数据可以放到 hbase 或者数据库里。 ），同时在缓存中不设置过期时间的一种实现方式，此实现的架构如下图所示： ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/SplitDataBase-SplitTable-WriteService-08/" class="btn btn-outline-primary" prompt="上一篇"><p>使用分库分表，支持海量数据的写入</p></a> <a href="/posts/dependency-control-WritingServices-10/" class="btn btn-outline-primary" prompt="下一篇"><p>利用依赖管控，提升写服务的性能和可用性</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
