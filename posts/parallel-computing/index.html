<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="并行计算（12）" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="现在的电脑，往往都有多核心，即使是一部手机，也往往配备了并且处理器，通过多进程或多线程的手段，就可以让多个 CPU 核同时工作，加快任务的执行。" /><meta property="og:description" content="现在的电脑，往往都有多核心，即使是一部手机，也往往配备了并且处理器，通过多进程或多线程的手段，就可以让多个 CPU 核同时工作，加快任务的执行。" /><link rel="canonical" href="/posts/parallel-computing/" /><meta property="og:url" content="/posts/parallel-computing/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-04-17T12:33:33+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="并行计算（12）" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2022-05-26T21:13:46+00:00","datePublished":"2019-04-17T12:33:33+00:00","description":"现在的电脑，往往都有多核心，即使是一部手机，也往往配备了并且处理器，通过多进程或多线程的手段，就可以让多个 CPU 核同时工作，加快任务的执行。","headline":"并行计算（12）","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/parallel-computing/"},"url":"/posts/parallel-computing/"}</script><title>并行计算（12） | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>并行计算（12）</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>并行计算（12）</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1555504413" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2019-04-17 </em> </span> <span> 更新于 <em class="timeago" data-ts="1653599626" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-27 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6157 字"> <em>34 分钟</em>阅读</span></div></div></div><div class="post-content"><p>现在的电脑，往往都有多核心，即使是一部手机，也往往配备了并且处理器，通过多进程或多线程的手段，就可以让多个 CPU 核同时工作，加快任务的执行。</p><p>Java 提供了非常丰富的 API，来支持多线程并发。对于 Java 开发者来说，如何将多线程应用到业务场景与注意事项 ？</p><p>从一个并行数据的栗子，总结知识点。</p><h2 id="并行获取数据"><span class="mr-2">并行获取数据</span><a href="#并行获取数据" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>考虑到一种场景。有一个用户数据接口，要求在 50 ms 内返回数据。它的调用逻辑非常复杂，打交道的接口也非常多，需要从 20 多个接口总书记。这些接口，最小的耗时也要 20 ms，哪怕全部都是最优状态，算下来也需要 20 * 20 = 400 ms.</p><p>解决此问题的方式只有<strong>并行</strong>，通过多线程同时去获取计算结果，最后再进行结果拼接。 <img data-src="http://assets.processon.com/chart_image/627012dc0e3e742d4626a0fb.png" alt="" data-proofer-ignore></p><p>但这种编程模型实在是太复杂了，如果使用原生线程 API，或者使用 wait、notify 等函数，代码的复杂度可以想象有多大。</p><p>但幸运的是，现在 Java 中的大多数并发编程场景，都可以使用 concurrent 包的一些工具来实现。</p><p>在这种场景中，可以使用 <strong>CountDownLatch</strong> 完成操作。<strong>CountDownLatch</strong> 本质上是一个计算器，一般情况下，我们将它初始化为与执行任务相同的数量。当一个任务执行完时，就将计算器的值减 1，直到计数器值达到 0 时，表示完成了所有的任务，在 await 上等待的线程就可以继续执行下去。</p><p>下面的代码，是俺专门为这个场景封装的一个工具类。它主要传入了两个参数：</p><ul><li>一个是要计算的 job 数量<li>一个是整个大任务超时的毫秒数<div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ParallelFetcher</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">CountDownLatch</span> <span class="n">latch</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">ThreadPoolExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span>
      <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">100</span><span class="o">));</span>
    
  <span class="kd">public</span> <span class="nf">ParallelFetcher</span><span class="o">(</span><span class="kt">int</span> <span class="n">jobSize</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMill</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">timeout</span> <span class="o">=</span> <span class="n">timeoutMill</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="n">jobSize</span><span class="o">);</span>
  <span class="o">}</span>
    
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">submitJob</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="n">runnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
          <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
      <span class="o">});</span>
  <span class="o">}</span>
    
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">latch</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
    
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dispose</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><p>当 job 运行时间，超过了任务的时间上限，就会被直接终止，这就是 await 函数的功能。</p><p>下面是使用这段代码的一个示例。SlowInterfaceMock 是一个测试类，用来模拟远程服务的超时动作，会等待 0~60 毫秒，程序运行后，会输出执行结果到 map 集合中。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="s">"123"</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">SlowInterfaceMock</span> <span class="n">mock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SlowInterfaceMock</span><span class="o">();</span>
        <span class="nc">ParallelFetcher</span> <span class="n">fetcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ParallelFetcher</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method0"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method1"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method2"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method3"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method4"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method5"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method6"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method7"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method8"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method9"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method10"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method11"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method12"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method13"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method14"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method15"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method16"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method17"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method18"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>
        <span class="n">fetcher</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"method19"</span><span class="o">,</span> <span class="n">mock</span><span class="o">.</span><span class="na">method0</span><span class="o">(</span><span class="n">userId</span><span class="o">)));</span>

        <span class="n">fetcher</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fetcher</span><span class="o">.</span><span class="na">latch</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

        <span class="n">fetcher</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>使用这种方式，接口就可以在固定的时间内返回了。</p><p>concurrent 包里面提供了非常多的类似 CountDownLatch 的工具，在享受便捷性的同时，这段代码需要注意的事情：</p><ul><li>首先，latch 的数量加上 map 的 size，总数应该是 20，但运行之后，大概率不是，我们丢失了部分数据。原因就是，main 方法里使用了 HashMap 类，它并不是线程安全的，在并发执行时发生了错乱，造成了错误的结果，将 HashMap 换成 ConcurrentHashMap 即可解决问题。</ul><p>从这个小问题就可以看出：并发编程并不是那么友好，一不小心就会踏进陷阱。如果对集合的使用场景并不是特别在行，直接使用线程安全的类，出错的概率会更少一点。</p><p>再来看一下线程池的设置，里面有非常多的参数，最大池数量达到了 200 个。那线程数到底设置多少合适呢？按照我们的需求，每次请求需要执行 20 个线程，200 个线程就可以支持 10 个并发量，按照最悲观的 50ms 来算的话，这个接口支持的最小 QPS 就是：1000/50*10=200。这就是说，如果访问量增加，这个线程数还可以调大。</p><p>在平常的业务中，有<strong>计算密集型任务</strong>和<strong>I/O 密集型任务</strong>之分。</p><ul><li><p>I/O 密集型任务 对于常见的互联网服务来说，大多数是属于 I/O 密集型的，比如<strong>等待数据库的 I/O</strong>，<strong>等待网络 I/O</strong> 等。</p><p>在这种情况下，当线程数量等于 I/O 任务的数量时，效果是最好的。虽然线程上下文切换会有一定的性能损耗，但相对于缓慢的 I/O 来说，这点损失是可以接受的。</p><p>上面说的情况，是针对同步 I/O 来说的，基本上是一个任务对应一个线程。异步 NIO 会加速这个过程。</p><li><p>计算密集型任务 计算密集型的任务却正好相反，比如一些耗时的算法逻辑。</p><p>CPU 要想达到最高的利用率，提高吞吐量，最好的方式就是：<strong>让它尽量少地在任务之间切换</strong>，此时，线程数等于 CPU 数量，是效率最高的。</p></ul><p>了解了任务的这些特点，就可以通过调整线程数量增加服务性能。比如，<strong>高性能的网络工具包 Netty</strong>，<strong>EventLoop 默认的线程数量，就是处理器的 2 倍</strong>。</p><p>如果业务 I/O 比较耗时，此时就容易造成任务的阻塞，解决方式有两种：</p><ul><li>一种方式是提高 worker 线程池的大小；<li>另外一种方式是让耗时的操作在另外的线程池里运行。</ul><h2 id="从池化对象原理看线程池"><span class="mr-2">从池化对象原理看线程池</span><a href="#从池化对象原理看线程池" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>线程的资源是比较昂贵的，频繁地创建和销毁同样会影响系统性能。而线程资源是非常适合进行池化的。</p><p>线程池与其他对象池的设计思路差不多，但它有些细微的差别，下面是线程池参数最全的构造方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span>
    <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span> 
    <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span> 
    <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span> 
    <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">,</span> 
    <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span> 
    <span class="nc">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span> 
    <span class="nc">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span>
</pre></table></code></div></div><p>前几个参数没有什么好说的，相对于普通对象池而言，由于线程资源总是有效，它甚至少了非常多的 Idle 配置参数（与对象池比较），主要是 <code class="language-plaintext highlighter-rouge">workQueue</code> 和 <code class="language-plaintext highlighter-rouge">handler</code>。</p><p>关于任务的创建过程，可以说是多线程每次必问的问题了。如下图所示，任务被提交后，首先判断它是否达到了最小线程数（coreSize），如果达到了，就将任务缓存在任务队列里。如果队列也满了，会判断线程数量是否达到了最大线程数（maximumPoolSize），如果也达到了，就会进入任务的拒绝策略（handler）。 <img data-src="http://assets.processon.com/chart_image/6270192d079129397f2eb0e7.png" alt="拒绝策略" data-proofer-ignore></p><p>Executors 工厂类中默认的几个快捷线程池代码。</p><ol><li><p>固定大小线程池</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="nf">newFixedThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span> 
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">,</span> <span class="mi">0L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span> 
    <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;());</span> 
<span class="o">}</span>
</pre></table></code></div></div><p>FixedThreadPool 的最大最小线程数是相等的，其实设置成不等的也不会起什么作用。</p><p>主要原因就是它所采用的任务队列 LinkedBlockingQueue 是无界的，代码走不到判断最大线程池的逻辑。keepAliveTime 参数的设置，也没有意义，因为线程池回收的是corePoolSize和maximumPoolSize 之间的线程。</p><p>这个线程池的问题是，由于队列是无界的，在任务较多的情况下，会造成内存使用不可控，同时任务也会在队列里长时间等待。</p><li><p>无限大小线程池</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="nf">newCachedThreadPool</span><span class="o">()</span> <span class="o">{</span> 
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="mi">60L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SynchronousQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;());</span> 
<span class="o">}</span>
</pre></table></code></div></div><p>CachedThreadPool 是另外一个极端，它的最小线程数是 0，线程空闲 1 分钟的都会被回收。</p><p>在提交任务时，使用了 SynchronousQueue，不缓存任何任务，直接创建新的线程。这种方式同样会有问题，因为它同样无法控制资源的使用，很容易造成内存溢出和过量的线程创建。</p><p>一般在线上，这两种方式都不推荐，需要根据具体的需求，使用 ThreadPoolExecutor 自行构建线程池，这也是阿里开发规范中推荐的方式。</p><ul><li>如果任务可以接受一定时间的延迟，那么使用 LinkedBlockingQueue 指定一个队列的上限，缓存一部分任务是合理的；<li>如果任务对实时性要求很高，比如 RPC 服务，就可以使用 SynchronousQueue 队列对任务进行传递，而不是缓存它们。</ul><li><p>拒绝策略（rejection policy）</p><p>默认的拒绝策略，就是抛出异常的 AbortPolicy，与之类似的是 DiscardPolicy，它什么都不做，连异常都不抛出，这个非常不推荐。</p><p>还有一个叫作 CallerRunsPolicy，当线程池饱和时，它会使用用户的线程执行任务。比如，在Controller 里的线程池满了，会阻塞在 Tomcat 的线程池里对任务进行执行，这很容易会将用户线程占满，造成用户业务长时间等待。具体用不用这种策略，还是要看客户对等待时间的忍受程度。</p><p>最后一个策略叫作 <strong>DiscardOldestPolicy</strong>，它在遇到线程饱和时，会先弹出队列里最旧的任务，然后把当前的任务添加到队列中。</p></ol><h2 id="在-springboot-中使用异步"><span class="mr-2">在 SpringBoot 中使用异步</span><a href="#在-springboot-中使用异步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>SpringBoot 中可以非常容易地实现异步任务。</p><p>首先，需要在启动类上加上 @EnableAsync 注解，然后在需要异步执行的方法上加上 @Async 注解。一般情况下，我们的任务直接在后台运行就可以，但有些任务需要返回一些数据，这个时候，就可以使用 Future 返回一个代理，供其他的代码使用。</p><p>关键代码如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableAsync</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaRulesApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">JavaRulesApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Component</span>
<span class="nd">@Async</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsyncJob</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testJob</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">3</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">"aaa"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">testJob2</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">testJob</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">AsyncResult</span><span class="o">&lt;&gt;(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>默认情况下，Spring 将启动一个默认的线程池供异步任务使用。这个线程池也是无限大的，资源使用不可控，所以强烈建议使用代码设置一个适合自己的。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">ThreadPoolTaskExecutor</span> <span class="nf">getThreadPoolTaskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">taskExecutor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">taskExecutor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="n">taskExecutor</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
        <span class="n">taskExecutor</span><span class="o">.</span><span class="na">setQueueCapacity</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="n">taskExecutor</span><span class="o">.</span><span class="na">setKeepAliveSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>
        <span class="n">taskExecutor</span><span class="o">.</span><span class="na">setThreadNamePrefix</span><span class="o">(</span><span class="s">"test-"</span><span class="o">);</span>
        <span class="n">taskExecutor</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">taskExecutor</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="多线程资源总结"><span class="mr-2">多线程资源总结</span><a href="#多线程资源总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>线程安全的类 HashMap 和 ConcurrentHashMap，后者相对于前者，是线程安全的。多线程的细节非常多，下面就盘点一下，一些常见的线程安全的类。<ul><li>StringBuilder 对应着 StringBuffer。后者主要是通过 synchronized 关键字实现了线程的同步。值得注意的是，在单个方法区域里，这两者是没有区别的，JIT 的编译优化会去掉 synchronized 关键字的影响。<li>HashMap 对应着 ConcurrentHashMap。ConcurrentHashMap 的话题很大，这里提醒一下 JDK1.7 和 1.8 之间的实现已经不一样了。1.8 已经去掉了分段锁的概念（锁分离技术），并且使用 synchronized 来代替了 ReentrantLock。<li>ArrayList 对应着 CopyOnWriteList。后者是写时复制的概念，适合读多写少的场景。<li>LinkedList 对应着 ArrayBlockingQueue。ArrayBlockingQueue 对默认是不公平锁，可以修改构造参数，将其改成公平阻塞队列，它在 concurrent 包里使用得非常频繁。<li>HashSet 对应着 CopyOnWriteArraySet。</ul><p>下面以一个经常发生问题的案例，来说一下线程安全的重要性。</p><p>SimpleDateFormat 是经常用到的日期处理类，但它本身不是线程安全的，在多线程运行环境下，会产生很多问题，在以往的工作中，通过 sonar 扫描，发现这种误用的情况特别的多。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FaultDateFormat</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">TIME_FORMAT_YYYY_MM_DD_HH_MM_SS</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">;</span>
   
    <span class="nc">SimpleDateFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="no">TIME_FORMAT_YYYY_MM_DD_HH_MM_SS</span><span class="o">);</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">FaultDateFormat</span> <span class="n">faultDateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FaultDateFormat</span><span class="o">();</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">faultDateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"2020-07-25 08:56:40"</span><span class="o">));</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>执行上面的代码，可以看到，时间已经错乱了。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nc">Thu</span> <span class="nc">May</span> <span class="mo">01</span> <span class="mi">08</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">40</span> <span class="no">CST</span> <span class="mi">618104</span> 
<span class="nc">Thu</span> <span class="nc">May</span> <span class="mo">01</span> <span class="mi">08</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">40</span> <span class="no">CST</span> <span class="mi">618104</span> 
<span class="nc">Mon</span> <span class="nc">Jul</span> <span class="mi">26</span> <span class="mi">08</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">04</span> <span class="no">CST</span> <span class="mi">1</span> 
<span class="nc">Tue</span> <span class="nc">Jun</span> <span class="mi">30</span> <span class="mi">08</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mo">00</span> <span class="no">CST</span> <span class="mi">2020</span> 
<span class="nc">Thu</span> <span class="nc">Oct</span> <span class="mo">01</span> <span class="mi">14</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">20</span> <span class="no">CST</span> <span class="mi">16</span> 
<span class="nc">Sun</span> <span class="nc">Jul</span> <span class="mi">13</span> <span class="mo">01</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">40</span> <span class="no">CST</span> <span class="mi">20220200</span> 
<span class="nc">Wed</span> <span class="nc">Dec</span> <span class="mi">25</span> <span class="mi">08</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">40</span> <span class="no">CST</span> <span class="mi">2019</span> 
<span class="nc">Sun</span> <span class="nc">Jul</span> <span class="mi">13</span> <span class="mo">01</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">40</span> <span class="no">CST</span> <span class="mi">20220200</span>
</pre></table></code></div></div><p>解决方式就是使用 <strong>ThreadLocal 局部变量</strong>，代码如下所示，可以有效地解决线程安全问题。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodDateFormat</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">TIME_FORMAT_YYYY_MM_DD_HH_MM_SS</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">;</span>
    <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">SimpleDateFormat</span><span class="o">&gt;</span> <span class="n">format</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">SimpleDateFormat</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">SimpleDateFormat</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="no">TIME_FORMAT_YYYY_MM_DD_HH_MM_SS</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">GoodDateFormat</span> <span class="n">faultDateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GoodDateFormat</span><span class="o">();</span>
        <span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">faultDateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="s">"2020-07-25 08:56:40"</span><span class="o">));</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><li><p>线程的同步方式</p><p>Java 中实现线程同步的方式有很多，大体可以分为以下 8 类。</p><ul><li>使用 Object 类中的 <strong>wait</strong>、<strong>notify</strong>、<strong>notifyAll</strong> 等函数。由于这种编程模型非常复杂，现在已经很少用了。这里有一个关键点，那就是对于这些函数的调用，必须放在同步代码块里才能正常运行。<li>使用 ThreadLocal 线程局部变量的方式，每个线程一个变量，本课时会详细讲解。<li>使用 synchronized 关键字修饰方法或者代码块。这是 Java 中最常见的方式，有锁升级的概念。<li>使用 Concurrent 包里的可重入锁 ReentrantLock。使用 CAS 方式实现的可重入锁。<li>使用 volatile 关键字控制变量的可见性，这个关键字保证了变量的可见性，但不能保证它的原子性。<li>使用线程安全的阻塞队列完成线程同步。比如，使用 LinkedBlockingQueue 实现一个简单的生产者消费者。<li>使用原子变量。<strong>Atomic</strong>* 系列方法，也是使用 CAS 实现的，关于 CAS，我们将在下一课时介绍。<li>使用 Thread 类的 join 方法，可以让多线程按照指定的顺序执行。</ul><p>下面的代码，是使用 LinkedBlockingQueue 实现的一个简单<strong>生产者</strong>和<strong>消费者</strong>实例，可以看到，我们还使用了一个 volatile 修饰的变量，来决定程序是否继续运行，这也是 volatile 变量的常用场景。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProducerConsumer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">Q_SIZE</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="no">Q_SIZE</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
   
    <span class="nc">Runnable</span> <span class="n">producer</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">stop</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//noop</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="nc">Runnable</span> <span class="n">consumer</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">stop</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" | "</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// noop</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
   
    <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">producer</span><span class="o">,</span> <span class="s">"Thread 1"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">producer</span><span class="o">,</span> <span class="s">"Thread 2"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="s">"Thread 3"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="s">"Thread 4"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ProducerConsumer</span> <span class="n">pc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProducerConsumer</span><span class="o">();</span>
        <span class="n">pc</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">10</span><span class="o">);</span>
        <span class="n">pc</span><span class="o">.</span><span class="na">stop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><li><p>FastThreadLocal</p><p>在平常的编码中，使用最多的就是 ThreadLocal 类了。拿最常用的 Spring 来说，它事务管理的传播机制，就是使用 ThreadLocal 实现的。因为 ThreadLocal 是线程私有的，所以 Spring 的事务传播机制是不能够跨线程的。<strong>在问到 Spring 事务管理是否包含子线程时，要能够想到面试官的真实意图。</strong></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cm">/** 
    * Holder to support the {@code currentTransactionStatus()} method, 
    * and to support communication between different cooperating advices 
    * (e.g. before and after advice) if the aspect involves more than a 
    * single method (as will be the case for around advice). 
*/</span> 
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">TransactionInfo</span><span class="o">&gt;</span> <span class="n">transactionInfoHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NamedThreadLocal</span><span class="o">&lt;&gt;(</span><span class="s">"Current aspect-driven transaction"</span><span class="o">);</span>
</pre></table></code></div></div><p>既然 Java 中有了 ThreadLocal 类了，为什么 Netty 还自己创建了一个叫作 FastThreadLocal 的结构？</p><p>首先来看一下 ThreadLocal 的实现。</p><p>Thread 类中，有一个成员变量 ThreadLocals，存放了与本线程相关的所有自定义信息。对这个变量的定义在 Thread 类，而操作却在 ThreadLocal 类中。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="no">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span> 
    <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span> 
    <span class="nc">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span> 
    <span class="o">...</span> 
<span class="o">}</span> 
   
<span class="nc">ThreadLocalMap</span> <span class="nf">getMap</span><span class="o">(</span><span class="nc">Thread</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span> 
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">threadLocals</span><span class="o">;</span> 
<span class="o">}</span>
</pre></table></code></div></div><p>问题就出在 ThreadLocalMap 类上，它虽然叫 Map，但却没有实现 Map 的接口。如下图，ThreadLocalMap 在 rehash 的时候，并没有采用类似 HashMap 的数组+链表+红黑树的做法，它只使用了一个数组，使用<strong>开放寻址</strong>（遇到冲突，依次查找，直到空闲位置）的方法，这种方式是非常低效的。</p><p><img data-src="https://image.happymaya.cn/assert/blog/java/java-ThreadLocalMap-rehash.png" alt="image-20220418022103708" data-proofer-ignore></p><p>由于 Netty 对 ThreadLocal 的使用非常频繁，Netty 对它进行了专项的优化。它之所以快，是因为在底层数据结构上做了文章，使用常量下标对元素进行定位，而不是使用JDK 默认的探测性算法。</p><blockquote class="prompt-warning"><div><p>伪共享问题吗？底层的 InternalThreadLocalMap对cacheline 也做了相应的优化。</p></div></blockquote><p><img data-src="https://image.happymaya.cn/assert/blog/java/java-netty-threadLocal-constant-subscript.png" alt="image-20220418022206109" data-proofer-ignore></p><li><p>使用多线程中遇到过的问题</p><p>通过上面的知识总结，可以看到多线程相关的编程，是属于比较高阶的技能。面试中，<strong>面试官会经常问你在多线程使用中遇到的一些问题，以此来判断你实际的应用情况。</strong></p><p>先总结一下文中已经给出的示例：</p><ul><li>线程池的不正确使用，造成了资源分配的不可控；<li>I/O 密集型场景下，线程池开得过小，造成了请求的频繁失败；<li>线程池使用了 CallerRunsPolicy 饱和策略，造成了业务线程的阻塞；<li>SimpleDateFormat 造成的时间错乱。</ul><p>另外，着重一点是，在处理循环的任务时，一定不要忘了捕捉异常。尤其需要说明的是，像 NPE 这样的异常，由于是非捕获型的，IDE 的代码提示往往不起作用。见过很多案例，就是由于忘了处理异常，造成了任务中断，这种问题发生的机率小，是比较难定位的，一定要保持良好的编码习惯。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">while</span><span class="o">(!</span><span class="n">isInterrupted</span><span class="o">){</span>
    <span class="k">try</span> <span class="o">{</span> 
        <span class="o">......</span> 
     <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">){</span>
         <span class="o">......</span>
     <span class="o">}</span> 
<span class="o">}</span>
</pre></table></code></div></div><p>多线程环境中，异常日志是非常重要的，但线程池的默认行为并不是特别切合实际。参见如下代码，任务执行时，抛出了一个异常，但我们的终端什么都没输出，异常信息丢失了，这对问题排查非常不友好。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span> 
<span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span> <span class="o">()-&gt;</span> <span class="o">{</span> 
    <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> 
<span class="o">});</span> 
<span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</pre></table></code></div></div><p>我们跟踪任务的执行，在 ThreadPoolExecutor 类中可以找到任务发生异常时的方法，它是抛给了 afterExecute 方法进行处理。</p><p><img data-src="https://image.happymaya.cn/assert/blog/java/java-threadpoolexecutor-afterexecute.png" alt="image-20220418022405766" data-proofer-ignore></p><p>可惜的是，ThreadPoolExecutor 中的 afterExecute 方法是没有任何实现的，它是个空方法。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">afterExecute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</pre></table></code></div></div><p>如果通过重写 afterExecute 来改变这个默认行为，但这代价点大。其实，使用 submit 方法提交的任务，会返回一个 Future 对象，只有调用了它的 get 方法，这个异常才会打印。使用 submit 方法提交的任务，代码永远不会走到上图标红的一行，获取异常的方式有且只有这一种。</p><p>只有使用 execute 方法提交的任务才会走到这行异常处理代码。如果你想要默认打印异常，推荐使用 execute 方法提交任务，它和 submit 方法的区别，也不仅仅是返回值不一样那么简单。</p><li><p>异步</p><p>“异步，并没有减少任务的执行步骤，也没有算法上的改进，那么为什么说异步的速度更快呢？”</p><p>其实这是对“异步作用”的错误理解。<strong>异步是一种编程模型，它通过将耗时的操作转移到后台线程运行，从而减少对主业务的堵塞，所以我们说异步让速度变快了</strong>。但如果你的系统资源使用已经到了极限，异步就不能产生任何效果了，它主要优化的是那些阻塞性的等待。</p><p>缓冲、缓存、池化等优化方法，都是用到了异步。它能够起到转移冲突，优化请求响应的作用。由于合理地利用了资源，系统响应确实变快了，</p><p>异步还能够对业务进行解耦，如下图所示，它比较像是生产者消费者模型。主线程负责生产任务，并将它存放在待执行列表中；消费线程池负责任务的消费，进行真正的业务逻辑处理。</p><p><img data-src="http://assets.processon.com/chart_image/62702c6be401fd1b24671e4f.png" alt="" data-proofer-ignore></p></ol><blockquote><p>ParallelFetcher中，如果到了超时时间后，result返回了部分结果，但是剩下的几个线程还是在执行，需不需要把还在执行的线程cancel调？ —— 不需要的。因为任务实际运行的，大多数是阻塞的I/O操作，比如URLConnection。这种情况下，cancel是没什么用的，interrupt函数也没作用。最好是给具体的组件设置一个超时的值。</p></blockquote><p class="prompt-warning">不需要的。因为任务实际运行的，大多数是阻塞的I/O操作，比如URLConnection。这种情况下，cancel是没什么用的，interrupt函数也没作用。最好是给具体的组件设置一个超时的值。—— kafka只能保证partition顺序有效，所以一般都推荐根据partition进行业务划分，只保证分区消息的顺序性，比如把单个用户的所有消息都放在一个partition。想要多个partition全局有效，这个肯定要引入中间协调器，效率会下降的特别严重。像binlog这种有严格顺序的需求特别少，大多数业务需求属于从设计层面去规避的问题，最好不要带到编码里来。</p><blockquote><p>从kafka过来的大量消息数据，要保证消息的顺序，有什么好的优化建议</p></blockquote><p class="prompt-warning">kafka只能保证partition顺序有效，所以一般都推荐根据partition进行业务划分，只保证分区消息的顺序性，比如把单个用户的所有消息都放在一个partition。想要多个partition全局有效，这个肯定要引入中间协调器，效率会下降的特别严重。像binlog这种有严格顺序的需求特别少，大多数业务需求属于从设计层面去规避的问题，最好不要带到编码里来。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/performance-optimization/'>Performance Optimization</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-tag no-text-decoration" >性能优化</a> <a href="/tags/performance-optimization/" class="post-tag no-text-decoration" >Performance Optimization</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=并行计算（12） - ThinkerWalker&amp;url=/posts/parallel-computing/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=并行计算（12） - ThinkerWalker&amp;u=/posts/parallel-computing/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/parallel-computing/&amp;text=并行计算（12） - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Performance-Optimization-Metrics-and-Points-to-Watch/"><div class="card-body"> <em class="timeago small" data-ts="1551540780" > 2019-03-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>衡量的指标和注意的点(01)</h3><div class="text-muted small"><p> 所谓性能，就是使用有限的资源在有限的时间内完成工作。 在做性能优化时，能够帮助决策的衡量指标有以下五点，分别是： 性能指标 吞吐量，QPS、TPS、HPS 响应速度， Time 响应时间 平均响应时间 AVG 百分位数 Top Percentile 并发量 秒开率 正确...</p></div></div></a></div><div class="card"> <a href="/posts/Entry-point-for-performance-optimization/"><div class="card-body"> <em class="timeago small" data-ts="1552059180" > 2019-03-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>性能优化类别(02)</h3><div class="text-muted small"><p> 性能优化根据优化的类别，分为业务优化和技术优化。业务优化产生的效果也是非常大的，但它属于产品和管理的范畴。同作为程序员，在平常工作中，我们面对的优化方式，主要是通过一系列的技术手段，来完成对既定的优化目标。这一系列的技术手段，大体归纳为如图以下 7 类： 1 复用优化 在写代码的时候，经常会发现有很多重复的代码可以提取出来，做成公共方法。这样，在下次用时，就不用在费劲写一遍。这种思想就...</p></div></div></a></div><div class="card"> <a href="/posts/resource-bottleneck/"><div class="card-body"> <em class="timeago small" data-ts="1552137851" > 2019-03-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>容易成为瓶颈的资源(03)</h3><div class="text-muted small"><p> CPU、内存以及 I/O 三个资源是最容易成为瓶颈的。 CPU 通过 top 命令，观测 CPU 性能； 通过负载，评估 CPU 任务执行的排队情况； 通过 vmstat，看 CPU 的繁忙程度。 top 命令 —— CPU 性能 当进入 top 命令后，按 1 键即可看到每核 CPU 的运行指标和详细性能。 CPU 的使用有多个维度的指标，分别如下： us： ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/design-pattern/" class="btn btn-outline-primary" prompt="上一篇"><p>利用设计模式优化性能（11）</p></a> <a href="/posts/optimization-of-multi-threaded-locks/" class="btn btn-outline-primary" prompt="下一篇"><p>多线程锁的优化（13）</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
