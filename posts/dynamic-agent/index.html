<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="动态代理" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="动态代理，可以在运行时动态创建一个类，实现一个或多个接口。可以在不修改原有类的基础上动态为通过该类获取的对象添加方法、修改行为。" /><meta property="og:description" content="动态代理，可以在运行时动态创建一个类，实现一个或多个接口。可以在不修改原有类的基础上动态为通过该类获取的对象添加方法、修改行为。" /><link rel="canonical" href="/posts/dynamic-agent/" /><meta property="og:url" content="/posts/dynamic-agent/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-09-11T03:34:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="动态代理" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2022-06-05T19:48:36+00:00","datePublished":"2018-09-11T03:34:00+00:00","description":"动态代理，可以在运行时动态创建一个类，实现一个或多个接口。可以在不修改原有类的基础上动态为通过该类获取的对象添加方法、修改行为。","headline":"动态代理","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/dynamic-agent/"},"url":"/posts/dynamic-agent/"}</script><title>动态代理 | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>动态代理</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>动态代理</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1536636840" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-09-11 </em> </span> <span> 更新于 <em class="timeago" data-ts="1654458516" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-06-06 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4201 字"> <em>23 分钟</em>阅读</span></div></div></div><div class="post-content"><p>动态代理，可以在运行时动态创建一个类，实现一个或多个接口。可以在不修改原有类的基础上动态为通过该类获取的对象添加方法、修改行为。</p><p>这个特性被广泛的应用于各种系统程序、框架和库中，比如 Spring、Hibernate、MyBatis、Guice 等。</p><p>动态代理是实现面向切面编程 AOP（Aspect Oriented Programming）的基础。切面的栗子有日志、性能监控、权限检查、数据库事务等，它们在程序的很多地方都会用到。代码也都差不多，但与某个具体的业务逻辑关系也不太密切，如果在每个用到的地方都写，代码会很冗余，也难以维护、AOP 将这些切面与主体业务逻辑分开，代码简单优雅很多。</p><p>理解动态代理之前，首先要了解<strong>静态代理</strong>。</p><h2 id="静态代理"><span class="mr-2">静态代理</span><a href="#静态代理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>代理是一个比较通用的词，作为一个软件模式，它在《设计模式》中被提出，基本概念和日常生活中的概念是类似的。</p><p>代理背后一般至少有一个实际对象，并且代理的外部功能和实际对象一般是一样的。</p><p>用户与代理打交道，不直接接触实际对象。虽然外部功能和实际对象一样，但代理的价值如下：</p><ol><li>节省成本<li>执行权限检查，代理检查权限后，再调用实际对象；<li>屏蔽网络差异和复杂性，代理在本地，而实际对象在其他服务器上，调用本地代理时，本地代理请求其他服务器。</ol><p>代理模式的代码非常</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleStaticProxyDemo</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">IService</span> <span class="o">{</span>
        <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RealService</span> <span class="kd">implements</span> <span class="nc">IService</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello World"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TraceProxy</span> <span class="kd">implements</span> <span class="nc">IService</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">SimpleStaticProxyDemo</span><span class="o">.</span><span class="na">IService</span> <span class="n">realService</span><span class="o">;</span>

        <span class="nc">TraceProxy</span><span class="o">(</span><span class="nc">IService</span> <span class="n">realService</span><span class="o">){</span>
            <span class="k">this</span><span class="o">.</span><span class="na">realService</span> <span class="o">=</span> <span class="n">realService</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"entering sayHello!"</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">realService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"leaving sayHello!"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">IService</span> <span class="n">realService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RealService</span><span class="o">();</span>
        <span class="nc">IService</span> <span class="n">proxyService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TraceProxy</span><span class="o">(</span><span class="n">realService</span><span class="o">);</span>
        <span class="n">proxyService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>代理和实际的对象一般都有相同的接口，在这个栗子中，共同的接口就是 IService，实际对象就是 RealService，代理 TraceProxy. TraceProxy 内部有一个 IService 的成员变量，指向实际对象，在构造方法中被初始化，对于方法 sayHello 的调用，它转发给了实际对象，在调用前后输出了一些跟踪调试信息，上面代码的输出为：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>entering sayHello!
Hello World
leaving sayHello!
</pre></table></code></div></div><blockquote><p>设计模式中的适配器模式和装饰器模式，它们与代理模式有些相似，它们的背后都有一个实际对象，都是通过组合的方式执行该对象。不同之处在于：</p><ul><li>适配器模式时提供了一个不一样的新接口；<li>装饰器模式是对原接口起到了“装饰”作用，可能是增加了新接口、修改了原有的行为；<li>代理模式一般不改变接口</ul></blockquote><p>上面的代码，想要达到的目的是在实际对象的方法调用前后加一些跟踪语句。为了在不修改原类的情况下达到这个目的，在代码中创建了一个代理类 TraceProxy，由于它的代码在写程序时是固定的，所以称为静态代理。</p><p>输出跟踪调式信息是一个通用的，可以想象，如果每个类都需要，有不希望修改类定义，就需要为每个类创建代理，实现所有接口，这个工作就太繁琐。如果再有其他的切面要求，整个工作可能又要重来一遍。此时，就需<strong>动态代理。</strong></p><h2 id="java-sdk-动态代理"><span class="mr-2">Java SDK 动态代理</span><a href="#java-sdk-动态代理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="用法"><span class="mr-2">用法</span><a href="#用法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>在静态代理中，代理类是直接定义在代码中的；</p><p>在动态代理中，代理类是动态生成的，如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleJDKDynamicProxyDemo</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">IService</span> <span class="o">{</span>
        <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RealService</span> <span class="kd">implements</span> <span class="nc">IService</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SimpleInvocationHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">Object</span> <span class="n">realObject</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">SimpleInvocationHandler</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">realObject</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">realObject</span> <span class="o">=</span> <span class="n">realObject</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"entering "</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">);</span>
            <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">realObject</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"leaving "</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">IService</span> <span class="n">realService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RealService</span><span class="o">();</span>
        <span class="nc">IService</span> <span class="n">proxyService</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IService</span><span class="o">)</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
                <span class="nc">IService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]{</span>
                        <span class="nc">IService</span><span class="o">.</span><span class="na">class</span>
                <span class="o">},</span>
                <span class="k">new</span> <span class="nf">SimpleInvocationHandler</span><span class="o">(</span><span class="n">realService</span><span class="o">));</span>
        <span class="n">proxyService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>上面代码中，IService 和 RealService 的定义不变，程序的输出也没什么改变，但代理对象 proxyService 的创建方式变量，它使用 java.lang.reflect 包中的 Proxy 类的静态方法 newProxyInstance 来创建代理对象，这个方法的声明如下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> public static Object newProxyInstance<span class="o">(</span>ClassLoader loader, Class&lt;?&gt;[] interfaces,InvocationHandler h<span class="o">)</span>throws IllegalArgumentException<span class="o">{}</span>
</pre></table></code></div></div><p>它有三个参数，具体如下：</p><ul><li>loader ，类加载器；<li>interface，代理类要实现的接口列表，是一个数组，<strong>元素的类型只能是接口</strong>，不能是不同的类；<li>h 的类型为 InvocationHandler，是一个接口，定义在 java.lang.reflect 包中，只定义了一个 invoke()，对代理接口所有方法的调用都会转给该方法；</ul><p>newProxyInstance 的返回值类型 Object，可以强制转换为 interfaces 数组中的某个接口类型。这里强制转换为 IService 类型，需要注意的是，它不能强制转换为某个类型，比如 RealService，即使它的实际代理的对象类型为 RealService。</p><p>SimpleInvocationHandler 实现了 InvocationHandler ，它的构造方法接受一个参数，realObj 标识被代理的对象，invoke 方法处理所有的接口调用，它有三个参数：</p><ol><li>Proxy，代理对象本身，需要注意的是：它并不是被代理的对象，这个参数一般用处不大；<li>method ，正在被调用的方法；<li>args ，方法的参数。</ol><p>SimpleInvocationHandler 的 invoke 实现中，调用了 method 的 invoke 方法，传递了实际对象 realObject 作为参数，达到了调用实际对象对应方法的目的，在调用任何方法前后，输出了跟踪调试语句。</p><p>需要注意的是，不能将 Proxy（代理类） 作为参数传递给 method.invoke，比如：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">realObject</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</pre></table></code></div></div><p>上面的语句会出现死循环，因为 proxy 表示当前代理对象，这又会调用到 SimpleInvocationHanlder 的 invoke 方法。</p><h3 id="基本原理"><span class="mr-2">基本原理</span><a href="#基本原理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>上面代码中，创建 proxyService 的代码可以用下面的代码代替：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">proxyClass</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">getProxyClass</span><span class="o">(</span><span class="nc">IService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]{</span><span class="nc">IService</span><span class="o">.</span><span class="na">class</span><span class="o">});</span>
        
        <span class="nc">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">ctor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ctor</span> <span class="o">=</span> <span class="n">proxyClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]{</span><span class="nc">InvocationHandler</span><span class="o">.</span><span class="na">class</span><span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">InvocationHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleInvocationHandler</span><span class="o">(</span><span class="n">realService</span><span class="o">);</span>
        <span class="nc">IService</span> <span class="n">proxyService2</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">proxyService</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IService</span><span class="o">)</span><span class="n">ctor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

</pre></table></code></div></div><p>分为三步：</p><ol><li>通过 Proxy.getProxyClass 创建代理类定义，类定义会被缓存；<li>获取代理类的构造方法，构造方法有一个 InvocationHandler 类型的参数；<li>创建 InvocationHandler 对象，创建代理类对象</ol><p>Proxy.getProxyClass 需要两个参数，一个是 ClassLoader；另一个是接口数组。它会动态生成一个类，类名 以 $Proxy 开头，后面跟了一个数字。</p><p>$Proxy 的父类是 Proxy，它有一个构造方法，接受一个 InvocationHanlder 类型的参数，保存了实例变量 h，h 定义在父类 Proxy 中，它实现了接口 IService ，对于每个方法，比如 sayHello，它调用了 InvocationHanlder 的 invoke 方法，对于 Object 中的方法，如 hashCode、equals 和 toString，$Proxy 同样转发给了 InvocationHanlder。</p><p>可以看出，这个类定义本身与被代理的对象没有关系，与 InvocationHandler 的具体实现也没有关系，而主要与接口数组有关，给定这个接口数组，它动态创建每个接口的实现代码，实现就是转发给 InvocationHandler ，与被代理对象的关系以及对它的调用由 InvocationHandler 的实现。</p><p>对于 Oracle 的 JVM， $Proxy 的定义可以通过下面的命令看到：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>java <span class="nt">-Dsun</span>.misc.ProxyGenerator.saveGeneratedFiles<span class="o">=</span><span class="nb">true </span>cn.happymaya.dynamic.agent.SimpleJDKDynamicProxyDemo
</pre></table></code></div></div><p>以上命令会把动态生成的代理类 $Proxy() 保存到文件 $Proxy.class 中，通过反编译工具比如 <a href="http://jd.benow.ca/">D-GUI</a> 就可以得到源码。</p><p>由此可以，代理类的定义，就是获取构造方法，创建代理对象。</p><h3 id="动态代理的优点"><span class="mr-2">动态代理的优点</span><a href="#动态代理的优点" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>相比于静态代理，动态代理看起来麻烦很多。但是它的好处如下：<strong>使用动态代理，可以编写通用的代理逻辑，用于各种类型的被代理对象，而不需要为每个被代理的类型都创建一个静态代理类。</strong></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GeneralProxyDemo</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">IServiceA</span> <span class="o">{</span>
        <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ServiceAImpl</span> <span class="kd">implements</span> <span class="nc">IServiceA</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">IServiceB</span> <span class="o">{</span>
        <span class="kt">void</span> <span class="nf">fly</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ServiceBImpl</span> <span class="kd">implements</span> <span class="nc">IServiceB</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fly</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"flying"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SimpleInvocationHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">Object</span> <span class="n">realObject</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">SimpleInvocationHandler</span><span class="o">(</span><span class="nc">Object</span> <span class="n">realObject</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">realObject</span> <span class="o">=</span> <span class="n">realObject</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"entering "</span> <span class="o">+</span> <span class="n">realObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"::"</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">realObject</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"leaving "</span> <span class="o">+</span> <span class="n">realObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"::"</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">intf</span><span class="o">,</span> <span class="no">T</span> <span class="n">realObject</span><span class="o">){</span>
        <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span><span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">intf</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]{</span><span class="n">intf</span><span class="o">},</span> <span class="k">new</span> <span class="nc">SimpleInvocationHandler</span><span class="o">(</span><span class="n">realObject</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"########################################"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"##                                    ##"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"##        General dynamic proxy       ##"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"##                                    ##"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"########################################"</span><span class="o">);</span>

        <span class="nc">IServiceA</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceAImpl</span><span class="o">();</span>
        <span class="nc">IServiceA</span> <span class="n">aProxy</span> <span class="o">=</span> <span class="n">getProxy</span><span class="o">(</span><span class="nc">IServiceA</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
        <span class="n">aProxy</span><span class="o">.</span><span class="na">sayHello</span><span class="o">();;</span>

        <span class="nc">IServiceB</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceBImpl</span><span class="o">();</span>
        <span class="nc">IServiceB</span> <span class="n">bProxy</span> <span class="o">=</span> <span class="n">getProxy</span><span class="o">(</span><span class="nc">IServiceB</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
        <span class="n">bProxy</span><span class="o">.</span><span class="na">fly</span><span class="o">();;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>在这个栗子中，有两个接口 IServiceA 和 IServiceB ，它们对应的实现类是 ServiceAImpl 和 ServiceBImpl ，虽然它们的接口和实现不同，但利用动态代理，它们可以调用通用的方法 getProxy 获取代理对象，共享同样的代理逻辑 SimpleInvocationHandler，即在每个方法调用前后输出一条跟踪调试语句：程序输出为：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>entering ServiceAImpl::sayHello
hello
leaving ServiceAImpl::sayHello
entering ServiceBImpl::fly
flying
leaving ServiceBImpl::fly
</pre></table></code></div></div><h2 id="cglib-动态代理"><span class="mr-2">CGLIB 动态代理</span><a href="#cglib-动态代理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Java SDK 动态代理的缺点是：只能为接口创建代理，返回的代理对象也只能转换到某个接口类型。</p><p>如果一个类没有接口，或者希望代理非接口中定义的方法，这就没有办法了。</p><p>有一个三方类库 <a href="https://github.com/cglib/cglib">CGLIB(Code Generation Library)</a>，可以做到上面一点，Spring、Hibernate 等都使用该类库。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleCGLIBDemo</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RealService</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SimpleInterceptor</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">objects</span><span class="o">,</span> <span class="nc">MethodProxy</span> <span class="n">methodProxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"entering "</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">);</span>
            <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">methodProxy</span><span class="o">.</span><span class="na">invokeSuper</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">objects</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"leaving "</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">cls</span><span class="o">){</span>
        <span class="nc">Enhancer</span> <span class="n">enhancer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Enhancer</span><span class="o">();</span>
        <span class="n">enhancer</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
        <span class="n">enhancer</span><span class="o">.</span><span class="na">setCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleInterceptor</span><span class="o">());</span>
        <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">enhancer</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RealService</span> <span class="n">proxyService</span> <span class="o">=</span> <span class="n">getProxy</span><span class="o">(</span><span class="nc">RealService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">proxyService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>RealService 表示被代理的类，它没有接口。getProxy() 为一个类生成代理对象，这个代理对象可以安全地转换为被代理类的类型，它使用了 CGLIB 的 Enhancer 类。Enhancer 类的 setSuperClass 设置被代理的类，setCallBack 设置被代理类的 public 非 final 方法被调用时的处理类。Enhancer 支持多种类型，这里使用的类实现了 MethodInterceptor 接口，它与 Java SDK 中的 InvocationHandler 有点类似，方法名变成了 intercept，多了一个 MethodProxy 类型的参数。</p><p>与前面的 InvocationHandler 不同，SimpleInterceptor 中没有被代理的对象，它通过 MethodProxy 的 invokeSuper 方法调用被代理类的方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">methodProxy</span><span class="o">.</span><span class="na">invokeSuper</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">objects</span><span class="o">);</span>
</pre></table></code></div></div><p>不过，它不能这样调用被代理类的方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">methodProxy</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</pre></table></code></div></div><p>object 是代理对象，调用这个方法还会调用到 SimpleInterceptor 的 intercept 方法，造成死循环。</p><p>在 main 方法中，也没有创建被代理的对象，创建的对象直接就是代理对象。</p><p>CGLIB 的实现机制与 Java SDK 不同，是通过继承实现的。也是动态创建了一个类，但这个类的父类是被代理的类，代理类重写了父类的所有 public 非 final 方法，改为调用 Callback 中的相关方法。上面代码中，调用 SimpleInterceptor 的 intercept 方法。</p><h2 id="java-sdk-代理与-cglib-代理的比较"><span class="mr-2">Java SDK 代理与 CGLIB 代理的比较</span><a href="#java-sdk-代理与-cglib-代理的比较" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>Java SDK 代理面向的是一组接口。</strong>它为这些接口动态创建了一个实现类。接口的具体实现逻辑是通过自定义的 InvocationHandler 实现的，这个实现是自定义的，也就是说，<strong>其背后都不一定有真正被代理的对象，也可能有多个实际对象，根据情况动态选择。CGLIB 代理面向的是一个具体的类，</strong>它动态创建了一个新类，继承了该类，重写了其方法。</p><p>从代理的角度看，<strong>Java SDK 代理的是对象，</strong>需要先有一个实际对象，自定义的 InvocationHandler 引用该对象，然后创建一个代理类和代理对象，客户端访问的是代理对象，代理对象最后再调用实际对象的方法；<strong>CGLIB 代理的是类</strong>，创建的对象只有一个。</p><p>如果目的都是为一个类的方法增强功能，Java SDK 要求该类要求必须有接口，且只能处理接口中的方法，CGLIB 没有这个限制。</p><h2 id="动态代理的应用aop"><span class="mr-2">动态代理的应用：AOP</span><a href="#动态代理的应用aop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>利用 CGLIB 动态代理，可以实现一个极简单的 AOP 框架，从而学习了解 AOP 的基本思想和技术。</p><h3 id="用法-1"><span class="mr-2">用法</span><a href="#用法-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li><p>添加一个新的注解<code class="language-plaintext highlighter-rouge">@Aspect</code>，其定义为：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Retention</span><span class="o">(</span><span class="no">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="no">TYPE</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Aspect</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">value</span><span class="o">();</span>
<span class="o">}</span>
   
</pre></table></code></div></div><li><p>约定，切面类可以声明三个方法 before/after/exception，在主体类的方法 <strong>调用前/调用后/出现异常时</strong> 分别调用这三个方法，这三个方法的声明符合如下参数：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{}</span>
   
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">result</span><span class="o">)</span> <span class="o">{}</span>
   
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">exception</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
</pre></table></code></div></div><li><p><code class="language-plaintext highlighter-rouge">@Aspect</code>主要用于注解切面类，它有一个参数，可以指定要增强的类，比如：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@Aspect</span><span class="o">({</span><span class="nc">ServiceA</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="nc">ServiceB</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLogAspect</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
                <span class="s">"entering "</span>
                        <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">"::"</span>
                        <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">", args: "</span>
                        <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
        <span class="o">);</span>
    <span class="o">}</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
                <span class="s">"leaving "</span>
                        <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">"::"</span>
                        <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">", result: "</span>
                        <span class="o">+</span> <span class="n">result</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
   
</pre></table></code></div></div><p>ServiceLogAspect 就是一个切面，它负责 ServiceA 和 ServiceB 的日志切面，即为这两个增加日志功能。</p><p>目的是在类 ServiceA 和 ServiceB 所有方法的执行前后增加一些日志，而 ExceptionAspect 的目的是在类 ServiceB 的方法执行出现异常时收到通知并输出一些信息。</p><p><strong>它们都没有修改类 ServiceA 和 ServiceB 本身，本身做的事是比较通用的，与 ServiceA 和 ServiceB 的具体逻辑关系也不密切，但又想改变 ServiceA/ServiceB 的行为，这就是 AOP 的思维。</strong></p><li><p>异常切面，负责类的异常切面</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Aspect</span><span class="o">({</span><span class="nc">ServiceB</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExceptionAspect</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">exception</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"exception when calling: "</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>object、method 和 args 与 CGLIB MethodInterceptor 中的 invoke 参数一样，after 中的 result 表示方法执行的结果，exception 中的 e 表示发生的异常类型。</p><p>ExceptionAspect 只实现 exception 方法，在异常发生的时候，会输出一些信息。</p><li><p>只是声明一个切面类是不起作用的，还需要和 DI 容器结合起来，实现一个新的容器 CGLibContaier ，有一个方法如下：</p><p>通过该方法获取 ServiceA 和 ServiceB ，它们的行为就会被改变。</p><p>通过 CGLibContaier 获取 ServiceA，会自动应用 ServiceLogAspect，比如：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">ServiceA</span> <span class="n">a</span> <span class="o">=</span> <span class="nc">CGLibContaier</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">ServiceA</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></table></code></div></div><p>输出为：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>entering ServiceA::callB, args: <span class="o">{}</span>
entering ServiceB::action, args: <span class="o">{}</span>
I<span class="s1">'m B
leaving ServiceB::action, result: null
leaving ServiceA::callB, result:null
</span></pre></table></code></div></div></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/base/'>Base</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/dynamic-agent/" class="post-tag no-text-decoration" >dynamic agent</a> <a href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" class="post-tag no-text-decoration" >动态代理</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=动态代理 - ThinkerWalker&amp;url=/posts/dynamic-agent/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=动态代理 - ThinkerWalker&amp;u=/posts/dynamic-agent/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/dynamic-agent/&amp;text=动态代理 - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/reflect/"><div class="card-body"> <em class="timeago small" data-ts="1536896040" > 2018-09-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>反射</h3><div class="text-muted small"><p> 利用 Java 中的一些特性，包括反射、注解、动态代理、类加载器等，可以优雅地实现一些灵活通用的功能，它们经常用于各种框架、库以及系统程序中。 例如 Jackson，利用反射和注解实现了通用的序列化机制； Spring MVC、Jersey 用于处理 Web 请求，利用反射和注解，可以方便地将用户的请求参数和内容转换为 Java 对象，将 Java 对象转变为响应内容； Sp...</p></div></div></a></div><div class="card"> <a href="/posts/annotation/"><div class="card-body"> <em class="timeago small" data-ts="1537068840" > 2018-09-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>注解</h3><div class="text-muted small"><p> 在 Java中，注解就是给程序添加一些信息，用字符@开头，这些信息用于修饰它后面紧挨着的其他代码元素，比如：类、接口、字段、方法、方法中的参数、构造方法等。注解可以被编译器、程序运行时和其他工具使用，用于增强或修改程序行为等。 内置注解 @Override Java 内置了一些常用注解：@Override、@Deprecated、@SuppressWarnings。 @Overrid...</p></div></div></a></div><div class="card"> <a href="/posts/classloader-base/"><div class="card-body"> <em class="timeago small" data-ts="1541302440" > 2018-11-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>类加载机制</h3><div class="text-muted small"><p> 类加载器（ClassLoader）就是加载其他类的类，负责将字节码文件加载到内存，创建 Class 对象。与反射、注解和动态代理一样，在大部分的应用编程中，需要自己实现 ClassLoader。 不过，理解类加载的机制和过程，有助于更好地理解反射、注解和动态代理。比如在反射中的 Class 的静态方法 Class.forName。 ClassLoader，一般是系统提供的，不需要自己实现...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/tools/" class="btn btn-outline-primary" prompt="上一篇"><p>常用开发工具总结</p></a> <a href="/posts/reflect/" class="btn btn-outline-primary" prompt="下一篇"><p>反射</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
