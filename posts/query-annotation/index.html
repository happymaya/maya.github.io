<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Spring Data JPA - @Query" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="新增一个 @Query 的方法，快速体验一下 @Query 的使用方法，如下所示： ```java package com.example.jpa.example1; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.jpa.repository.Query; import org.springframework.data.repository.query.Param;" /><meta property="og:description" content="新增一个 @Query 的方法，快速体验一下 @Query 的使用方法，如下所示： ```java package com.example.jpa.example1; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.jpa.repository.Query; import org.springframework.data.repository.query.Param;" /><link rel="canonical" href="/posts/query-annotation/" /><meta property="og:url" content="/posts/query-annotation/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-03T15:33:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spring Data JPA - @Query" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2022-07-23T23:06:17+00:00","datePublished":"2020-09-03T15:33:00+00:00","description":"新增一个 @Query 的方法，快速体验一下 @Query 的使用方法，如下所示： ```java package com.example.jpa.example1; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.jpa.repository.Query; import org.springframework.data.repository.query.Param;","headline":"Spring Data JPA - @Query","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/query-annotation/"},"url":"/posts/query-annotation/"}</script><title>Spring Data JPA - @Query | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Spring Data JPA - @Query</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Spring Data JPA - @Query</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1599147180" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-09-03 </em> </span> <span> 更新于 <em class="timeago" data-ts="1658617577" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-07-24 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3694 字"> <em>20 分钟</em>阅读</span></div></div></div><div class="post-content"><p>新增一个 @Query 的方法，快速体验一下 @Query 的使用方法，如下所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.example.jpa.example1</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.query.Param</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDtoRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

   <span class="c1">//通过query注解根据name查询user信息</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"From User where name=:name"</span><span class="o">)</span>
   <span class="nc">User</span> <span class="nf">findByQuery</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">nameParam</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>然后，新增一个测试类：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.example.jpa.example1</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest</span><span class="o">;</span>

<span class="nd">@DataJpaTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryQueryTest</span> <span class="o">{</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">UserDtoRepository</span> <span class="n">userDtoRepository</span><span class="o">;</span>

   <span class="nd">@Test</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQueryAnnotation</span><span class="o">()</span> <span class="o">{</span>
       
       <span class="c1">// 新增一条数据方便测试</span>
       <span class="c1">// userDtoRepository.save(User.builder().name("jackxx").email("123456@126.com").sex("man").address("shanghai").build());</span>
       
       <span class="c1">//调用上面的方法查看结果</span>
       <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">findByQuery</span><span class="o">(</span><span class="s">"jack"</span><span class="o">);</span>
       <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user2</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>运行的结果如下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Hibernate: insert into user <span class="o">(</span>address, email, name, sex, version, <span class="nb">id</span><span class="o">)</span> values <span class="o">(</span>?, ?, ?, ?, ?, ?<span class="o">)</span>

Hibernate: <span class="k">select </span>user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_, user0_.version as version6_0_ from user user0_ where user0_.name<span class="o">=</span>?

User<span class="o">(</span><span class="nb">id</span><span class="o">=</span>1, <span class="nv">name</span><span class="o">=</span>jack, <span class="nv">email</span><span class="o">=</span>123456@126.com, <span class="nv">version</span><span class="o">=</span>0, <span class="nv">sex</span><span class="o">=</span>man, <span class="nv">address</span><span class="o">=</span>shanghai<span class="o">)</span>

</pre></table></code></div></div><p>通过上面发现，这次不是通过方法名来生成查询语法，而是<code class="language-plaintext highlighter-rouge">@Query 注解</code>在其中起了作用，使 <code class="language-plaintext highlighter-rouge">From User where name=:name"JPQL</code> 生效了。</p><h2 id="query-的基本用法"><span class="mr-2">Query 的基本用法</span><a href="#query-的基本用法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>@Query 用法是使用 JPQL 为实体创建声明式查询方法。</p><p>注解源码:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">})</span>
<span class="nd">@QueryAnnotation</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Query</span> <span class="o">{</span>

   <span class="cm">/**
   * 指定JPQL的查询语句。（nativeQuery=true的时候，是原生的Sql语句）
   */</span>
   <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">"
   /**
   * 指定count的JPQL语句，如果不指定将根据query自动生成。（如果当nativeQuery=true的时候，指的是原生
   * 的Sql语句）
   */
   String countQuery() default "</span>
   <span class="cm">/**
   * 根据哪个字段来count，一般默认即可。
   */</span>
   <span class="nc">String</span> <span class="nf">countProjection</span><span class="o">()</span> <span class="k">default</span> <span class="s">"
   /**
   * 默认是false，表示value里面是不是原生的sql语句
   */
   boolean nativeQuery() default false
   /**
   * 可以指定一个query的名字，必须唯一的。
   * 如果不指定，默认的生成规则是：{$domainClass}.${queryMethodName}
   */
   String name() default "</span>
   <span class="cm">/**
   * 可以指定一个count的query的名字，必须唯一的。
   * 如果不指定，默认的生成规则是：{$domainClass}.${queryMethodName}.count
   */</span>
   <span class="nc">String</span> <span class="nf">countName</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>一般只需要关心 @Query 里面的 value 和 nativeQuery、countQuery 的值即可，因为其他的不常用。</p><p>使用声明式 JPQL 查询有个好处，就是启动的时候就知道语法正确不正确。</p><h3 id="jpql-语法"><span class="mr-2">JPQL 语法。</span><a href="#jpql-语法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="p">...</span> <span class="k">FROM</span> <span class="p">...</span>
<span class="p">[</span><span class="k">WHERE</span> <span class="p">...]</span>
<span class="p">[</span><span class="k">GROUP</span> <span class="k">BY</span> <span class="p">...</span> <span class="p">[</span><span class="k">HAVING</span> <span class="p">...]]</span>
<span class="p">[</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="p">...]</span>
</pre></table></code></div></div><p>它的语法结构类似 SQL，唯一的区别就是 JPQL FROM 后面跟的是对象，而 SQL 里面的字段对应的是对象里面的属性字段。</p><p>update 和 delete 的语法结构：</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">DELETE</span> <span class="k">FROM</span> <span class="p">...</span> <span class="p">[</span><span class="k">WHERE</span> <span class="p">...]</span>
<span class="k">UPDATE</span> <span class="p">...</span> <span class="k">SET</span> <span class="p">...</span> <span class="p">[</span><span class="k">WHERE</span> <span class="p">...]</span>
</pre></table></code></div></div><p>其中 “…” 省略的部分是实体对象名字和实体对象里面的字段名字。</p><h2 id="query-用法案例"><span class="mr-2">@Query 用法案例</span><a href="#query-用法案例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>案例 1： 要在 Repository 的查询方法上声明一个注解，这里就是 @Query 注解标注的地方。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u from User u where u.emailAddress = ?1"</span><span class="o">)</span>
   <span class="nc">User</span> <span class="nf">findByEmailAddress</span><span class="o">(</span><span class="nc">String</span> <span class="n">emailAddress</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>案例 2： LIKE 查询，注意 firstname 不会自动加上“%”关键字。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u from User u where u.firstname like %?1"</span><span class="o">)</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByFirstnameEndsWith</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstname</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>案例 3： 直接用原始 SQL，nativeQuery = true 即可。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"SELECT * FROM USERS WHERE EMAIL_ADDRESS = ?1"</span><span class="o">,</span> <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
   <span class="nc">User</span> <span class="nf">findByEmailAddress</span><span class="o">(</span><span class="nc">String</span> <span class="n">emailAddress</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>案例 4： 下面是<em>**</em>nativeQuery 的排序错误的写法，会导致无法启动。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select * from user_info where first_name=?1"</span><span class="o">,</span><span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">UserInfoEntity</span><span class="o">&gt;</span> <span class="nf">findByFirstName</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstName</span><span class="o">,</span><span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>案例 5： nativeQuery 排序的正确写法。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select * from user_info where first_name=?1 order by ?2"</span><span class="o">,</span><span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">UserInfoEntity</span><span class="o">&gt;</span> <span class="nf">findByFirstName</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstName</span><span class="o">,</span><span class="nc">String</span> <span class="n">sort</span><span class="o">);</span>

<span class="c1">//调用的地方写法last_name是数据里面的字段名，不是对象的字段名</span>
<span class="n">repository</span><span class="o">.</span><span class="na">findByFirstName</span><span class="o">(</span><span class="s">"jackzhang"</span><span class="o">,</span><span class="s">"last_name"</span><span class="o">);</span>
</pre></table></code></div></div><p>通过上面几个案例，看到了 @Query 的几种用法，就会明白<strong>排序</strong>、<strong>参数</strong>、<strong>使用方法</strong>、<strong>LIKE</strong>、原始 SQL 怎么写。</p><h2 id="query-的排序"><span class="mr-2">@Query 的排序</span><a href="#query-的排序" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>@Query中在用JPQL的时候，想要实现排序，方法上直接用 PageRequest 或者 Sort 参数都可以做到。</p><p>在排序实例中，实际使用的属性需要与实体模型里面的字段相匹配，这意味着它们需要解析为查询中使用的属性或别名。我们看一下例子，这是一个state_field_path_expression JPQL的定义，并且 Sort 的对象支持一些特定的函数。</p><p>案例 6： Sort and JpaSort 的使用，它可以进行排序。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u from User u where u.lastname like ?1%"</span><span class="o">)</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByAndSort</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
   
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u.id, LENGTH(u.firstname) as fn_len from User u where u.lastname like ?1%"</span><span class="o">)</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="nf">findByAsArrayAndSort</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>

<span class="o">}</span>

<span class="c1">//调用方的写法，如下：</span>
<span class="n">repo</span><span class="o">.</span><span class="na">findByAndSort</span><span class="o">(</span><span class="s">"lannister"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Sort</span><span class="o">(</span><span class="s">"firstname"</span><span class="o">));</span>
<span class="n">repo</span><span class="o">.</span><span class="na">findByAndSort</span><span class="o">(</span><span class="s">"stark"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Sort</span><span class="o">(</span><span class="s">"LENGTH(firstname)"</span><span class="o">));</span>
<span class="n">repo</span><span class="o">.</span><span class="na">findByAndSort</span><span class="o">(</span><span class="s">"targaryen"</span><span class="o">,</span> <span class="nc">JpaSort</span><span class="o">.</span><span class="na">unsafe</span><span class="o">(</span><span class="s">"LENGTH(firstname)"</span><span class="o">));</span>
<span class="n">repo</span><span class="o">.</span><span class="na">findByAsArrayAndSort</span><span class="o">(</span><span class="s">"bolton"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Sort</span><span class="o">(</span><span class="s">"fn_len"</span><span class="o">));</span>

</pre></table></code></div></div><h2 id="query-的分页"><span class="mr-2">@Query 的分页</span><a href="#query-的分页" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>@Query 的分页分为两种情况，分别为：</p><ul><li>JPQL 的排序<li>nativeQuery 的排序。</ul><p>案例 7：直接用 Page 对象接受接口，参数直接用 Pageable 的实现类即可。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select u from User u where u.lastname = ?1"</span><span class="o">)</span>
   <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByLastname</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 调用者的写法</span>
<span class="n">repository</span><span class="o">.</span><span class="na">findByFirstName</span><span class="o">(</span><span class="s">"jackzhang"</span><span class="o">,</span><span class="k">new</span> <span class="nc">PageRequest</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">10</span><span class="o">));</span>
</pre></table></code></div></div><p>案例 8：@Query 对原生 SQL 的分页支持，并不是特别友好，因为这种写法比较“骇客”，可能随着版本的不同会有所变化。以 MySQL 为例。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">UserInfoEntity</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;,</span> <span class="nc">JpaSpecificationExecutor</span><span class="o">&lt;</span><span class="nc">UserInfoEntity</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select * from user_info where first_name=?1 /* #pageable# */"</span><span class="o">,</span>
      <span class="n">countQuery</span> <span class="o">=</span> <span class="s">"select count(*) from user_info where first_name=?1"</span><span class="o">,</span> <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>

   <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">UserInfoEntity</span><span class="o">&gt;</span> <span class="nf">findByFirstName</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstName</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//调用者的写法</span>
<span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByFirstName</span><span class="o">(</span><span class="s">"jackzhang"</span><span class="o">,</span><span class="k">new</span> <span class="nc">PageRequest</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span><span class="s">"last_name"</span><span class="o">));</span>

<span class="c1">//打印出来的sql</span>
<span class="n">select</span>  <span class="o">*</span>   <span class="n">from</span>  <span class="n">user_info</span>  <span class="n">where</span>  <span class="n">first_name</span><span class="o">=?</span> <span class="cm">/* #pageable# */</span>  <span class="n">order</span> <span class="n">by</span>  <span class="n">last_name</span> <span class="n">desc</span> <span class="n">limit</span> <span class="o">?,</span> <span class="o">?</span>

</pre></table></code></div></div><p>这里需要注意：这个注释 / #pageable# / 必须有。</p><p>另外，随着版本的变化，这个方法有可能会进行优化。此外还有一种实现方法，就是自己写两个查询方法，自己手动分页。</p><h3 id="param-用法"><span class="mr-2">@Param 用法</span><a href="#param-用法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>@Param 注解指定方法参数的具体名称，通过绑定的参数名字指定查询条件，这样不需要关心参数的顺序。</p><p>比较推荐这种做法，因为它比较利于代码重构。如果不用 @Param 也是可以的，参数是有序的，这使得查询方法对参数位置的重构容易出错。</p><p>案例 9：根据 firstname 和 lastname 参数查询 user 对象</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u from User u where u.firstname = :firstname or u.lastname = :lastname"</span><span class="o">)</span>
   <span class="nc">User</span> <span class="nf">findByLastnameOrFirstname</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"lastname"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"firstname"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">firstname</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>案例 10： 根据参数进行查询，top 10 前面说的“query method”关键字照样有用，如下所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u from User u where u.firstname = :firstname or u.lastname = :lastname"</span><span class="o">)</span>
  <span class="nc">User</span> <span class="nf">findTop10ByLastnameOrFirstname</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"lastname"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">lastname</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"firstname"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">firstname</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p><strong>在通过 @Query 定义自己的查询方法时，建议用 Spring Data JPA 的 name query 的命名方法，这样下来风格就比较统一了。</strong></p><h2 id="query-之-projections-应用返回指定-dto"><span class="mr-2">@Query 之 Projections 应用返回指定 DTO</span><a href="#query-之-projections-应用返回指定-dto" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>在之前的例子的基础上新增一张表 UserExtend，里面包含身份证、学号、年龄等信息，最终实体变成如下模样：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserExtend</span> <span class="o">{</span> <span class="c1">//用户扩展信息表</span>

   <span class="nd">@Id</span>
   <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">Long</span> <span class="n">userId</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">idCard</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">ages</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">studentNumber</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span> <span class="c1">//用户基本信息表</span>

   <span class="nd">@Id</span>
   <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

   <span class="nd">@Version</span>
   <span class="kd">private</span> <span class="nc">Long</span> <span class="n">version</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">sex</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>如果想定义一个 DTO 对象，里面只要 name、email、idCard，这种场景非常常见，但好多人使用的都不是最佳实践，这里介绍几种方式做一下对比。</p><p>先看一下，刚学 JPA 的时候别手别脚的写法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDtoRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

   <span class="cm">/**
    * 查询用户表里面的name、email和UserExtend表里面的idCard
    * @param id
    * @return
    */</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u.name,u.email,e.idCard from User u,UserExtend e where u.id= e.userId and u.id=:id"</span><span class="o">)</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="nf">findByUserId</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>通过下面的测试用例来取上面 findByUserId 方法返回的数据组结果值，再塞到 DTO 里面，代码如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQueryAnnotation</span><span class="o">()</span> <span class="o">{</span>
   <span class="c1">// 新增一条用户数据  userDtoRepository.save(User.builder().name("jack").email("123456@126.com").sex("man").address("shanghai").build());</span>
   <span class="c1">//再新增一条和用户一对一的UserExtend数据  userExtendRepository.save(UserExtend.builder().userId(1L).idCard("shengfengzhenghao").ages(18).studentNumber("xuehao001").build());</span>
   <span class="c1">// 查询想要的结果</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">userArray</span> <span class="o">=</span> <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">userArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">])+</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">userArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)[</span><span class="mi">1</span><span class="o">]));</span>
   <span class="nc">UserDto</span> <span class="n">userDto</span> <span class="o">=</span> <span class="nc">UserDto</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">userArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">])).</span><span class="na">build</span><span class="o">();</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userDto</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><p>其实经验的丰富的老司机一看就知道这肯定不是最佳实践，这多麻烦呀，肯定会有更优解。那么再对此稍加改造，用 UserDto 接收返回结果。</p><h3 id="利用-class-userdto-获取想要的结果"><span class="mr-2">利用 class UserDto 获取想要的结果</span><a href="#利用-class-userdto-获取想要的结果" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>新建一个 UserDto 类的内容。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.example.jpa.example1</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDto</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span><span class="n">email</span><span class="o">,</span><span class="n">idCard</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>利用 @Query 在 Repository 里面怎么写。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDtoRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select new com.example.jpa.example1.UserDto(CONCAT(u.name,'JK123'),u.email,e.idCard) from User u,UserExtend e where u.id= e.userId and u.id=:id"</span><span class="o">)</span>
   <span class="nc">UserDto</span> <span class="nf">findByUserDtoId</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>利用 JPQL，new 了一个 UserDto；再通过构造方法，接收查询结果。其中会发现，用 CONCAT 的关键字做了一个字符串拼接，可以查看 JPQL 的 Oracal 文档，也可以通过源码来看支持的关键字有哪些。</p><p>首先，打开 ParameterizedFunctionExpression 会发现 Hibernate 支持的关键字有这么多，都是 MySQL 数据库的查询关键字。</p><p>写一个测试方法，调用上面的方法测试一下。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQueryAnnotationDto</span><span class="o">()</span> <span class="o">{</span>
   <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"jack"</span><span class="o">).</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">).</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">).</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span><span class="n">userExtendRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">UserExtend</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">idCard</span><span class="o">(</span><span class="s">"shengfengzhenghao"</span><span class="o">).</span><span class="na">ages</span><span class="o">(</span><span class="mi">18</span><span class="o">).</span><span class="na">studentNumber</span><span class="o">(</span><span class="s">"xuehao001"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
   <span class="nc">UserDto</span> <span class="n">userDto</span> <span class="o">=</span> <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">findByUserDtoId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userDto</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><p>最后，运行一下测试用例，结果如下。这时会发现，按照预期操作得到了 UserDto 的结果。.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nl">Hibernate:</span> <span class="n">insert</span> <span class="n">into</span> <span class="nf">user</span> <span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">email</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">sex</span><span class="o">,</span> <span class="n">version</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span> <span class="n">values</span> <span class="o">(?,</span> <span class="o">?,</span> <span class="o">?,</span> <span class="o">?,</span> <span class="o">?,</span> <span class="o">?)</span>
<span class="nl">Hibernate:</span> <span class="n">insert</span> <span class="n">into</span> <span class="nf">user_extend</span> <span class="o">(</span><span class="n">ages</span><span class="o">,</span> <span class="n">id_card</span><span class="o">,</span> <span class="n">student_number</span><span class="o">,</span> <span class="n">user_id</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span> <span class="n">values</span> <span class="o">(?,</span> <span class="o">?,</span> <span class="o">?,</span> <span class="o">?,</span> <span class="o">?)</span>
<span class="nl">Hibernate:</span> <span class="n">select</span> <span class="o">(</span><span class="n">user0_</span><span class="o">.</span><span class="na">name</span><span class="o">||</span><span class="err">'</span><span class="no">JK123</span><span class="err">'</span><span class="o">)</span> <span class="n">as</span> <span class="n">col_0_0_</span><span class="o">,</span> <span class="n">user0_</span><span class="o">.</span><span class="na">email</span> <span class="n">as</span> <span class="n">col_1_0_</span><span class="o">,</span> <span class="n">userextend1_</span><span class="o">.</span><span class="na">id_card</span> <span class="n">as</span> <span class="n">col_2_0_</span> <span class="n">from</span> <span class="n">user</span> <span class="n">user0_</span> <span class="n">cross</span> <span class="n">join</span> <span class="n">user_extend</span> <span class="n">userextend1_</span> <span class="n">where</span> <span class="n">user0_</span><span class="o">.</span><span class="na">id</span><span class="o">=</span><span class="n">userextend1_</span><span class="o">.</span><span class="na">user_id</span> <span class="n">and</span> <span class="n">user0_</span><span class="o">.</span><span class="na">id</span><span class="o">=?</span>
<span class="nc">UserDto</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="n">jackJK123</span><span class="o">,</span> <span class="n">email</span><span class="o">=</span><span class="mi">123456</span><span class="err">@</span><span class="mi">126</span><span class="o">.</span><span class="na">com</span><span class="o">,</span> <span class="n">idCard</span><span class="o">=</span><span class="n">shengfengzhenghao</span><span class="o">)</span>
</pre></table></code></div></div><h3 id="利用-userdto-接口获得想要的结果"><span class="mr-2">利用 UserDto 接口获得想要的结果</span><a href="#利用-userdto-接口获得想要的结果" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>新增一个 UserSimpleDto 接口来得到想要的 name、email、idCard 信息。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.example.jpa.example1</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserSimpleDto</span> <span class="o">{</span>
   <span class="nc">String</span> <span class="nf">getName</span><span class="o">();</span>
   <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">();</span>
   <span class="nc">String</span> <span class="nf">getIdCard</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>其次，在 UserDtoRepository 里面新增一个方法，返回结果是 UserSimpleDto 接口。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDtoRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="c1">//利用接口DTO获得返回结果，需要注意的是每个字段需要as和接口里面的get方法名字保持一样</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select CONCAT(u.name,'JK123') as name,UPPER(u.email) as email ,e.idCard as idCard from User u,UserExtend e where u.id= e.userId and u.id=:id"</span><span class="o">)</span>
   <span class="nc">UserSimpleDto</span> <span class="nf">findByUserSimpleDtoId</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>然后，测试用例写法如下。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQueryAnnotationDto</span><span class="o">()</span> <span class="o">{</span>
   <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"jack"</span><span class="o">).</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">).</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">).</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span><span class="n">userExtendRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">UserExtend</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">idCard</span><span class="o">(</span><span class="s">"shengfengzhenghao"</span><span class="o">).</span><span class="na">ages</span><span class="o">(</span><span class="mi">18</span><span class="o">).</span><span class="na">studentNumber</span><span class="o">(</span><span class="s">"xuehao001"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
   <span class="nc">UserSimpleDto</span> <span class="n">userDto</span> <span class="o">=</span> <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">findByUserSimpleDtoId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userDto</span><span class="o">);</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userDto</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">":"</span><span class="o">+</span><span class="n">userDto</span><span class="o">.</span><span class="na">getEmail</span><span class="o">()+</span><span class="s">":"</span><span class="o">+</span><span class="n">userDto</span><span class="o">.</span><span class="na">getIdCard</span><span class="o">());</span>
<span class="o">}</span>
</pre></table></code></div></div><p>最后，执行可以得到如下结果。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">jpa</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">query</span><span class="o">.</span><span class="na">AbstractJpaQuery</span><span class="n">$TupleConverter$TupleBackedMap</span><span class="err">@</span><span class="mi">373</span><span class="n">c28e5</span>
<span class="nl">jackJK123:</span><span class="mi">123456</span><span class="err">@</span><span class="mi">126</span><span class="o">.</span><span class="na">COM</span><span class="o">:</span><span class="n">shengfengzhenghao</span>
</pre></table></code></div></div><p>比起 DTO 不需要 new 了，并且接口只能读，那么我们返回的结果 DTO 的职责就更单一了，只用来查询。</p><p><strong>接口的方式是比较推荐的做法，因为它是只读的，对构造方法没有要求，返回的实际是 HashMap。</strong></p><h2 id="query-动态查询解决方法"><span class="mr-2">@Query 动态查询解决方法</span><a href="#query-动态查询解决方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>首先，新增一个 UserOnlyName 接口，只查询 User 里面的 name 和 email 字段。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.example.jpa.example1</span><span class="o">;</span>

<span class="c1">// 获得返回结果</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserOnlyName</span> <span class="o">{</span>
   <span class="nc">String</span> <span class="nf">getName</span><span class="o">();</span>
   <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>其次，在 UserDtoRepository 里面新增两个方法：一个是利用 JPQL 实现动态查询，一个是利用原始 SQL 实现动态查询。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.example.jpa.example1</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.query.Param</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDtoRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="cm">/**
    * 利用JQPl动态查询用户信息
    * @param name
    * @param email
    * @return UserSimpleDto接口
    */</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select u.name as name,u.email as email from User u where (:name is null or u.name =:name) and (:email is null or u.email =:email)"</span><span class="o">)</span>
   <span class="nc">UserOnlyName</span> <span class="nf">findByUser</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"email"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">email</span><span class="o">);</span>

   <span class="cm">/**
    * 利用原始sql动态查询用户信息
    * @param user
    * @return
    */</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select u.name as name,u.email as email from user u where (:#{#user.name} is null or u.name =:#{#user.name}) and (:#{#user.email} is null or u.email =:#{#user.email})"</span><span class="o">,</span><span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
   <span class="nc">UserOnlyName</span> <span class="nf">findByUser</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span> <span class="nc">User</span> <span class="n">user</span><span class="o">);</span>
</pre></table></code></div></div><p>然后，新增一个测试类，测试一下上面方法的结果。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQueryDinamicDto</span><span class="o">()</span> <span class="o">{</span>
   <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"jack"</span><span class="o">).</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">).</span><span class="na">sex</span><span class="o">(</span><span class="s">"man"</span><span class="o">).</span><span class="na">address</span><span class="o">(</span><span class="s">"shanghai"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span><span class="nc">UserOnlyName</span> <span class="n">userDto</span> <span class="o">=</span> <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">findByUser</span><span class="o">(</span><span class="s">"jack"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userDto</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">userDto</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
   <span class="nc">UserOnlyName</span> <span class="n">userDto2</span> <span class="o">=</span> <span class="n">userDtoRepository</span><span class="o">.</span><span class="na">findByUser</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">email</span><span class="o">(</span><span class="s">"123456@126.com"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userDto2</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">userDto2</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
<span class="o">}</span>
</pre></table></code></div></div><p>最后，运行结果如下。</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>Hibernate: insert into user <span class="o">(</span>address, email, name, sex, version, <span class="nb">id</span><span class="o">)</span> values <span class="o">(</span>?, ?, ?, ?, ?, ?<span class="o">)</span>
 : binding parameter <span class="o">[</span>1] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>shanghai]
 : binding parameter <span class="o">[</span>2] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>123456@126.com]
 : binding parameter <span class="o">[</span>3] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>jack]
 : binding parameter <span class="o">[</span>4] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>man]
 : binding parameter <span class="o">[</span>5] as <span class="o">[</span>BIGINT] - <span class="o">[</span>0]
 : binding parameter <span class="o">[</span>6] as <span class="o">[</span>BIGINT] - <span class="o">[</span>1]
Hibernate: <span class="k">select </span>user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where <span class="o">(</span>? is null or user0_.name<span class="o">=</span>?<span class="o">)</span> and <span class="o">(</span>? is null or user0_.email<span class="o">=</span>?<span class="o">)</span>
 : binding parameter <span class="o">[</span>1] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>jack]
 : binding parameter <span class="o">[</span>2] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>jack]
 : binding parameter <span class="o">[</span>3] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>null]
 : binding parameter <span class="o">[</span>4] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>null]
jack:123456@126.com
Hibernate: <span class="k">select </span>u.name as name,u.email as email from user u where <span class="o">(</span>? is null or u.name <span class="o">=</span>?<span class="o">)</span> and <span class="o">(</span>? is null or u.email <span class="o">=</span>?<span class="o">)</span>
 : binding parameter <span class="o">[</span>1] as <span class="o">[</span>VARBINARY] - <span class="o">[</span>null]
 : binding parameter <span class="o">[</span>2] as <span class="o">[</span>VARBINARY] - <span class="o">[</span>null]
 : binding parameter <span class="o">[</span>3] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>123456@126.com]
 : binding parameter <span class="o">[</span>4] as <span class="o">[</span>VARCHAR] - <span class="o">[</span>123456@126.com]
jack:123456@126.com
</pre></table></code></div></div><p>注意：其中打印了一下 SQL 传入的参数，是为了更清楚参数都传入了什么值。</p><p>上面的两个方法，分别采用了<strong>JPQL 的动态参数</strong>和 <strong>SPEL 的表达式</strong>方式获取参数。</p><p>通过上面的实例可以看得出来，采用了 <code class="language-plaintext highlighter-rouge">:email isnullor s.email = :email</code> 这种方式来实现动态查询的效果。</p><p>实际工作中也可以演变得很复杂。所以，再看一个实际工作中复杂一点的例子。</p><p><strong>通过原始 sql，根据动态条件 room 关联 room_record 来获取 room_record 的结果。</strong></p><p><strong>通过 JPQL 动态参数查询 RoomRecord。</strong></p><p>@Query 注解亦可以获得想要的结果，nativeQuery 也可以获得想要的结果，选择如下：</p><ol><li>能用方法名表示的，尽量用方法名表示，因为这样语义清晰、简单快速，基本上只要编译通过，一定不会有问题；<li>能用 @Query 里面的 JPQL 表示的，就用 JPQL，这样与 SQL 无关，万一哪天换数据库了，基本上代码不用改变；<li>最后实在没有办法了，可以选择 nativeQuery 写原始 SQL</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring-security/" class="post-tag no-text-decoration" >Spring Security</a> <a href="/tags/react/" class="post-tag no-text-decoration" >React</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spring Data JPA - @Query - ThinkerWalker&amp;url=/posts/query-annotation/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spring Data JPA - @Query - ThinkerWalker&amp;u=/posts/query-annotation/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/query-annotation/&amp;text=Spring Data JPA - @Query - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring-data-jpa-first/"><div class="card-body"> <em class="timeago small" data-ts="1598974380" > 2020-09-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA</h3><div class="text-muted small"><p> Spring Boot 和 Spring Data JPA 第一步：利用 IDEA 和 SpringBoot 2.3.3 快速创建一个演示项目 选择 Spring Boot 的依赖： Lombok：帮我们创建一个简单的 Entity 的 POJO，主要用来省去创建 GET 和 SET 方法； Spring Web：MVC 必备组件； Spring Data JPA：重头戏...</p></div></div></a></div><div class="card"> <a href="/posts/spring-data-jpa-test/"><div class="card-body"> <em class="timeago small" data-ts="1599060780" > 2020-09-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>利用单元测试和集成测试</h3><div class="text-muted small"><p> 如果测试用例非常完备，是可以提升团队体效率的 Spring Data JPA 单元测试 实际工作中我们免不了要和 Repository 打交道，那么这层的测试用例应该怎么写呢？怎么才能提高开发效率呢？关于 JPA 的 Repository，下面我们分成两个部分来介绍：了解基本语法；分析最佳实践。 Spring Data JPA Repository 的测试用例 测试用例写法步骤如下。 ...</p></div></div></a></div><div class="card"> <a href="/posts/spring-data-common-repository/"><div class="card-body"> <em class="timeago small" data-ts="1599312780" > 2020-09-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data Common 之 Repository</h3><div class="text-muted small"><p> Spring Data 对整个数据操作做了很好的封装，其中 Spring Data Common 定义了很多公用的接口和一些相对数据操作的公共实现（如分页排序、结果映射、Autiting 信息、事务等），而 Spring Data JPA 就是 Spring Data Common 的关系数据库的查询实现。 Spring Data Common 的核心内容——Repository。 Sp...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring-data-jpa-test/" class="btn btn-outline-primary" prompt="上一篇"><p>利用单元测试和集成测试</p></a> <a href="/posts/defining-query-methods/" class="btn btn-outline-primary" prompt="下一篇"><p>Spring Data JPA - Defining Query Methods 的命名语法与参数</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
