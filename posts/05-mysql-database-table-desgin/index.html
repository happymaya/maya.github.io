<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="设计高性能的数据库表" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="范式与反范式" /><meta property="og:description" content="范式与反范式" /><link rel="canonical" href="/posts/05-mysql-database-table-desgin/" /><meta property="og:url" content="/posts/05-mysql-database-table-desgin/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-11T07:53:22+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="设计高性能的数据库表" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2020-07-11T07:53:22+00:00","datePublished":"2020-07-11T07:53:22+00:00","description":"范式与反范式","headline":"设计高性能的数据库表","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/05-mysql-database-table-desgin/"},"url":"/posts/05-mysql-database-table-desgin/"}</script><title>设计高性能的数据库表 | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>设计高性能的数据库表</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>设计高性能的数据库表</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1594454002" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-07-11 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6094 字"> <em>33 分钟</em>阅读</span></div></div></div><div class="post-content"><h2 id="范式与反范式"><span class="mr-2">范式与反范式</span><a href="#范式与反范式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>表设计是高性能数据库的基础。要设计出高性能的库表结构，必须要提到数据库范式，范式是基础规范，反范式是针对性设计。</p><h3 id="范式"><span class="mr-2">范式</span><a href="#范式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>范式是关系数据库理论的基础，也是在设计数据库结构过程中，需要遵循的规则和指导方法。</p><p>数据库的设计范式是数据库设计所需要满足的规范。只有理解数据库的设计范式，才能设计出高效率、优雅的数据库，否则可能会设计出低效的库表结构。</p><p>目前关系数据库有六种范式：</p><ul><li>第一范式（1NF）<li>第二范式（2NF）<li>第三范式（3NF）<li>巴斯-科德范式（BCNF，Boyce Codd Normal Form）<li>第四范式（4NF）<li>第五范式（5NF，还又称完美范式）。</ul><p>满足最低要求的叫第一范式，简称 1NF。在第一范式基础上进一步满足一些要求的为第二范式，简称 2NF。其余依此类推。各种范式呈递次规范，越高的范式数据库冗余越小。</p><p><strong>通常所用到的只是前三个范式，即：第一范式（1NF），第二范式（2NF），第三范式（3NF）。</strong></p><h4 id="第一范式"><span class="mr-2">第一范式</span><a href="#第一范式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>第一范式<strong>无重复的列</strong>，表中的每一列都是不可再拆分的基本数据项，强调列的原子性.。</p><p>在实际场景中，一个联系人有家庭电话和公司电话，那么以“姓名、性别、电话”为表头的表结构就没有达到 1NF。</p><p>要符合 1NF 只需把电话列拆分，让表头变为姓名、性别、家庭电话、公司电话即可。</p><h4 id="第二范式"><span class="mr-2">第二范式</span><a href="#第二范式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>第二范式<strong>属性完全依赖于主键</strong>。</p><ul><li>首先需要满足 1NF；<li>此外，还需要包含两部分内容：<ul><li>表必须有一个主键；<li>没有包含在主键中的列，必须完全依赖于主键，而不能只依赖于主键的一部分。即要求实体的属性完全依赖（指不能存在仅依赖主关键字一部分的属性）于主关键字。</ul></ul><h4 id="第三范式"><span class="mr-2">第三范式</span><a href="#第三范式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>第三范式属性<strong>不传递依赖于其他非主属性，</strong></p><ul><li>首先需要满足 2NF；<li>另外非主键列必须直接依赖于主键，不能存在传递依赖。即不能存在，非主键列 A 依赖于非主键列 B，非主键列 B 依赖于主键的情况。</ul><h4 id="第二范式和第三范式的区别"><span class="mr-2">第二范式和第三范式的区别</span><a href="#第二范式和第三范式的区别" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>第二范式：非主键列是否依赖主键（包括一列通过某一列间接依赖主键），要是有依赖关系就是第二范式；<li>第三范式：非主键列是否直接依赖主键，不能是那种通过传递关系的依赖。要是符合这种依赖关系就是第三范式。</ul><p>综上，3NF 是 2NF 的子集，2NF 是 1NF 的子集。</p><h4 id="设计符合-2nf-的表"><span class="mr-2">设计符合 2NF 的表</span><a href="#设计符合-2nf-的表" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>接下来以订单信息表为例，总结设计一个符合 2NF 表的过程。</p><ul><li><p>首先，原始的订单信息表，如下图所示：</p><div class="table-wrapper"><table><thead><tr><th>订单编号<th>商品编号<th>商品名称<th>数量<th>单位<th>价格<th>客户<th>所属单位<tbody><tr><td>001<td>1<td>产品一<td>1<td>个<td>100<td>张三<td>XXX<tr><td>002<td>2<td>产品二<td>2<td>个<td>200<td>张三<td>XXX<tr><td>003<td>3<td>产品三<td>1<td>个<td>50<td>李四<td>XXX</table></div><p>图中，以订单编号和商品编号作为联合主键，商品名称、单位、价格等信息不与主键相关，只与编号相关，违反了第二范式。 应该对订单信息表进行拆分，商品信息单独一张表，订单项目一张表，如下所示，拆分分成 3 张表：</p><li><p>包含客户信息的订单信息表：</p><div class="table-wrapper"><table><thead><tr><th>订单编号<th>客户<th>所属单位<tbody><tr><td>001<td>张三<td>XXX<tr><td>002<td>李四<td>XXX</table></div><li><p>包含商品详情的商品信息表：</p><div class="table-wrapper"><table><thead><tr><th>商品编号<th>商品名称<th>单位<th>价格<tbody><tr><td>1<td>产品一<td>个<td>100<tr><td>2<td>产品三<td>个<td>200<tr><td>3<td>产品三<td>个<td>50</table></div><li><p>包含订单详情的订单详情表：</p><div class="table-wrapper"><table><thead><tr><th>订单编号<th>商品编号<th>数量<tbody><tr><td>001<td>1<td>1<tr><td>001<td>2<td>2<tr><td>002<td>3<td>1</table></div></ul><h4 id="范式的优点"><span class="mr-2">范式的优点</span><a href="#范式的优点" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li><p>避免数据冗余，减少维护数据完整性的麻烦；</p><li><p>减少数据库的空间；</p><li><p>数据变更速度快；</p><li><p>范式的优缺点。</p></ul><h4 id="范式的缺点"><span class="mr-2">范式的缺点</span><a href="#范式的缺点" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li><p>按照范式的规范设计的表，等级越高的范式设计出来的表数量越多。</p><li><p>获取数据时，表关联过多，性能较差。</p><li><p>表的数量越多，查询所需要的时间越多。也就是说所用的范式越高，对数据操作的性能越低。</p></ul><h3 id="反范式"><span class="mr-2">反范式</span><a href="#反范式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>范式是普适的规则，满足大多数的业务场景的需求。</p><p>对于一些特殊的业务场景，范式设计的表，无法满足性能的需求。</p><p>此时，就需要根据业务场景，在范式的基础之上进行灵活设计，也就是反范式设计。</p><p>反范式设计主要从三方面考虑：</p><ul><li>业务场景；<li>相应时间；<li>字段冗余。</ul><p><strong>反范式设计就是用空间来换取时间，提高业务场景的响应时间，减少多表关联。</strong></p><p>主要的优点如下：</p><ul><li>允许适当的数据冗余，业务场景中需要的数据几乎都可以在一张表上显示，避免关联；<li>可以设计有效的索引。</ul><h3 id="范式与反范式异同"><span class="mr-2">范式与反范式异同</span><a href="#范式与反范式异同" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>范式化模型：</p><ul><li>数据没有冗余，更新容易；<li>当表的数量比较多，查询数据需要多表关联时，会导致查询性能低下。</ul><p>反范式化模型：</p><ul><li>冗余将带来很好的读取性能，因为不需要 join 很多表；<li>虽然需要维护冗余数据，但是对磁盘空间的消耗是可以接受的。</ul><h2 id="mysql-使用原则和设计规范"><span class="mr-2">MySQL 使用原则和设计规范</span><a href="#mysql-使用原则和设计规范" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>MySQL 虽然具有很多特性，并提供了很多功能，但是有些特性会严重影响它的性能，比如：</p><ul><li>在数据库里进行计算；<li>写大事务；<li>大 SQL；<li>存储大字段等。</ul><h3 id="基本使用原则"><span class="mr-2">基本使用原则</span><a href="#基本使用原则" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>发挥 MySQL 的最佳性能，需要遵循 3 个基本使用原则：</p><ol><li>首先是需要让 MySQL 回归存储的基本职能：MySQL 数据库只用于数据的存储，不进行数据的复杂计算，不承载业务逻辑，确保存储和计算分离；<li>其次是查询数据时，尽量单表查询，减少跨库查询和多表关联；<li>还有就是要杜绝大事务、大 SQL、大批量、大字段等一系列性能杀手：<ol><li>大事务，运行步骤较多，涉及的表和字段较多，容易造成资源的争抢，甚至形成死锁。一旦事务回滚，会导致资源占用时间过长；<li>大 SQL，复杂的 SQL 意味着过多的表的关联，MySQL 数据库处理关联超过 3 张表以上的 SQL 时，占用资源多，性能低下；<li>大批量，意味着多条 SQL 一次性执行完成，必须确保进行充分的测试，并且在业务低峰时段或者非业务时段执行；<li>大字段，blob、text 等大字段，尽量少用。必须要用时，尽量与主业务表分离，减少对这类字段的检索和更新。</ol></ol><h3 id="基本设置规则"><span class="mr-2">基本设置规则</span><a href="#基本设置规则" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><p><strong>必须指定默认存储引擎为 InnoDB，并且禁用 MyISAM 存储引擎</strong>。</p><p>随着 MySQL 8.0 版本的发布，所有的数据字典表都已经转换成了 InnoDB，MyISAM 存储引擎已成为了历史！</p><li><p><strong>默认字符集 UTF8mb4。</strong></p><p>以前版本的 UTF8 是 UTF8mb3，未包含个别特殊字符，新版本的 UTF8mb4 包含所有字符，<strong>官方强烈建议使用此字符集；</strong></p><li><p>关闭区分大小写功能。</p><p>设置 lower_case_tables_name=1，即可关闭区分大小写功能，即大写字母 T 和小写字母 t 一样。</p></ul><p>系统中区分大小写的库表，转换为不区分大小写的库表的操作步骤如下（因为要修改底层数据，还是比较麻烦的）：</p><ul><li>MySQL dump 导出数据库；<li>修改参数 lower_case_tables_name=1；<li>导入备份数据时，必须停止数据库，停止业务，影响非常大；<li>开启 per-table 表空间，开启后，每张业务表会单独创建一个独立于系统表空间的表空间，便于空间的回收，数据的迁移。</ul><p>MySQL 数据库提供的功能很全面，但并不是所有的功能性能都高效：</p><ul><li><strong>存储过程、触发器、视图、event：</strong><ul><li>为了存储计算分离，这类功能尽量在程序中实现！！！<li>这些功能非常不完整，调试、排错、监控都非常困难，相关数据字典也不完善，存在潜在的风险；<li>在生产数据库中，禁止使用；</ul><li>lob、text、enum、set：<ul><li>这些字段类型，在 MySQL 数据库的检索性能不高，很难使用索引进行优化；<li>如果必须使用这些功能，一般采取特殊的结构设计，或者与程序结合使用其他的字段类型替代；<li>比如：set 可以使用整型（0，1，2，3）、注释功能和程序的检查功能集合替代。</ul></ul><h3 id="规范命名"><span class="mr-2">规范命名</span><a href="#规范命名" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong>统一的规范命名，可以增加可读性，减少隐式转换。</strong></p><p>命名规范如下，命名时的字符取值范围为：<strong>a~z，0~9 和 _（下画线）</strong>：</p><ul><li><p>所有表名小写，不允许驼峰式命名；</p><li><p>允许使用 -（横线）和 （空格）；如下图所示，当使用 -（横线），后台默认会转化成 @002d；</p><li><p>不允许使用其他特殊字符作为名称，减少潜在风险。</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0502.png" alt="" data-proofer-ignore></p></ul><h4 id="库名命名规则"><span class="mr-2">库名命名规则</span><a href="#库名命名规则" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p><strong>数据库库名的命名规则必须遵循“见名知意”的原则，即库名规则为：“数据库类型代码 + 项目简称 + 识别代码 + 序号”。</strong></p><p>这样包含了更多的业务信息，比如：</p><ul><li>出入系统业务生产库：AOCT、AOCT1、AOCT2；<li>出入系统业务开发库：AOCTDEV、AOCTDEV1、AOCTDEV2；<li>出入系统业务测试库：AOCTTEST、AOCTTEST1、AOCTTEST2；<li>只有一个数据库，则不加序号，否则末尾增加序号；<li>生产库不加识别代码，否则需要增加识别代码 DEV 或 TEST；<li>如果只作历史库，则只需要：<strong>项目简称 +H+ 序号；</strong><li>图例为常用的识别代码。</ul><p>程序账号与数据库名称保持一致。如果所有的程序账号都是 root@‘%’，密码也一样，很容易错连到其他的数据库，造成误操作。</p><h4 id="表名命名规则"><span class="mr-2">表名命名规则</span><a href="#表名命名规则" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>表名的命名规则分为：</p><ul><li>单表仅使用 <code class="language-plaintext highlighter-rouge">a~z</code>、<code class="language-plaintext highlighter-rouge">_</code>；<li>分表名称为<code class="language-plaintext highlighter-rouge">表名_编号</code>；<li>业务表名代表用途、内容：<code class="language-plaintext highlighter-rouge">子系统简称_业务含义_后缀</code>。</ul><p>常见业务表类型有：</p><ul><li>临时表，tmp；<li>备份表，bak；<li>字典表，dic；<li>日志表，log。</ul><h4 id="字段命名规则"><span class="mr-2">字段命名规则</span><a href="#字段命名规则" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>字段名精确，遵循“见名知意”的原则，格式：<code class="language-plaintext highlighter-rouge">名称_后缀</code>。</p><p>避免普遍简单、有歧义的名称：</p><ul><li><p>用户表中，用户名的字段为 UserName 比 Name 更好；</p><li><p>布尔型的字段，以助动词（has/is）开头：</p><ul><li>用户是否有留言 hasmessage，用户是否通过检查 ischecked 等。</ul></ul><p>常见后缀如下：</p><ul><li>流水号/无意义主键，后缀为 id，比如 task_id；<li>时间，后缀为 time，insert_time。</ul><h4 id="索引命名规则"><span class="mr-2">索引命名规则</span><a href="#索引命名规则" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>索引命名格式，主要为了区分哪些对象是索引：</p><ul><li><code class="language-plaintext highlighter-rouge">前缀_表名（或缩写）_字段名（或缩写）</code>；<li>主键必须使用前缀<code class="language-plaintext highlighter-rouge">pk_</code>；<li>UNIQUE 约束必须使用前缀<code class="language-plaintext highlighter-rouge">uk_</code>；<li>普通索引必须使用前缀“idx_”。</ul><p>数据库规范库表字段的命名，能够提高数据库的易读性，为数据库表设计打下基础。</p><h4 id="表设计的一些规则"><span class="mr-2">表设计的一些规则</span><a href="#表设计的一些规则" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li><p>显式指定需要的属性；创建表时显示指定字符集、存储引擎、注释信息等</p><li><p>不同系统之间，统一规范；</p><p>不同表之间的相同字段或者关联字段，字段类型/命名要保持一致；库表字符集和前端程序、中间件必须保持一致的 UTF8mb4。</p></ul><h4 id="innodb-表的注意事项"><span class="mr-2">InnoDB 表的注意事项</span><a href="#innodb-表的注意事项" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ol><li>主键列，UNSIGNED 整数，使用 auto_increment；禁止手动更新 auto_increment，可以删除；<li>必须添加 comment 注释；<li>必须显示指定的 engine。<li>表必备三字段：id、 xxx_create、 xxx_modified：<ol><li>id 为主键，类型为 unsigned bigint 等数字类型；<li>xxx_create、xxx_modified 的类型均为 datetime 类型，分别记录该条数据的创建时间、修改时间。</ol></ol><h4 id="备份表临时表等常见表的设计规范"><span class="mr-2">备份表/临时表等常见表的设计规范</span><a href="#备份表临时表等常见表的设计规范" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ol><li><p>备份表，表名必须添加 bak 和日期，主要用于系统版本上线时，存储原始数据，上线完成后，必须及时删除；</p><li><p>临时表，用于存储中间业务数据，定期优化，及时降低表碎片；</p><li><p>日志类表，首先考虑不入库，保存成文件，其次如果入库，明确其生命周期，保留业务需求的数据，定期清理；</p><li>大字段表，把主键字段和大字段，单独拆分成表，并且保持与主表主键同步，尽量减少大字段的检索和更新；<li>大表，根据业务需求，从垂直和水平两个维度进行拆分：<ol><li>垂直拆分：按列关联度。<li>水平拆分：<ol><li>按照时间、地域、范围等；<li>冷热数据（历史数据归档）。</ol></ol></ol><h4 id="字段设计要求"><span class="mr-2">字段设计要求</span><a href="#字段设计要求" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ol><li>根据业务场景需求，选择合适的类型，最短的长度；确保字段的宽度足够用，但也不要过宽；<li>所有字段必须为 NOT NULL，空值则指定 default 值，空值难以优化，查询效率低。比如：<ol><li>人的年龄用 unsigned tinyint（范围 0~255，人的寿命不会超过 255 岁）；<li>海龟就必须是 smallint，但如果是太阳的年龄，就必须是 int；<li>如果是所有恒星的年龄都加起来，那么就必须使用 bigint;</ol><li>表字段数少而精，尽量不加冗余列；<li>单实例表个数必须控制在 2000 个以内。<li>单表分表个数必须控制在 1024 个以内。<li>单表字段数上限控制在 20~50 个。</ol><h4 id="禁用-enumset-类型"><span class="mr-2">禁用 ENUM、SET 类型。</span><a href="#禁用-enumset-类型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>兼容性不好，性能差。</p><p>解决方案：</p><ul><li><p>使用 TINYINT，在 COMMENT 信息中标明被枚举的含义，如下：</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">`is_disable`</span> <span class="nb">TINYINT</span> <span class="nb">UNSIGNED</span> <span class="k">DEFAULT</span> <span class="s1">'0'</span> <span class="k">COMMENT</span> <span class="s1">'0:启用 1:禁用 2:异常’。
</span></pre></table></code></div></div></ul><h4 id="禁用列为-null"><span class="mr-2">禁用列为 NULL</span><a href="#禁用列为-null" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li><p>MySQL 难以优化 NULL 列；</p><li><p>NULL 列加索引，需要额外空间；</p><li><p>含 NULL 复合索引无效。</p></ul><p>解决方案：在列上添加 <code class="language-plaintext highlighter-rouge">NOT NULL DEFAULT</code> 缺省值。</p><h4 id="禁止-varbinaryblob-存储图片文件等"><span class="mr-2">禁止 VARBINARY、BLOB 存储图片、文件等。</span><a href="#禁止-varbinaryblob-存储图片文件等" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>禁止在数据库中存储大文件，例如照片，可以将大文件存储在对象存储系统中，数据库中存储路径。</ul><h4 id="不建议使用-textblob"><span class="mr-2">不建议使用 TEXT/BLOB</span><a href="#不建议使用-textblob" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li><p>处理性能差；</p><li><p>行长度变长；</p><li><p>全表扫描代价大。</p></ul><p>解决方案：拆分成单独的表。</p><h4 id="存储字节大小"><span class="mr-2">存储字节大小</span><a href="#存储字节大小" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>存储字节越小，占用空间越小。尽量选择合适的整型，如下图所示：</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0503.png" alt="" data-proofer-ignore></p><ul><li>主键列，无负数，建议使用 INT UNSIGNED 或者 BIGINT UNSIGNED；<li>预估字段数字取值会超过 42 亿，使用 BIGINT 类型；<li>短数据使用 TINYINT 或 SMALLINT，比如：人类年龄，城市代码；<li>使用 UNSIGNED 存储非负数值，扩大正数的范围。</ul><h4 id="int3int5-区别"><span class="mr-2">int(3)/int(5) 区别</span><a href="#int3int5-区别" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>如下图所示：</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0504.png" alt="" data-proofer-ignore></p><ul><li>正常显示没有区别；<li><p>3 和 5 仅是最小显示宽度而已；</p><li>有 zerofill 等扩展属性时则显示有区别。</ul><h4 id="浮点数与定点数区别"><span class="mr-2">浮点数与定点数区别</span><a href="#浮点数与定点数区别" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>浮点数与定点数区别，如下图所示。</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0505.png" alt="" data-proofer-ignore></p><ul><li><p>浮点数：float、double（或 real）。</p><li><p>定点数：decimal（或 numberic）。</p></ul><p>从上图中可以观察到：</p><ul><li><p>浮点数存在误差问题；</p><li><p>尽量避免进行浮点数比较；</p><li><p>对货币等对精度敏感的数据，应该使用定点数。</p></ul><h4 id="n-解释"><span class="mr-2">N 解释</span><a href="#n-解释" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p><strong>字符集都为 UTF8mb4，中文存储占三个字节，而数据或字母，则只占一个字节。</strong></p><p>下面看一下字符类型中 N 的解释：</p><ul><li>CHAR(N) 和 VARCHAR(N) 的长度 N，不是字节数，而是字符数；<li>username 列可以存多少个汉字，占用多少个字节；<li>username 最多能存储 40 个字符，占用 120 个字节。</ul><h4 id="char-与-varchar-类型"><span class="mr-2">Char 与 Varchar 类型</span><a href="#char-与-varchar-类型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>存储字符串长度相同的全部使用 Char 类型；</p><p>字符长度不相同的使用 Varchar 类型，不预先分配存储空间，长度不要超过 255。</p><p>Char 和 Varchar 占用空间的对比，如下图所示。</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0506.png" alt="" data-proofer-ignore></p><p>Varchar 值存储为 1 字节或 2 字节长度前缀加数据。如果值不超过 255 个字节，则列使用一个字节长度；如果值可能需要超过 255 个字节，则列使用两个字节长度。</p><p>为什么超过 255 个字节时，必须使用两个字节长度。</p>\[2^8=256, 1 个字节是 8 位\]<h2 id="案例"><span class="mr-2">案例</span><a href="#案例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="ip-处理"><span class="mr-2">IP 处理</span><a href="#ip-处理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li><p>一般使用 Char(15) 进行存储，但是当进行查找和统计时，字符类型不是很高效。</p><li><p>MySQL 数据库内置了两个 IP 相关的函数 INET_ATON()、INET_NTOA()，可以实现 IP 地址和整数的项目转换。</p></ol><p>因此，使用 INT UNSIGNED（占用 4 个字节）存储 IP，非 Char(15)。占 15 个字节。</p><p>下图所示，IP：192.168.0.1 与整数之间的转换。</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0507.png" alt="" data-proofer-ignore></p><p>将 IP 的存储从字符型转换成整形，转化后数字是连续的，提高了查询性能，使查询更快，占用空间更小。</p><h3 id="timestamp-处理"><span class="mr-2">TIMESTAMP 处理</span><a href="#timestamp-处理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>同样的方法，使用 MySQL 内置的函数(FROM_UNIXTIME()，UNIX_TIMESTAMP())，可以将日期转化为数字，用 INT UNSIGNED 存储日期和时间。</p><p>下图示所示，时间 2007-11-30 10:30:19 与整数之间的转换，转化后数字是连续的，占用空间更小，并且可以使用索引提升查询性能。</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0508.png" alt="" data-proofer-ignore></p><p>本案例展示的是，不当的数字类型，导致表无法插入新数据，如下图所示：</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0509.png" alt="" data-proofer-ignore></p><p>当使用 load data 进行批量加载数据时，会导致 1467 错误。根据分析，导致 1467 错误是由于 auto_increment 的值，超过了 int 类型的取值范围。</p><p>原因分析部分显示，max(seq_id) 为 2147477751，而 int 的范围为 -2147483648~ 2147483647，还剩余空间 5896，而程序需要导入 1 万行，所以报错。</p><p><strong>解决办法</strong></p><p>将 int 改为 bigint 或者将数据分表。</p><h3 id="表大小及使用频率"><span class="mr-2">表大小及使用频率</span><a href="#表大小及使用频率" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>设计表时，必须考虑表的大小和使用频率，避免由于取值范围过小，导致程序运行失败。</p><p>对于 InnoDB 表，要求创建一个与业务无关的主键，比如：每张表以 id 列为主键。</p><p>但是 id 列非常常见，完全无法表达更深层次的意思，特别是在做两张表的联合查询时，它们都有相同的 id 主键的情况下。</p><p>如果程序用的是列名，该如何区分 Accounts 表的 id 和 Bugs 的 id 呢？如下图所示，列名 id 并不会使查询变得更加清晰。但如果列名叫作 bug_id 或者 account_id，事情就会变得更加简单。</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0510.png" alt="" data-proofer-ignore></p><p>使用主键来定位唯一一条记录，因此主键的列名就应该更加便于理解，如下图所示。</p><p><img data-src="https://images.happymaya.cn/assert/db/mysql/mysql-0511.png" alt="" data-proofer-ignore></p><p>在缺陷跟踪数据库中，使用 Products 表中的 product_id 主键列来关联产品和对应的联系人。每个账号可能对应很多产品，每个产品又引用了一个联系人，因此产品和帐号之间是多对一的关系</p><p>随着项目日趋成熟，一个产品可能会有多个联系人，除了多对一的关系外，还需要支持产品到账号的一对多的关系。Products 表中的一行数据必须要存储多个联系人。</p><p>为了把数据库表结构的改动控制在最小范围内，定将 account_id 的类型修改为 Varchar，这样可以在该列中存储多个账号 id，每个账号 id 之间用逗号分隔。</p><p>这样的设计似乎是可行的，没有创建额外的表和列，仅仅改变了一个字段的数据类型。然而，这样的设计所必须承受的性能和数据完整性问题。所有外键都合并在一个单元格内，查询会变成异常困难。只能通过正则表达式进行模糊匹配，不但可能会返回错误的结果，而且无法使用索引提高性能。例如：查询指定产品的账号时，联合两张表将不能使用任何索引。这样的查询必然会对两张表进行全表扫描，并创建一个交叉结果集，然后使用正则表达式遍历每一行联合后的数据进行匹配。</p><p>出于性能优化方面的考虑，可能在数据库的结果中需要使用反范式的设计。上述 Products 表中将列表存储为以逗号分隔的字符串，就是反范式的一个实例。这个设计只是简化了存储，但是性能低下。因此谨慎使用反范式的数据库设计。尽可能地使用规范化的数据库设计。</p><p>根据业务需求，设计合理的反范式，解决方案是：创建一个交叉表。将 account_id 存储在一张单独的表中，而不是存储在 Products 表中，从而确保每个独立的 account 值都可以占据一行。</p><p>这张新表 Contacts，实现了 Products 和 Accounts 的多对多关系。当一张表有指向两张表的外键时，称这种表为交叉表，它实现了两张表之间的多对多关系。这意味着每个产品都可以通过交叉表和多个账号关联；同样地，一个账号也可以通过交叉表和多个产品关联。当“查询指定产品的账号”时，就可以直接使用下面的联合查询语句高效实现。</p><h2 id="总结"><span class="mr-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><p>以高性能为目标，库表设计以范式为主，根据特殊业务场景使用反范式，允许必要的空间换时间。</p><li><p>规范数据库的使用原则，统一规范命名，减少性能隐患，减少隐式转换。</p><li><p>高性能表设计的原则：合适的字段、合适的长度、NOT NULL。</p><li><p>从不同角度思考 IP、timestamp 的转换，拓宽设计思路。</p><li><p>规范的命名可提高可读性，反范式设计可提高查询性能。</p></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/database/'>Database</a>, <a href='/categories/mysql/'>MySQL</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mysql/" class="post-tag no-text-decoration" >MySQL</a> <a href="/tags/table-design/" class="post-tag no-text-decoration" >Table Design</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=设计高性能的数据库表 - ThinkerWalker&amp;url=/posts/05-mysql-database-table-desgin/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=设计高性能的数据库表 - ThinkerWalker&amp;u=/posts/05-mysql-database-table-desgin/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/05-mysql-database-table-desgin/&amp;text=设计高性能的数据库表 - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/01-mysql-system/"><div class="card-body"> <em class="timeago small" data-ts="1593826402" > 2020-07-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL 体系结构</h3><div class="text-muted small"><p> MySQL 数据库的体系结构，如下图所示： 通过上图，MySQL 体系结构由 Client Connectors 层、MySQL Server 层及存储引擎层组成。 Client Connectors 层 负责处理客户端的连接请求，与客户端创建连接。 目前 MySQL 几乎支持所有的连接类型，例如常见的 JDBC、Python、Go 等。 MySQL Server 层 MyS...</p></div></div></a></div><div class="card"> <a href="/posts/02-mysql-storage-engine/"><div class="card-body"> <em class="timeago small" data-ts="1593831202" > 2020-07-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL 存储引擎</h3><div class="text-muted small"><p> 存储引擎是 MySQL 中具体与文件打交道的子系统。 是根据 MySQL AB 公司提供的文件访问层抽象接口定制的一种文件访问机制，这种机制就叫作存储引擎。 常用的存储引擎： 远古时期的 MyISAM； 支持事务的 InnoDB； 内存类型的 Memory； 归档类型的 Archive； 列式存储的 Infobright； 一些新兴的存储引擎： ...</p></div></div></a></div><div class="card"> <a href="/posts/03-mysql-transaction/"><div class="card-body"> <em class="timeago small" data-ts="1593917602" > 2020-07-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL 事务</h3><div class="text-muted small"><p> 事务是指作为单个逻辑工作单元执行的一系列操作，这些操作要么全做，要么全不做，是一个不可分割的工作单元。 一个逻辑工作单元要成为事务，在关系型数据库管理系统中，必须满足 4 个特性，即所谓的 ACID：原子性、一致性、隔离性和持久性： 一致性：事务开始之前和事务结束之后，数据库的完整性限制未被破坏； 原子性：事务的所有操作，要么全部完成，要么全部不完成，不会结束在某个中间环节； ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cache-redis-11/" class="btn btn-outline-primary" prompt="上一篇"><p>大幅成倍提升 Redis 处理性能</p></a> <a href="/posts/06-mysql-index-desgin/" class="btn btn-outline-primary" prompt="下一篇"><p>索引设计</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
