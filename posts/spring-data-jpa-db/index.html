<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="使用 Spring Data JPA 访问关系型数据库" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="引入 Spring Data JPA" /><meta property="og:description" content="引入 Spring Data JPA" /><link rel="canonical" href="/posts/spring-data-jpa-db/" /><meta property="og:url" content="/posts/spring-data-jpa-db/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-03-12T09:32:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="使用 Spring Data JPA 访问关系型数据库" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2018-03-12T09:32:00+00:00","datePublished":"2018-03-12T09:32:00+00:00","description":"引入 Spring Data JPA","headline":"使用 Spring Data JPA 访问关系型数据库","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/spring-data-jpa-db/"},"url":"/posts/spring-data-jpa-db/"}</script><title>使用 Spring Data JPA 访问关系型数据库 | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>使用 Spring Data JPA 访问关系型数据库</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>使用 Spring Data JPA 访问关系型数据库</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1520847120" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-03-12 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3069 字"> <em>17 分钟</em>阅读</span></div></div></div><div class="post-content"><h2 id="引入-spring-data-jpa"><span class="mr-2">引入 Spring Data JPA</span><a href="#引入-spring-data-jpa" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>在应用程序中使用 Spring Data JPA，首先需要在 pom 文件中引入 spring-boot-starter-data-jpa 依赖，如下代码所示：</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
     <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><p>在使用这一组件的之前，有必要对 JPA 规范进行一定的了解。</p><p>JPA 全称是 JPA Persistence API，即 Java 持久化 API，它是一个 Java 应用程序接口规范，用于充当面向对象的领域模型和关系数据库系统之间的桥梁，属于一种 ORM（Object Relational Mapping，对象关系映射）技术。</p><p>JPA 规范中定义了一些既定的概念和约定，集中包含在 javax.persistence 包中，常见的如对实体（Entity）定义、实体标识定义、实体与实体之间的关联关系定义，以及 09 讲中介绍的 JPQL 定义等，关于这些定义及其使用方法，一会儿我们会详细展开说明。</p><p>与 JDBC 规范一样，JPA 规范也有一大批实现工具和框架，极具代表性的如老牌的 Hibernate 及 Spring Data JPA。</p><p>基于 Spring Data JPA 的整个开发过程，在 SpringCSS 案例中专门设计和实现一套独立的领域对象和 Repository。</p><h3 id="实体类注解"><span class="mr-2">实体类注解</span><a href="#实体类注解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>order-service 中存在两个主要领域对象，即 Order 和 Goods。为了有所区分，分别命名为 JpaOrder 和 JpaGoods，它们就是 JPA 规范中的实体类。</p><p>相对简单的 JpaGoods，JpaGoods 定义如下代码所示（把 JPA 规范的相关类的引用罗列在了一起）：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"goods"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JpaGoods</span> <span class="o">{</span>
	
	<span class="nd">@Id</span>
	<span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>	
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">goodsCode</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">goodsName</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">Float</span> <span class="n">price</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getGoodsCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">goodsCode</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGoodsCode</span><span class="o">(</span><span class="nc">String</span> <span class="n">goodsCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">goodsCode</span> <span class="o">=</span> <span class="n">goodsCode</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getGoodsName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">goodsName</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGoodsName</span><span class="o">(</span><span class="nc">String</span> <span class="n">goodsName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">goodsName</span> <span class="o">=</span> <span class="n">goodsName</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">Float</span> <span class="nf">getPrice</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">price</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPrice</span><span class="o">(</span><span class="nc">Float</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">price</span><span class="o">;</span>
	<span class="o">}</span>	
<span class="o">}</span>

</pre></table></code></div></div><p>JpaGoods 中使用了 JPA 规范中用于定义实体的几个注解：最重要的 @Entity 注解、用于指定表名的 @Table 注解、用于标识主键的 @Id 注解，以及用于标识自增数据的 @GeneratedValue 注解，这些注解都比较直白，在实体类上直接使用即可。</p><p>接下来，比较复杂的 JpaOrder，定义如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"`order`"</span><span class="o">)</span>
<span class="nd">@JsonIgnoreProperties</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"hibernateLazyInitializer"</span><span class="o">,</span> <span class="s">"handler"</span> <span class="o">})</span>
<span class="nd">@NamedQueries</span><span class="o">({</span> <span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"getOrderByOrderNumberWithQuery"</span><span class="o">,</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"select o from JpaOrder o where o.orderNumber = ?1"</span><span class="o">)</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JpaOrder</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="nd">@Id</span>
	<span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">orderNumber</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">deliveryAddress</span><span class="o">;</span>

	<span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">targetEntity</span> <span class="o">=</span> <span class="nc">JpaGoods</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"order_goods"</span><span class="o">,</span> <span class="n">joinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"order_id"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">),</span> <span class="n">inverseJoinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"goods_id"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">))</span>
	<span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">JpaGoods</span><span class="o">&gt;</span> <span class="n">goods</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

	<span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getOrderNumber</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">orderNumber</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOrderNumber</span><span class="o">(</span><span class="nc">String</span> <span class="n">orderNumber</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">orderNumber</span> <span class="o">=</span> <span class="n">orderNumber</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDeliveryAddress</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">deliveryAddress</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDeliveryAddress</span><span class="o">(</span><span class="nc">String</span> <span class="n">deliveryAddress</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">deliveryAddress</span> <span class="o">=</span> <span class="n">deliveryAddress</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">JpaGoods</span><span class="o">&gt;</span> <span class="nf">getGoods</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">goods</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGoods</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">JpaGoods</span><span class="o">&gt;</span> <span class="n">goods</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">goods</span> <span class="o">=</span> <span class="n">goods</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><p>这里除了引入了常见的一些注解，还引入了 @ManyToMany 注解，它表示 order 表与 goods 表中数据的关联关系。</p><p>在JPA 规范中，共提供了 one-to-one、one-to-many、many-to-one、many-to-many 这 4 种映射关系，它们分别用来处理一对一、一对多、多对一，以及多对多的关联场景。</p><p>针对 order-service 这个业务场景，我设计了一张 order_goods 中间表存储 order 与 goods 表中的主键关系，且使用了 @ManyToMany 注解定义 many-to-many 这种关联关系，也使用了 @JoinTable 注解指定 order_goods 中间表，并通过 joinColumns 和 inverseJoinColumns 注解分别指定中间表中的字段名称以及引用两张主表中的外键名称。</p><h2 id="定义-repository"><span class="mr-2">定义 Repository</span><a href="#定义-repository" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>定义完实体对象后，再来提供 Repository 接口，这一步的操作非常简单，OrderJpaRepository 的定义如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cm">/**
 * 使用 Spring Data JPA 进行数据库访问
 */</span>
<span class="nd">@Repository</span><span class="o">(</span><span class="s">"orderJpaRepository"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IOrderJpaRepositoryImpl</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></table></code></div></div><p>OrderJpaRepository 是一个继承了 JpaRepository 接口的空接口，此时 OrderJpaRepository 实际上已经具备了访问数据库的基本 CRUD 功能。</p><h2 id="使用-spring-data-jpa-访问数据库"><span class="mr-2">使用 Spring Data JPA 访问数据库</span><a href="#使用-spring-data-jpa-访问数据库" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>有了上面定义的 JpaOrder 和 JpaGoods 实体类，以及 OrderJpaRepository 接口，我们已经可以实现很多操作了。</p><p>比如通过 Id 获取 Order 对象，首先可以通过构建一个 JpaOrderService 直接注入 OrderJpaRepository 接口，如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JpaOrderService</span> <span class="o">{</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">IOrderJpaRepositoryImpl</span> <span class="nc">IOrderJpaRepositoryImpl</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nc">JpaOrder</span> <span class="nf">getOrderById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">orderId</span><span class="o">)</span> <span class="o">{</span>

		<span class="k">return</span> <span class="nc">IOrderJpaRepositoryImpl</span><span class="o">.</span><span class="na">getOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><p>然后，再通过构建一个 Controller 类嵌入上述方法，并通过 HTTP 请求查询 Id 为 1 的 JpaOrder 对象，获得的结果如下代码所示：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="err"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="err">    </span><span class="nl">"orderNumber"</span><span class="p">:</span><span class="err"> </span><span class="s2">"Order10001"</span><span class="p">,</span><span class="w">
</span><span class="err">    </span><span class="nl">"deliveryAddress"</span><span class="p">:</span><span class="err"> </span><span class="s2">"test_address1"</span><span class="p">,</span><span class="w">
</span><span class="err">    </span><span class="nl">"goods"</span><span class="p">:</span><span class="err"> </span><span class="p">[</span><span class="w">
</span><span class="err">        </span><span class="p">{</span><span class="w">
</span><span class="err">            </span><span class="nl">"id"</span><span class="p">:</span><span class="err"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="err">            </span><span class="nl">"goodsCode"</span><span class="p">:</span><span class="err"> </span><span class="s2">"GoodsCode1"</span><span class="p">,</span><span class="w">
</span><span class="err">            </span><span class="nl">"goodsName"</span><span class="p">:</span><span class="err"> </span><span class="s2">"GoodsName1"</span><span class="p">,</span><span class="w">
</span><span class="err">            </span><span class="nl">"price"</span><span class="p">:</span><span class="err"> </span><span class="mf">100.0</span><span class="w">
</span><span class="err">        </span><span class="p">},</span><span class="w">
</span><span class="err">        </span><span class="p">{</span><span class="w">
</span><span class="err">            </span><span class="nl">"id"</span><span class="p">:</span><span class="err"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
</span><span class="err">            </span><span class="nl">"goodsCode"</span><span class="p">:</span><span class="err"> </span><span class="s2">"GoodsCode2"</span><span class="p">,</span><span class="w">
</span><span class="err">            </span><span class="nl">"goodsName"</span><span class="p">:</span><span class="err"> </span><span class="s2">"GoodsName2"</span><span class="p">,</span><span class="w">
</span><span class="err">            </span><span class="nl">"price"</span><span class="p">:</span><span class="err"> </span><span class="mf">200.0</span><span class="w">
</span><span class="err">        </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>请注意，这里不仅获取了 order 表中的订单基础数据，还同时获取了 goods 表中的商品数据，这种效果是如何实现的呢？是因为在 JpaOrder 对象中，添加了 @ManyToMany 注解，该注解会自动从 order_goods 表中获取商品主键信息，并从 goods 表中获取商品详细信息。</p><p>了解了使用 Spring Data JPA 实现关系型数据库访问的过程，并对比使用 JdbcTemplate 访问关系型数据库，中发现使用 Spring Data JPA 更简单。</p><p>在多样化查询实现过程中，不仅可以使用 JpaRepository 中默认集成的各种 CRUD 方法，还可以使用 @Query 注解、方法名衍生查询等。因此同时引入 QueryByExample 和 Specification 这两种机制来丰富多样化查询方式。</p><h3 id="使用-query-注解"><span class="mr-2">使用 @Query 注解</span><a href="#使用-query-注解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>使用 @Query 注解实现查询的示例如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span><span class="o">(</span><span class="s">"orderJpaRepository"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderJpaRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;{</span>
<span class="err">   </span> <span class="nd">@Query</span><span class="o">(</span><span class="s">"select o from JpaOrder o where o.orderNumber = ?1"</span><span class="o">)</span>
<span class="err">   </span> <span class="nc">JpaOrder</span> <span class="nf">getOrderByOrderNumberWithQuery</span><span class="o">(</span><span class="nc">String</span> <span class="n">orderNumber</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>这里，使用了 JPQL 根据 OrderNumber 查询订单信息。JPQL 的语法与 SQL 语句非常类似。</p><p>说到 @Query 注解，JPA 中还提供了一个 @NamedQuery 注解对 @Query 注解中的语句进行命名。@NamedQuery 注解的使用方式如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"`order`"</span><span class="o">)</span>
<span class="nd">@NamedQueries</span><span class="o">({</span> <span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"getOrderByOrderNumberWithQuery"</span><span class="o">,</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"select o from JpaOrder o where o.orderNumber = ?1"</span><span class="o">)</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JpaOrder</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{}</span>
</pre></table></code></div></div><p>在上述示例中，在实体类 JpaOrder 上添加了一个 @NamedQueries 注解，该注解可以将一批 @NamedQuery 注解整合在一起使用。同时，我们还使用了 @NamedQuery 注解定义了一个“getOrderByOrderNumberWithQuery”查询，且指定了对应的 JPQL 语句。</p><p>如果使用这个命名查询，在 OrderJpaRepository 中定义与该命名一致的方法即可。</p><h3 id="使用方法名衍生查询"><span class="mr-2">使用方法名衍生查询</span><a href="#使用方法名衍生查询" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>使用方法名衍生查询是最方便的一种自定义查询方式，在这过程中唯一需要做的就是在 JpaRepository 接口中定义一个符合查询语义的方法。</p><p>比如希望通过 OrderNumber 查询订单信息，那么可以提供如下代码所示的接口定义：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span><span class="o">(</span><span class="s">"orderJpaRepository"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderJpaRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;{</span>
    <span class="nc">JpaOrder</span> <span class="nf">getOrderByOrderNumber</span><span class="o">(</span><span class="nc">String</span> <span class="n">orderNumber</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>通过 getOrderByOrderNumber 方法后，就可以自动根据 OrderNumber 获取订单详细信息了。</p><h3 id="使用-querybyexample-机制"><span class="mr-2">使用 QueryByExample 机制</span><a href="#使用-querybyexample-机制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>一种强大的查询机制，即 QueryByExample（QBE）机制。</p><p>针对 JpaOrder 对象，假如希望根据 OrderNumber 及 DeliveryAddress 中的一个或多个条件进行查询，按照方法名衍生查询的方式构建查询方法后，得到如下代码所示的方法定义：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span><span class="o">(</span><span class="s">"orderJpaRepository"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderJpaRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">&gt;</span> <span class="nf">findByOrderNumberAndDeliveryAddress</span> <span class="o">(</span><span class="nc">String</span> <span class="n">orderNumber</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deliveryAddress</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>如果查询条件中使用的字段非常多，上面这个方法名可能非常长，且还需要设置一批参数，这种查询方法定义显然存在缺陷。</p><p>因为不管查询条件有多少个，都需要把所有参数进行填充，哪怕部分参数并没有被用到。而且，如果将来需要再添加一个新的查询条件，该方法必须做调整，从扩展性上讲也存在设计缺陷。为了解决这些问题，便可以引入 QueryByExample 机制。</p><p>QueryByExample 可以翻译为按示例查询，是一种用户友好的查询技术。它允许动态创建查询，且不需要编写包含字段名称的查询方法，也就是说按示例查询不需要使用特定的数据库查询语言来编写查询语句。</p><p>从组成结构上讲，QueryByExample 包括 Probe、ExampleMatcher 和 Example 这三个基本组件。其中， Probe 包含对应字段的实例对象，ExampleMatcher 携带有关如何匹配特定字段的详细信息，相当于匹配条件，Example 则由 Probe 和 ExampleMatcher 组成，用于构建具体的查询操作。</p><p>现在，基于 QueryByExample 机制重构根据 OrderNumber 查询订单的实现过程。</p><p>首先，需要在 OrderJpaRepository 接口的定义中继承 QueryByExampleExecutor 接口，如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span><span class="o">(</span><span class="s">"orderJpaRepository"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderJpaRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;,</span> <span class="nc">QueryByExampleExecutor</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">&gt;</span> <span class="o">{</span>
</pre></table></code></div></div><p>然后，在 JpaOrderService 中实现如下代码所示的 getOrderByOrderNumberByExample 方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>	<span class="kd">public</span> <span class="nc">JpaOrder</span> <span class="nf">getOrderByOrderNumberByExample</span><span class="o">(</span><span class="nc">String</span> <span class="n">orderNumber</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">JpaOrder</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JpaOrder</span><span class="o">();</span>
		<span class="n">order</span><span class="o">.</span><span class="na">setOrderNumber</span><span class="o">(</span><span class="n">orderNumber</span><span class="o">);</span>

		<span class="nc">ExampleMatcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="nc">ExampleMatcher</span><span class="o">.</span><span class="na">matching</span><span class="o">().</span><span class="na">withIgnoreCase</span><span class="o">()</span>
				<span class="o">.</span><span class="na">withMatcher</span><span class="o">(</span><span class="s">"orderNumber"</span><span class="o">,</span> <span class="nc">GenericPropertyMatchers</span><span class="o">.</span><span class="na">exact</span><span class="o">()).</span><span class="na">withIncludeNullValues</span><span class="o">();</span>

		<span class="nc">Example</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">&gt;</span> <span class="n">example</span> <span class="o">=</span> <span class="nc">Example</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">order</span><span class="o">,</span> <span class="n">matcher</span><span class="o">);</span>

		<span class="k">return</span> <span class="nc">IOrderJpaRepositoryImpl</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">example</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="k">new</span> <span class="nc">JpaOrder</span><span class="o">());</span>
	<span class="o">}</span>
</pre></table></code></div></div><p>上述代码中，首先构建了一个 ExampleMatcher 对象用于初始化匹配规则，然后通过传入一个 JpaOrder 对象实例和 ExampleMatcher 实例构建了一个 Example 对象，最后通过 QueryByExampleExecutor 接口中的 findOne() 方法实现了 QueryByExample 机制。</p><h3 id="使用-specification-机制"><span class="mr-2">使用 Specification 机制</span><a href="#使用-specification-机制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>先考虑这样一种场景，比如需要查询某个实体，但是给定的查询条件不固定，此时该怎么办？这时通过动态构建相应的查询语句即可，而在 Spring Data JPA 中可以通过 JpaSpecificationExecutor 接口实现这类查询。相比使用 JPQL 而言，使用 Specification 机制的优势是<strong>类型安全</strong>。</p><p>继承了 JpaSpecificationExecutor 的 OrderJpaRepository 定义如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span><span class="o">(</span><span class="s">"orderJpaRepository"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderJpaRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;,</span> <span class="err">   </span> <span class="nc">JpaSpecificationExecutor</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></table></code></div></div><p>对于 JpaSpecificationExecutor 接口而言，它背后使用的就是 Specification 接口，且 Specification 接口核心方法就一个，我们可以简单地理解该接口的作用就是构建查询条件，如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="nc">Root</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span> <span class="nc">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="nc">CriteriaBuilder</span> <span class="n">criteriaBuilder</span><span class="o">);</span>
</pre></table></code></div></div><p>其中 Root 对象代表所查询的根对象，可以通过 Root 获取实体的属性，CriteriaQuery 代表一个顶层查询对象，用来实现自定义查询，而 CriteriaBuilder 用来构建查询条件。</p><p>基于 Specification 机制，同样对根据 OrderNumber 查询订单的实现过程进行重构，重构后的 getOrderByOrderNumberBySpecification 方法如下代码所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>	<span class="kd">public</span> <span class="nc">JpaOrder</span> <span class="nf">getOrderByOrderNumberBySpecification</span><span class="o">(</span><span class="nc">String</span> <span class="n">orderNumber</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">JpaOrder</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JpaOrder</span><span class="o">();</span>
		<span class="n">order</span><span class="o">.</span><span class="na">setOrderNumber</span><span class="o">(</span><span class="n">orderNumber</span><span class="o">);</span>

		<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
		<span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">&gt;</span> <span class="n">spec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="nc">Root</span><span class="o">&lt;</span><span class="nc">JpaOrder</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span> <span class="nc">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="nc">CriteriaBuilder</span> <span class="n">cb</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Path</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">orderNumberPath</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"orderNumber"</span><span class="o">);</span>
              
                <span class="nc">Predicate</span> <span class="n">predicate</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">orderNumberPath</span><span class="o">,</span> <span class="n">orderNumber</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">predicate</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

		<span class="k">return</span> <span class="nc">IOrderJpaRepositoryImpl</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">spec</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="k">new</span> <span class="nc">JpaOrder</span><span class="o">());</span>
	<span class="o">}</span>
</pre></table></code></div></div><p>从上面示例中可以看到，在 toPredicate 方法中，首先我们从 root 对象中获取了“orderNumber”属性，然后通过 cb.equal 方法将该属性与传入的 orderNumber 参数进行了比对，从而实现了查询条件的构建过程。</p><h2 id="总结"><span class="mr-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Spring Data JPA 实现对关系型数据库访问，因为它不仅具有 ORM 框架的通用功能，同时还添加了 QueryByExample 和 Specification 机制等扩展性功能，应用上简单而高效。</p><blockquote><p>在使用 Spring Data JPA 时，如何正确使用 QueryByExample 和 Specification 机制实现灵活的自定义查询？</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/springboot/" class="post-tag no-text-decoration" >SpringBoot</a> <a href="/tags/spring-security/" class="post-tag no-text-decoration" >Spring Security</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=使用 Spring Data JPA 访问关系型数据库 - ThinkerWalker&amp;url=/posts/spring-data-jpa-db/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=使用 Spring Data JPA 访问关系型数据库 - ThinkerWalker&amp;u=/posts/spring-data-jpa-db/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/spring-data-jpa-db/&amp;text=使用 Spring Data JPA 访问关系型数据库 - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring-security-user-auth/"><div class="card-body"> <em class="timeago small" data-ts="1520155920" > 2018-03-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>基于 Spring Security 构建用户认证体系</h3><div class="text-muted small"><p> 在 Spring Boot 中整合 Spring Security 框架的方式非常简单，我们只需要在 pom 文件中引入 spring-boot-starter-security 依赖即可，这与以往需要提供很多配置才能与 Spring Security 完成集成的开发过程不同，如下代码所示： &amp;lt;dependency&amp;gt;     &amp;lt;groupId&amp;gt;org.springfr...</p></div></div></a></div><div class="card"> <a href="/posts/spring-boot-auto-config/"><div class="card-body"> <em class="timeago small" data-ts="1520242320" > 2018-03-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot 自动配置实现原理</h3><div class="text-muted small"><p> Spring Boot 中的配置体系是一套强大而复杂的体系，其中最基础、最核心的要数自动配置（AutoConfiguration）机制了. @SpringBootApplication 注解 @SpringBootApplication 注解位于 spring-boot-autoconfigure 工程的 org.springframework.boot.autoconfigure 包中...</p></div></div></a></div><div class="card"> <a href="/posts/spring-security-safe/"><div class="card-body"> <em class="timeago small" data-ts="1520328720" > 2018-03-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>基于 Spring Security 确保请求安全访问</h3><div class="text-muted small"><p> 在日常开发过程中，需要对 Web 应用中的不同 HTTP 端点进行不同粒度的权限控制，并且希望这种控制方法足够灵活。而借助 Spring Security 框架，就可以对其进行简单实现。 对 HTTP 端点进行访问授权管理 在一个 Web 应用中，权限管理的对象是通过 Controller 层暴露的一个个 HTTP 端点，而这些 HTTP 端点就是需要授权访问的资源。 开发人员使用 S...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring-safe-system/" class="btn btn-outline-primary" prompt="上一篇"><p>Spring 安全体系的整体架构</p></a> <a href="/posts/spring-boot-custom-config/" class="btn btn-outline-primary" prompt="下一篇"><p>Spring Boot 创建和管理自定义的配置信息</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
