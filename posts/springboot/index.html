<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="SpringBoot 服务性能优化（16）" /><meta name="author" content="superhsc" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="在开始对 SpringBoot 服务进行性能优化之前，需要做一些准备：将 SpringBoot 服务的一些数据暴漏出来。比如：" /><meta property="og:description" content="在开始对 SpringBoot 服务进行性能优化之前，需要做一些准备：将 SpringBoot 服务的一些数据暴漏出来。比如：" /><link rel="canonical" href="/posts/springboot/" /><meta property="og:url" content="/posts/springboot/" /><meta property="og:site_name" content="ThinkerWalker" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-05-12T15:33:35+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="SpringBoot 服务性能优化（16）" /><meta name="twitter:site" content="@happymaya" /><meta name="twitter:creator" content="@superhsc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superhsc"},"dateModified":"2022-05-26T21:13:46+00:00","datePublished":"2019-05-12T15:33:35+00:00","description":"在开始对 SpringBoot 服务进行性能优化之前，需要做一些准备：将 SpringBoot 服务的一些数据暴漏出来。比如：","headline":"SpringBoot 服务性能优化（16）","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/springboot/"},"url":"/posts/springboot/"}</script><title>SpringBoot 服务性能优化（16） | ThinkerWalker</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ThinkerWalker"><meta name="application-name" content="ThinkerWalker"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://images.happymaya.cn/assert/avatar/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ThinkerWalker</a></div><div class="site-subtitle font-italic">日拱一卒 功不唐捐</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/happymaya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/happymaya" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haoshichuan','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>SpringBoot 服务性能优化（16）</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>SpringBoot 服务性能优化（16）</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/happymaya">superhsc</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1557675215" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2019-05-12 </em> </span> <span> 更新于 <em class="timeago" data-ts="1653599626" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-27 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4639 字"> <em>25 分钟</em>阅读</span></div></div></div><div class="post-content"><p>在开始对 SpringBoot 服务进行性能优化之前，需要做一些准备：将 SpringBoot 服务的一些数据暴漏出来。比如：</p><ul><li>服务用到了缓存，就需要把缓存命中率这些数据进行收集；<li>服务用到了数据库连接池，就需要把连接池的参数给暴露出来</ul><p>这里可以采用目前非常流行的监控工具 Prometheus，它是一个<strong>时序数据库</strong>，能够存储自定义的指标。而 SpringBoot 可以非常方便地接入到 Prometheus 中。</p><h2 id="在-springboot-中开启监控"><span class="mr-2">在 SpringBoot 中开启监控</span><a href="#在-springboot-中开启监控" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>创建一个 SpringBoot 项目后，首先加入 maven 依赖，如下：</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;/dependency&gt;</span>

	<span class="c">&lt;!-- prometheus 监控相关依赖 --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.micrometer<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>micrometer-registry-prometheus<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><p>然后，在 <code class="language-plaintext highlighter-rouge">application.yml</code>配置文件中，开放相关的监控接口，如下：</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1"># prometheus 监控平台配置</span>
<span class="na">management</span><span class="pi">:</span>
  <span class="na">endpoint</span><span class="pi">:</span>
    <span class="na">metrics</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">prometheus</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">health</span><span class="pi">:</span>
      <span class="na">show-details</span><span class="pi">:</span> <span class="s">ALWAYS</span>
  <span class="na">endpoints</span><span class="pi">:</span>
    <span class="na">web</span><span class="pi">:</span>
      <span class="na">exposure</span><span class="pi">:</span>
        <span class="na">include</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
        <span class="na">exclude</span><span class="pi">:</span> <span class="s">configprops</span>
  <span class="na">metrics</span><span class="pi">:</span>
    <span class="na">export</span><span class="pi">:</span>
      <span class="na">prometheus</span><span class="pi">:</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">tags</span><span class="pi">:</span>
      <span class="na">application</span><span class="pi">:</span> <span class="s">${server.servlet.context-path}</span>
</pre></table></code></div></div><p>再然后启动之后，就可以通过访问<a href="http://localhost:8080/springboot-optimization/actuator/prometheus">监控接口</a>，效果如下图所示：</p><p><img data-src="https://image.happymaya.cn/assert/blog/springboot/pringboot-prometheus-init.png" alt="" data-proofer-ignore></p><p>想要监控业务数据也非常的简单，只需要注入一个 <code class="language-plaintext highlighter-rouge">MeterRegistry</code>实例即可，如下代码：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.happymaya.springbootoptimization.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micrometer.core.instrument.Counter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micrometer.core.instrument.MeterRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.PostConstruct</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/promethues/"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrometheusController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">MeterRegistry</span> <span class="n">registry</span><span class="o">;</span>

    <span class="cm">/**
     * 指标类型设置
     */</span>
    <span class="kd">private</span> <span class="nc">Counter</span> <span class="n">counterCore</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Counter</span> <span class="n">counterIndex</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">AtomicInteger</span> <span class="n">appOnlineCount</span><span class="o">;</span>

    <span class="cm">/**
     * 服务启动时创建自定义指标
     */</span>
    <span class="nd">@PostConstruct</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">counterCore</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">counter</span><span class="o">(</span><span class="s">"app_requests_method_count"</span><span class="o">,</span> <span class="s">"method"</span><span class="o">,</span> <span class="s">"PrometheusController.core"</span><span class="o">);</span>
        <span class="n">counterIndex</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">counter</span><span class="o">(</span><span class="s">"app_requests_method_count"</span><span class="o">,</span> <span class="s">"method"</span><span class="o">,</span> <span class="s">"PrometheusController.index"</span><span class="o">);</span>
        <span class="n">appOnlineCount</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">gauge</span><span class="o">(</span><span class="s">"app_online_count"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>

    <span class="o">}</span>

    <span class="cm">/**
     * 监控平台是否可用，每调用一次就记录一次，每调用一次 counterIndex 就加一
     *
     * @return 返回监控平台调用次数
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"testIsUsable"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testIsUsable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">counterIndex</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">counterIndex</span><span class="o">.</span><span class="na">count</span><span class="o">()</span> <span class="o">+</span> <span class="s">" index of springboot-prometheus."</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 监控平台核心接口请求次数
     *
     * @return 返回监控平台核心接口请求次数
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"testIsCore"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testIsCore</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">counterCore</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">counterCore</span><span class="o">.</span><span class="na">count</span><span class="o">()</span> <span class="o">+</span> <span class="s">" index of springboot-prometheus."</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 测试实时在线人数，动态数据，每次请求数据可能都不一样
     *
     * @return
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/online"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">online</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">people</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">people</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
            <span class="n">appOnlineCount</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">people</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">"current online people: "</span> <span class="o">+</span> <span class="n">people</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/test"</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">counter</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span>
                <span class="s">"from"</span><span class="o">,</span> <span class="s">"127.0.0.1"</span><span class="o">,</span>
                <span class="s">"method"</span><span class="o">,</span> <span class="s">"test"</span>
        <span class="o">).</span><span class="na">increment</span><span class="o">();</span>
        <span class="k">return</span> <span class="s">"ok"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><p>从监控连接中，可以看到添加的监控信息，如下：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="err">#</span><span class="w"> </span><span class="err">HELP</span><span class="w"> </span><span class="err">test_total</span><span class="w">  
</span><span class="err">#</span><span class="w"> </span><span class="err">TYPE</span><span class="w"> </span><span class="err">test_total</span><span class="w"> </span><span class="err">counter</span><span class="w">
</span><span class="err">test_total</span><span class="p">{</span><span class="err">application=</span><span class="s2">"/springboot-optimization"</span><span class="p">,</span><span class="err">from=</span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="err">method=</span><span class="s2">"test"</span><span class="p">,}</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
</span></pre></table></code></div></div><h2 id="prometheus-监控体系"><span class="mr-2">Prometheus 监控体系</span><a href="#prometheus-监控体系" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>目前非常流行的 Prometheus ，通过使用【拉】的方式获取监控数据，这个暴露数据的过程可以交给功能更加齐全的 <code class="language-plaintext highlighter-rouge">telegraf</code> 组件，如下图所示：</p><p>如上图，通常使用 Grafana 进行监控数据的展示，并使用 AlertManager 组件进行提前预警。</p><p>下图就是一张典型的监控图，可以看到 Redis 的缓存命中率等情况，如下：</p><p><img data-src="https://image.happymaya.cn/assert/blog/springboot/springboot-prometheus-grafana.png" alt="" data-proofer-ignore></p><h2 id="java-生成火焰图"><span class="mr-2">Java 生成火焰图</span><a href="#java-生成火焰图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>火焰图</strong>是用来分析程序运行瓶颈的工具。</p><p>于是，我们可以使用火焰图分析 Java 应用，可以从 <a href="https://github.com/jvm-profiling-tools/async-profiler">github</a> 上下载 <code class="language-plaintext highlighter-rouge">async-profiler</code> 的压缩包进行相关操作。比如，将其加压到 <code class="language-plaintext highlighter-rouge">/root/</code>目录，然后以<code class="language-plaintext highlighter-rouge">javaagent</code> 的方式来启动 Java 应用，命令如下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>java <span class="nt">-agentpath</span>:/root/build/libasyncProfiler.so<span class="o">=</span>start,svg,file<span class="o">=</span>profile.svg <span class="nt">-jar</span> spring-petclinic-2.3.1.BUILD-SNAPSHOT.jar
</pre></table></code></div></div><p>运行一段时间后，停止进程，可以看到在当前目录下，生成了 profile.svg 文件，这个文件可以通过浏览器打开。</p><p>如下图所示，</p><p>其中：</p><ul><li>纵向，表示的是调用栈的深度；<li>横向，表示的是消耗的时间</ul><p>因此可知，格子的宽度越大，越说明它可能是一个瓶颈，然后一层层向下浏览，即可找到需要优化的目标。</p><h2 id="优化思路"><span class="mr-2">优化思路</span><a href="#优化思路" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>对于一个普通的 Web 服务来说，要访问到具体的数据，经历的主要环节如下图所示：</p><p><img data-src="http://assets.processon.com/chart_image/625875b70791296b57b3237d.png" alt="" data-proofer-ignore></p><p>Nginx 根据资源的特性，会承担一部分动静分离的功能。其中，动态功能部分，会进入到我们的 SpringBoot 服务。</p><p>SpringBoot 默认使用内嵌的 tomcat 作为 Web 容器，使用典型的 MVC 模式，最终访问到目标数据。</p><h3 id="http-优化"><span class="mr-2">HTTP 优化</span><a href="#http-优化" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>下面我们举例来看一下，哪些动作能够加快网页的获取。为了描述方便，我们仅讨论 HTTP1.1 协议的。</p><p><strong>1.使用 CDN 加速文件获取</strong></p><p>比较大的文件，尽量使用 CDN（Content Delivery Network）分发，甚至是一些常用的前端脚本、样式、图片等，都可以放到 CDN 上。CDN 通常能够加快这些文件的获取，网页加载也更加迅速。</p><p><strong>2.合理设置 Cache-Control 值</strong></p><p>浏览器会判断 HTTP 头 Cache-Control 的内容，用来决定是否使用浏览器缓存，这在管理一些静态文件的时候，非常有用，相同作用的头信息还有 Expires。Cache-Control 表示多久之后过期；Expires 则表示什么时候过期。</p><p>这个参数可以在 Nginx 的配置文件中进行设置。</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">location</span> ~* ^.+\.(<span class="n">ico</span>|<span class="n">gif</span>|<span class="n">jpg</span>|<span class="n">jpeg</span>|<span class="n">png</span>)$ { 
	<span class="c"># 缓存1年
</span>	<span class="n">add_header</span> <span class="n">Cache</span>-<span class="n">Control</span>: <span class="n">no</span>-<span class="n">cache</span>, <span class="n">max</span>-<span class="n">age</span>=<span class="m">31536000</span>;
}
</pre></table></code></div></div><p><strong>3.减少单页面请求域名的数量</strong></p><p>减少每个页面请求的域名数量，尽量保证在 4 个之内。这是因为，浏览器每次访问后端的资源，都需要先查询一次 DNS，然后找到 DNS 对应的 IP 地址，再进行真正的调用。</p><p>DNS 有多层缓存，比如浏览器会缓存一份、本地主机会缓存、ISP 服务商缓存等。从 DNS 到 IP 地址的转变，通常会花费 20-120ms 的时间。减少域名的数量，可加快资源的获取。</p><p><strong>4.开启 gzip</strong></p><p>开启 gzip，可以先把内容压缩后，浏览器再进行解压。由于减少了传输的大小，会减少带宽的使用，提高传输效率。</p><p>在 nginx 中可以很容易地开启，配置如下：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>gzip on;
gzip_min_length 1k;
gzip_buffers 4 16k;
gzip_comp_level 6;
gzip_http_version 1.1;
gzip_types text/plain application/javascript text/css;
</pre></table></code></div></div><p><strong>5.对资源进行压缩</strong></p><p>对 JavaScript 和 CSS，甚至是 HTML 进行压缩。道理类似，现在流行的前后端分离模式，一般都是对这些资源进行压缩的。</p><p><strong>6.使用 keepalive</strong></p><p>由于连接的创建和关闭，都需要耗费资源。用户访问我们的服务后，后续也会有更多的互动，所以保持长连接可以显著减少网络交互，提高性能。</p><p>nginx 默认开启了对客户端的 keep avlide 支持，你可以通过下面两个参数来调整它的行为。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>http {
    keepalive_timeout  120s 120s;
    keepalive_requests 10000;
}
</pre></table></code></div></div><p>nginx 与后端 upstream 的长连接，需要手工开启，参考配置如下：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>location ~ /{ 
	proxy_pass http://backend;
	proxy_http_version 1.1;
proxy_set_header Connection "";
}
</pre></table></code></div></div><h3 id="自定义-web-容器"><span class="mr-2">自定义 Web 容器</span><a href="#自定义-web-容器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>如果你的项目并发量比较高，想要修改最大线程数、最大连接数等配置信息，可以通过自定义Web 容器的方式，代码如下所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="kd">implements</span> <span class="nc">WebServerFactoryCustomizer</span><span class="o">&lt;</span><span class="nc">ConfigurableServletWebServerFactory</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">PetClinicApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">customize</span><span class="o">(</span><span class="nc">ConfigurableServletWebServerFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TomcatServletWebServerFactory</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TomcatServletWebServerFactory</span><span class="o">)</span> <span class="n">factory</span><span class="o">;</span>
 <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="n">f</span><span class="o">.</span><span class="na">setProtocol</span><span class="o">(</span><span class="s">"org.apache.coyote.http11.Http11Nio2Protocol"</span><span class="o">);</span>
        <span class="n">f</span><span class="o">.</span><span class="na">addConnectorCustomizers</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Http11NioProtocol</span> <span class="n">protocol</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Http11NioProtocol</span><span class="o">)</span> <span class="n">c</span><span class="o">.</span><span class="na">getProtocolHandler</span><span class="o">();</span>
            <span class="n">protocol</span><span class="o">.</span><span class="na">setMaxConnections</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
            <span class="n">protocol</span><span class="o">.</span><span class="na">setMaxThreads</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
            <span class="n">protocol</span><span class="o">.</span><span class="na">setSelectorTimeout</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
            <span class="n">protocol</span><span class="o">.</span><span class="na">setSessionTimeout</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
            <span class="n">protocol</span><span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>注意上面的代码，设置了它的协议为 org.apache.coyote.http11.Http11Nio2Protocol，意思就是开启了 Nio2。这个参数在 Tomcat 8.0之后才有，开启之后会增加一部分性能。 对比如下（测试项目代码见 <a href="https://gitee.com/xjjdog/tuning-lagou-res/tree/master/tuning-020/spring-petclinic-main">spring-petclinic-main</a>）：</p><p>默认：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="o">[</span>root@localhost wrk2-master]# ./wrk <span class="nt">-t2</span> <span class="nt">-c100</span> <span class="nt">-d30s</span> <span class="nt">-R2000</span> http://172.16.1.57:8080/owners?lastName<span class="o">=</span>
Running 30s <span class="nb">test</span> @ http://172.16.1.57:8080/owners?lastName<span class="o">=</span>
  2 threads and 100 connections
  Thread calibration: mean lat.: 4588.131ms, rate sampling interval: 16277ms
  Thread calibration: mean lat.: 4647.927ms, rate sampling interval: 16285ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    16.49s     4.98s   27.34s    63.90%
    Req/Sec   106.50      1.50   108.00    100.00%
  6471 requests <span class="k">in </span>30.03s, 39.31MB <span class="nb">read
  </span>Socket errors: connect 0, <span class="nb">read </span>0, write 0, <span class="nb">timeout </span>60
Requests/sec:    215.51
Transfer/sec:      1.31MB
</pre></table></code></div></div><p>Nio2：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>[root@localhost wrk2-master]# ./wrk -t2 -c100 -d30s -R2000 http://172.16.1.57:8080/owners?lastName=
Running 30s test @ http://172.16.1.57:8080/owners?lastName=
  2 threads and 100 connections
  Thread calibration: mean lat.: 4358.805ms, rate sampling interval: 15835ms
  Thread calibration: mean lat.: 4622.087ms, rate sampling interval: 16293ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    17.47s     4.98s   26.90s    57.69%
    Req/Sec   125.50      2.50   128.00    100.00%
  7469 requests in 30.04s, 45.38MB read
  Socket errors: connect 0, read 0, write 0, timeout 4
Requests/sec:    248.64
Transfer/sec:      1.51MB
</pre></table></code></div></div><p>你甚至可以将 tomcat 替换成 undertow。undertow 也是一个 Web 容器，更加轻量级一些，占用的内存更少，启动的守护进程也更少，更改方式如下：</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;exclusions&gt;</span>
        <span class="nt">&lt;exclusion&gt;</span>
          <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
          <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/exclusion&gt;</span>
      <span class="nt">&lt;/exclusions&gt;</span>
 <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-undertow<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><p>其实，对于 tomcat 优化最为有效的，还是 JVM 参数的配置 比如，使用下面的参数启动，QPS 由 248 上升到 308。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>-XX:+UseG1GC -Xmx2048m -Xms2048m -XX:+AlwaysPreTouch
</pre></table></code></div></div><h3 id="skywalking"><span class="mr-2">Skywalking</span><a href="#skywalking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="table-wrapper"><table><tbody><tr><td>对于一个 web 服务来说，最缓慢的地方就在于数据库操作。所以，使用“07<td>案例分析：无处不在的缓存，高并发系统的法宝”和“08<td>案例分析：Redis 如何助力秒杀业务”提供的本地缓存和分布式缓存优化，能够获得最大的性能提升。</table></div><p>对于如何定位到复杂分布式环境中的问题，我这里想要分享另外一个工具：Skywalking。</p><p>Skywalking 是使用探针技术（JavaAgent）来实现的。通过在 Java 的启动参数中，加入 javaagent 的 Jar 包，即可将性能数据和调用链数据封装，并发送到 Skywalking 的服务器。</p><p>下载相应的安装包（如果使用 ES 存储，需要下载专用的安装包），配置好存储之后，即可一键启动。</p><p>将 agent 的压缩包，解压到相应的目录。</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">tar </span>xvf skywalking-agent.tar.gz  -C /opt/
</pre></table></code></div></div><p>在业务启动参数中加入 agent 的包。比如，原来的启动命令是：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>java  -jar /opt/test-service/spring-boot-demo.jar  --spring.profiles.active<span class="o">=</span>dev
</pre></table></code></div></div><p>改造后的启动命令是：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>java <span class="nt">-javaagent</span>:/opt/skywalking-agent/skywalking-agent.jar <span class="nt">-Dskywalking</span>.agent.service_name<span class="o">=</span>the-demo-name  -jar /opt/test-service/spring-boot-demo.ja  --spring.profiles.active<span class="o">=</span>dev
</pre></table></code></div></div><p>访问一些服务的链接，打开 Skywalking 的 UI，即可看到下图的界面。这些指标可以类比衡量指标，然后就可以从图中找到响应比较慢 QPS 又比较高的接口，进行专项优化。</p><p><img data-src="D:\coding\image\assert\blog\springboot\springboot-skywalking.png" alt="" data-proofer-ignore></p><h3 id="各个层次的优化方向"><span class="mr-2">各个层次的优化方向</span><a href="#各个层次的优化方向" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><h4 id="1controller-层"><span class="mr-2">1.Controller 层</span><a href="#1controller-层" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>controller 层用于接收前端的查询参数，然后构造查询结果。现在很多项目都采用前后端分离的架构，所以 controller 层的方法，一般会使用 @ResponseBody 注解，把查询的结果，解析成 JSON 数据返回（兼顾效率和可读性）。</p><p>由于 controller 只是充当了一个类似功能组合和路由的角色，所以这部分对性能的影响就主要体现在数据集的大小上。如果结果集合非常大，JSON 解析组件就要花费较多的时间进行解析，</p><p>大结果集不仅会影响解析时间，还会造成内存浪费。</p><p>假如结果集在解析成 JSON 之前，占用的内存是 10MB，那么在解析过程中，有可能会使用 20M 或者更多的内存去做这个工作。</p><p>我见过很多案例，由于返回对象的嵌套层次太深、引用了不该引用的对象（比如非常大的 byte[] 对象），造成了内存使用的飙升。</p><p>所以，<strong>对于一般的服务，保持结果集的精简，是非常有必要的</strong>，这也是 DTO（data transfer object）存在的必要。如果你的项目，返回的结果结构比较复杂，对结果集进行一次转换是非常有必要的。</p><h4 id="2service-层"><span class="mr-2">2.Service 层</span><a href="#2service-层" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>service 层用于处理具体的业务，大部分功能需求都是在这里完成的。service 层一般是使用单例模式，很少会保存状态，而且可以被 controller 复用。</p><p>service 层的代码组织，对代码的可读性、性能影响都比较大。我们常说的设计模式，大多数都是针对 service 层来说的。</p><p>service 层会频繁使用更底层的资源，通过组合的方式获取我们所需要的数据，大多数可以通过我们前面课时提供的优化思路进行优化。</p><p>这里要着重提到的一点，就是分布式事务。</p><p><img data-src="http://assets.processon.com/chart_image/625870d31e085335d545a0b9.png" alt="" data-proofer-ignore></p><p>如上图，四个操作分散在三个不同的资源中。要想达到一致性，需要三个不同的资源 MySQL、MQ、ElasticSearch 进行统一协调。它们底层的协议，以及实现方式，都是不一样的，那就无法通过 Spring 提供的 Transaction 注解来解决，需要借助外部的组件来完成。</p><p>很多人都体验过，加入了一些保证一致性的代码，一压测，性能掉的惊掉下巴。分布式事务是性能杀手，因为它要使用额外的步骤去保证一致性，常用的方法有：两阶段提交方案、TCC、本地消息表、MQ 事务消息、分布式事务中间件等。</p><p><img data-src="http://assets.processon.com/chart_image/625874eef346fb5a26965e8e.png" alt="" data-proofer-ignore></p><p>如上图，分布式事务要在改造成本、性能、时效等方面进行综合考虑。有一个介于分布式事务和非事务之间的名词，叫作<strong>柔性事务</strong>。柔性事务的理念是将业务逻辑和互斥操作，从资源层上移至业务层面。</p><p><strong>关于传统事务和柔性事务，我们来简单比较一下。</strong></p><p><strong>ACID</strong></p><p>关系数据库, 最大的特点就是事务处理, 即满足 ACID。</p><ul><li>原子性（Atomicity）：事务中的操作要么都做，要么都不做。<li>一致性（Consistency）：系统必须始终处在强一致状态下。<li>隔离性（Isolation）：一个事务的执行不能被其他事务所干扰。<li>持久性（Durability）：一个已提交的事务对数据库中数据的改变是永久性的。</ul><p><strong>BASE</strong></p><p>BASE 方法通过牺牲一致性和孤立性来提高可用性和系统性能。</p><p>BASE 为 Basically Available、Soft-state、Eventually consistent 三者的缩写，其中 BASE 分别代表：</p><ul><li>基本可用（Basically Available）：系统能够基本运行、一直提供服务。<li>软状态（Soft-state）：系统不要求一直保持强一致状态。<li>最终一致性（Eventual consistency）：系统需要在某一时刻后达到一致性要求。</ul><p>互联网业务，推荐使用补偿事务，完成最终一致性。比如，通过一系列的定时任务，完成对数据的修复。</p><h4 id="3dao-层"><span class="mr-2">3.Dao 层</span><a href="#3dao-层" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>经过合理的数据缓存，我们都会尽量避免请求穿透到 Dao 层。除非你对 ORM 本身提供的缓存特性特别的熟悉；否则，都推荐你使用更加通用的方式去缓存数据。</p><p>Dao 层，主要在于对 ORM 框架的使用上。比如，在 JPA 中，如果加了一对多或者多对多的映射关系，而又没有开启懒加载，级联查询的时候就容易造成深层次的检索，造成了内存开销大、执行缓慢的后果。</p><p>在一些数据量比较大的业务中，多采用分库分表的方式。在这些分库分表组件中，很多简单的查询语句，都会被重新解析后分散到各个节点进行运算，最后进行结果合并。</p><p>举个例子，select count(*) from a 这句简单的 count 语句，就可能将请求路由到十几张表中去运算，最后在协调节点进行统计，执行效率是可想而知的。目前，分库分表中间件，比较有代表性的是驱动层的 ShardingJdbc 和代理层的 MyCat，它们都有这样的问题。这些组件提供给使用者的视图是一致的，但我们在编码的时候，一定要注意这些区别。</p><h3 id="总结"><span class="mr-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>SpringBoot 常见的优化思路：</p><ul><li>HTTP<li>自定义 Web 容器<li>Skwalking<li>各个层次的优化<ul><li>Controller<li>Service<li>Dao</ul></ul><p>三个新的性能分析工具。</p><ul><li>一个是监控系统 Prometheus，可以看到一些具体的指标大小；<li>一个是火焰图，可以看到具体的代码热点；<li>一个是 Skywalking，可以分析分布式环境中的调用链。</ul><p>SpringBoot 自身的 Web 容器是 Tomcat，就可以通过对 Tomcat 的调优来获取性能提升。当然，对于服务上层的负载均衡 Nginx，也总结提供了一系列的优化思路。</p><p>最后，在经典的 MVC 架构下，Controller、Service、Dao 的一些优化方向，并着重看了 Service 层的分布式事务问题。 SpringBoot 作为一个广泛应用的服务框架，在性能优化方面已经做了很多工作，选用了很多高速组件。比如：</p><ul><li>数据库连接池默认使用 <strong>hikaricp</strong>；<li>Redis 缓存框架默认使用 <strong>lettuce</strong>；<li>本地缓存提供 <strong>caffeine</strong> 等。 对于一个普通的数据库交互的 Web 服务来说，<strong>缓存</strong>是最主要的优化手段。</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/performance-optimization/'>Performance Optimization</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-tag no-text-decoration" >性能优化</a> <a href="/tags/performance-optimization/" class="post-tag no-text-decoration" >Performance Optimization</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=SpringBoot 服务性能优化（16） - ThinkerWalker&amp;url=/posts/springboot/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=SpringBoot 服务性能优化（16） - ThinkerWalker&amp;u=/posts/springboot/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/springboot/&amp;text=SpringBoot 服务性能优化（16） - ThinkerWalker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/use-spring-security-to-build-a-user-authentication-system/">Spring Security 的配置体系</a><li><a href="/posts/spring-data-jpa-test/">利用单元测试和集成测试</a><li><a href="/posts/query-annotation/">Spring Data JPA - @Query</a><li><a href="/posts/defining-query-methods/">Spring Data JPA - Defining Query Methods 的命名语法与参数</a><li><a href="/posts/cache-redis-02/">Redis 的数据类型</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Performance-Optimization-Metrics-and-Points-to-Watch/"><div class="card-body"> <em class="timeago small" data-ts="1551540780" > 2019-03-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>衡量的指标和注意的点(01)</h3><div class="text-muted small"><p> 所谓性能，就是使用有限的资源在有限的时间内完成工作。 在做性能优化时，能够帮助决策的衡量指标有以下五点，分别是： 性能指标 吞吐量，QPS、TPS、HPS 响应速度， Time 响应时间 平均响应时间 AVG 百分位数 Top Percentile 并发量 秒开率 正确...</p></div></div></a></div><div class="card"> <a href="/posts/Entry-point-for-performance-optimization/"><div class="card-body"> <em class="timeago small" data-ts="1552059180" > 2019-03-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>性能优化类别(02)</h3><div class="text-muted small"><p> 性能优化根据优化的类别，分为业务优化和技术优化。业务优化产生的效果也是非常大的，但它属于产品和管理的范畴。同作为程序员，在平常工作中，我们面对的优化方式，主要是通过一系列的技术手段，来完成对既定的优化目标。这一系列的技术手段，大体归纳为如图以下 7 类： 1 复用优化 在写代码的时候，经常会发现有很多重复的代码可以提取出来，做成公共方法。这样，在下次用时，就不用在费劲写一遍。这种思想就...</p></div></div></a></div><div class="card"> <a href="/posts/resource-bottleneck/"><div class="card-body"> <em class="timeago small" data-ts="1552137851" > 2019-03-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>容易成为瓶颈的资源(03)</h3><div class="text-muted small"><p> CPU、内存以及 I/O 三个资源是最容易成为瓶颈的。 CPU 通过 top 命令，观测 CPU 性能； 通过负载，评估 CPU 任务执行的排队情况； 通过 vmstat，看 CPU 的繁忙程度。 top 命令 —— CPU 性能 当进入 top 命令后，按 1 键即可看到每核 CPU 的运行指标和详细性能。 CPU 的使用有多个维度的指标，分别如下： us： ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Java-code-optimization-rules/" class="btn btn-outline-primary" prompt="上一篇"><p>Java 代码优化法则（16）</p></a> <a href="/posts/performance-optimization-summary/" class="btn btn-outline-primary" prompt="下一篇"><p>性能优化的过程方法与总结（17）</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/happymaya">superhsc</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/jvm/">JVM</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/architecture-design/">Architecture Design</a> <a class="post-tag" href="/tags/backend-system/">Backend System</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/spring-security/">Spring Security</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/cache/">Cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
